<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HÒA VANG FC - MANAGER FOOTBALL APP MOBILE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;900&display=swap');
        /* CSS Ẩn hiện cho chế độ Khách */
        body.guest-mode .guest-hidden { display: none !important; }
        /* --- CSS ẨN CÁC NÚT CHO KHÁCH (GUEST MODE) --- */
        body.guest-mode .admin-only { display: none !important; }
        body.guest-mode input, 
        body.guest-mode select, 
        body.guest-mode textarea { pointer-events: none; background-color: #f1f5f9; color: #64748b; }
        /* Riêng ô tìm kiếm vẫn cho nhập */
        body.guest-mode input#search-team { pointer-events: auto; background-color: white; color: black; }
        /* Làm mờ và khóa các ô input khi ở chế độ khách (nếu cần thiết dùng global) */
        /* Nhưng code JS ở trên đã xử lý chi tiết rồi nên phần này là tùy chọn */
        /* --- MOBILE APP BASE STYLES --- */
        body { 
            font-family: 'Be Vietnam Pro', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background-color: #f8fafc;
            padding-bottom: calc(80px + env(safe-area-inset-bottom)); /* Khoảng trống cho Bottom Nav */
        }

        /* Ẩn thanh cuộn nhưng vẫn cuộn được */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Login Screen Full Mobile */
        #welcome-screen { position: fixed; inset: 0; z-index: 9999; background: #1b2f5e; display: flex; flex-direction: column; justify-content: center; padding: 20px; }
        .login-input { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; }
        .login-input:focus { background: rgba(255,255,255,0.2); border-color: #3b82f6; }

        /* Bottom Navigation */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-around; padding: 10px 0 calc(10px + env(safe-area-inset-bottom)) 0; z-index: 50; box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8; font-size: 10px; font-weight: 600; width: 20%; transition: all 0.2s; }
        .nav-item i { font-size: 20px; margin-bottom: 4px; }
        .nav-item.active { color: #2563eb; }
        .nav-item.active i { transform: translateY(-2px); }

        /* Mobile Card Styles */
        .app-card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; padding: 16px; margin-bottom: 12px; }
        
        /* Inputs & Forms */
        .app-input { width: 100%; background: #f8fafc; border: 1px solid #e2e8f0; padding: 12px; border-radius: 12px; font-weight: 600; color: #334155; font-size: 14px; outline: none; }
        .app-input:focus { border-color: #3b82f6; background: white; box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
        .app-btn { width: 100%; padding: 14px; border-radius: 12px; font-weight: 800; text-transform: uppercase; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; shadow-sm; }
        
        /* Match Card Admin Layout */
        .match-card-edit { background: white; border-radius: 16px; margin-bottom: 16px; border: 1px solid #e2e8f0; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .match-edit-header { background: #f1f5f9; padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; }
        .match-edit-body { padding: 16px; }
        .score-input-box { width: 48px; height: 48px; border-radius: 10px; border: 1px solid #cbd5e1; text-align: center; font-size: 20px; font-weight: 900; background: #f8fafc; display: flex; align-items: center; justify-content: center; }
        
        /* Live & Status */
        .animate-blink { animation: blink 1.0s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .live-badge { background: #fef2f2; color: #ef4444; border: 1px solid #fee2e2; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 900; display: inline-flex; align-items: center; gap: 4px; }
        
        /* Modals (Full Screen Mobile) */
        .mobile-modal { position: fixed; inset: 0; background: #f8fafc; z-index: 100; overflow-y: auto; padding-bottom: 80px; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .mobile-modal.open { transform: translateY(0); }
        .mobile-modal-header { position: sticky; top: 0; background: white; padding: 16px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; z-index: 10; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        /* Print Hidden */
        /* --- PRINT STYLES (CẬP NHẬT) --- */
        @media print {
            /* Ẩn toàn bộ giao diện App */
            body > *:not(#print-area) { display: none !important; }
            #app-container, #welcome-screen, .bottom-nav, .mobile-modal { display: none !important; }
            
            /* Chỉ hiện vùng in */
            #print-area { 
                display: block !important; 
                position: absolute; 
                top: 0; left: 0; width: 100%; 
                background: white;
                font-family: 'Be Vietnam Pro', sans-serif;
                color: black;
            }

            /* Cấu hình trang in */
            @page { margin: 10mm; size: A4 portrait; }
            
            /* Đảm bảo màu sắc background được in ra */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            
            /* Ngắt trang thông minh */
            table { page-break-inside: auto; }
            tr { page-break-inside: avoid; page-break-after: auto; }
            h2 { page-break-after: avoid; page-break-before: auto; }
            .page-break { page-break-before: always; }
        }
        #print-area { display: none; }
    </style>
</head>
<body>

    <div id="welcome-screen">
        <div class="flex-1 flex flex-col justify-center items-center">
            <div class="w-56 h-56 bg-white rounded-3xl flex items-center justify-center shadow-2xl mb-6 p-2 ring-4 ring-blue-500/30">
                <img src="logohvfc.png" onerror="this.src='https://via.placeholder.com/150?text=LOGO'" class="w-full h-full object-contain">
            </div>
            <h1 class="text-3xl font-black text-white uppercase tracking-wider mb-1">HÒA VANG FC</h1>
            <p class="text-blue-200 text-xs font-bold uppercase tracking-[0.2em] mb-10">Football Manager App Mobile</p>
            
            <div class="w-full max-w-xs space-y-4">
                <input type="text" id="login-user" value="Lee Nai" class="login-input w-full p-4 rounded-xl font-bold outline-none placeholder-slate-400" placeholder="Tài khoản">
                <input type="password" id="login-pass" class="login-input w-full p-4 rounded-xl font-bold outline-none placeholder-slate-400" placeholder="Mật khẩu">
                
                <div class="flex items-center gap-2 px-1">
                    <input type="checkbox" id="remember-me" class="w-5 h-5 rounded accent-blue-600">
                    <label for="remember-me" class="text-slate-300 text-xs font-bold uppercase">Ghi nhớ đăng nhập</label>
                </div>

                <button onclick="handleLogin('admin')" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-xl shadow-lg text-sm uppercase tracking-wide">Đăng Nhập Quản Trị</button>
                <button onclick="handleLogin('guest')" class="w-full bg-transparent border border-slate-600 text-slate-400 font-bold py-3 rounded-xl text-xs uppercase">Chế độ Khách (Xem)</button>
            </div>
        </div>
        
        <div class="text-center text-slate-500 text-[12px] font-medium pb-4">Code and Design by <b>Lee Nai</b> (K99 Hòa Vang)</div>
    </div>

    <div id="app-container" class="hidden">
        
        <header class="bg-white sticky top-0 z-40 px-4 py-3 flex justify-between items-center shadow-sm border-b border-slate-100">
    <div class="flex items-center gap-3">
        <img src="logohvfc.png" onerror="this.src='https://via.placeholder.com/150?text=LOGO'" class="w-8 h-8 object-contain">
        <div>
            <h2 class="text-sm font-black text-slate-800 uppercase leading-none">HÒA VANG FC - QUẢN LÝ GIẢI ĐẤU </h2>
            <p class="text-[10px] text-blue-600 font-bold" id="user-role-lbl">Khách</p>
        </div>
    </div>
    
    <div class="flex items-center gap-2">
        <button onclick="goHome()" class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center shadow-sm active:scale-90 transition">
            <i class="fas fa-home text-xs"></i>
        </button>
        
        <button onclick="window.location.reload()" class="w-8 h-8 rounded-full bg-green-50 text-green-600 flex items-center justify-center shadow-sm active:scale-90 transition hover:bg-green-100 hover:rotate-180 duration-500">
            <i class="fas fa-sync-alt text-xs"></i>
        </button>

        <button onclick="handleLogout()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center shadow-sm active:scale-90 transition hover:bg-red-100 hover:text-red-500">
            <i class="fas fa-power-off text-xs"></i>
        </button>
    </div>
</header>

        <main class="p-3 min-h-screen"><div id="content-tour-detail" class="hidden pb-20">
        
        <div class="mb-4 bg-white p-3 rounded-xl border border-slate-100 shadow-sm sticky top-0 z-30">
            <div class="flex justify-between items-center mb-2">
                <h2 class="font-black text-xs text-slate-500 uppercase tracking-wider">Chọn Giải Đấu</h2>
                <button onclick="showTourCreate()" class="bg-blue-600 text-white text-[10px] font-bold px-2 py-1 rounded shadow hover:bg-blue-700 transition admin-only">
                    <i class="fas fa-plus"></i> Tạo Mới
                </button>
            </div>
            
            <div id="top-tour-list" class="flex gap-3 overflow-x-auto no-scrollbar pb-1 snap-x">
                </div>
        </div>

        <div id="no-tour-selected-msg" class="flex flex-col items-center justify-center pt-10 text-slate-400">
            <i class="fas fa-arrow-up text-4xl mb-2 animate-bounce"></i>
            <p class="text-xs font-bold">Vui lòng chọn một giải đấu ở trên</p>
        </div>

        <div id="tour-active" class="hidden animate-fade-in">
            <div class="app-card bg-blue-900 text-white border-none mb-4 relative overflow-hidden">
                <div class="absolute right-0 top-0 opacity-10 text-9xl"><i class="fas fa-trophy"></i></div>
                
                <div class="flex justify-between items-start mb-3 relative z-10">
                    <div class="flex items-start gap-3 flex-1 min-w-0">
                        <img id="header-tour-logo" src="hvfclogo.png" class="w-12 h-12 object-contain bg-white rounded-lg p-0.5 border border-blue-300 shadow-sm shrink-0">
                        <div>
                            <h2 id="active-tour-title" class="text-lg font-black uppercase leading-tight pt-1 break-words">Tên Giải</h2>
                            <div class="text-[10px] text-blue-200 font-bold mt-1" id="active-tour-sub">Đang quản lý</div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="openEditTourModal()" id="btn-global-edit" class="hidden w-8 h-8 rounded-full text-blue-200 hover:text-white flex items-center justify-center bg-blue-800/50">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button onclick="deleteCurrentTour()" class="hidden w-8 h-8 rounded-full text-red-300 hover:text-white flex items-center justify-center bg-red-900/50 admin-only" title="Xóa giải này">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>

                <div id="active-tour-info" class="text-xs text-blue-200 font-bold pl-0 mb-4 relative z-10"></div>

                <div class="flex gap-2 relative z-10">
                    <button onclick="printTournament()" class="text-[10px] font-bold bg-white/10 px-3 py-1.5 rounded-lg backdrop-blur-sm hover:bg-white/20 border border-white/20">
                        <i class="fas fa-print mr-1"></i> Xuất PDF
                    </button>
                </div>
            </div>

            <div id="group-to-knockout-area" class="hidden app-card bg-indigo-50 border-indigo-100 flex flex-col gap-2 mb-4">
                <div><h4 class="font-bold text-indigo-800 text-sm">Vòng Bảng kết thúc?</h4><p class="text-xs text-indigo-600">Chuyển sang giai đoạn Knock-out.</p></div>
                <button onclick="openAdvanceModal()" class="app-btn bg-indigo-600 text-white py-2 text-xs">Vào Vòng Trong</button>
            </div>

            <div id="tour-standings-preview" class="hidden mb-6">
                <div id="tour-standings-content"></div>
            </div>

            <div id="knockout-actions" class="hidden mb-4">
                <button onclick="prepareKnockoutRound()" class="app-btn bg-red-600 text-white shadow-lg"><i class="fas fa-random"></i> Bốc Thăm Vòng Sau</button>
            </div>

            <div id="bracket-container">
                <h4 class="font-bold text-slate-600 text-sm uppercase mb-2 pl-1">Sơ Đồ Thi Đấu</h4>
                <div id="tour-brackets" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <div id="tour-create" class="hidden pb-20">
        <div class="app-card">
            <h3 class="font-bold text-lg mb-4 text-blue-800 uppercase border-b pb-2">Thiết lập giải đấu mới</h3>
             <div class="flex justify-center mb-6">
                <div class="w-28 h-28 rounded-full border-4 border-slate-100 p-1 relative group overflow-hidden bg-white shadow-md">
                    <img id="new-tour-logo-preview" src="hvfclogo.png" class="w-full h-full object-contain rounded-full">
                    <input type="file" id="new-tour-logo-upload" accept="image/*" class="absolute inset-0 opacity-0 z-10 cursor-pointer" onchange="previewTourLogo(this, 'new-tour-logo-preview')">
                    <div class="absolute inset-0 bg-black/50 flex items-center justify-center text-white text-[10px] font-bold opacity-0 group-hover:opacity-100 transition">CHỌN LOGO</div>
                </div>
            </div>
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-slate-500 uppercase">Tên Giải Đấu (*)</label><input type="text" id="new-tour-name" class="app-input uppercase font-black text-blue-900" oninput="this.value = this.value.toUpperCase()"></div>
                <div class="grid grid-cols-2 gap-3"><div><label class="text-xs font-bold text-slate-500 uppercase">Trưởng Ban TC</label><input type="text" id="new-tour-organizer" class="app-input"></div><div><label class="text-xs font-bold text-slate-500 uppercase">SĐT Liên Hệ</label><input type="tel" id="new-tour-phone" class="app-input"></div></div>
                <div><label class="text-xs font-bold text-slate-500 uppercase">Địa điểm / Sân bóng</label><input type="text" id="new-tour-location" class="app-input"></div>
                <hr class="border-slate-100 my-2">
                <h4 class="font-bold text-xs text-slate-400 uppercase"><i class="fas fa-cogs"></i> Cấu hình thi đấu</h4>
                <div class="grid grid-cols-2 gap-3"><div><label class="text-xs font-bold text-slate-500 uppercase">Hình thức</label><select id="new-tour-format" class="app-input font-bold" onchange="toggleGroupSettings()"><option value="knockout">Loại trực tiếp</option><option value="group">Đấu Bảng</option></select></div><div><label class="text-xs font-bold text-slate-500 uppercase">Số Bảng đấu</label><select id="new-group-count" class="app-input font-bold" onchange="renderBucketAssigner()"><option value="0" selected>-- Chọn --</option><option value="1">1 Bảng (League)</option><option value="2">2 Bảng</option><option value="3">3 Bảng</option><option value="4">4 Bảng</option></select></div></div>
                <div id="turns-container"><label class="text-xs font-bold text-slate-500 uppercase">Số Lượt đấu</label><select id="new-tour-turns" class="app-input text-blue-700 font-bold"><option value="1">1 Lượt</option><option value="2">2 Lượt (Đi-Về)</option></select></div>
                <div class="grid grid-cols-2 gap-3 bg-slate-50 p-2 rounded-lg border border-slate-200"><div><label class="text-[10px] font-bold text-slate-400 uppercase">Ngày Bắt đầu</label><input type="date" id="new-tour-start" class="app-input bg-white text-xs"></div><div><label class="text-[10px] font-bold text-slate-400 uppercase">Ngày Kết thúc</label><input type="date" id="new-tour-end" class="app-input bg-white text-xs"></div></div>
                <div id="group-settings" class="mt-2"><hr class="border-slate-100 my-4"><div><label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Quy đổi điểm Fairplay</label><select id="new-tour-red-weight" class="app-input text-sm font-bold text-red-700"><option value="3">1 Thẻ Đỏ = 3 điểm</option><option value="2">1 Thẻ Đỏ = 2 điểm</option></select></div><div class="mb-4"><label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Thứ tự ưu tiên Xếp hạng</label><div id="ranking-criteria-list" class="space-y-2"></div></div><hr class="border-slate-100 my-4"><div id="bucket-assigner" class="hidden space-y-4 mb-4"><div id="bucket-targets" class="space-y-2"></div></div></div>
            </div>
            <div class="flex gap-3 mt-6 pt-4 border-t">
                <button onclick="switchView('tour-list')" class="app-btn bg-slate-200 text-slate-600">Hủy bỏ</button>
                <button onclick="startTournament()" class="app-btn bg-blue-600 text-white shadow-lg">Tạo Giải Ngay</button>
            </div>
        </div>
    </div>

    <div id="content-teams" class="hidden pb-20">
    <div class="flex justify-between items-center mb-4">
        <h2 class="font-black text-xl text-slate-800 uppercase">Danh Sách Đội</h2>
        <button onclick="createNewTeams()" class="bg-blue-600 text-white text-xs font-bold px-3 py-2 rounded-lg shadow-lg admin-only">
            <i class="fas fa-plus mr-1"></i> Thêm Đội
        </button>
    </div>
    <div class="grid grid-cols-2 gap-3 mb-4 admin-only">
        <button onclick="downloadTeamTemplate()" class="bg-green-50 text-green-700 border border-green-200 py-2.5 rounded-xl text-[10px] font-black uppercase shadow-sm flex items-center justify-center gap-2 hover:bg-green-100 transition">
            <i class="fas fa-file-download text-lg"></i> Tải File Mẫu
        </button>

        <div class="relative group">
            <div class="absolute inset-0 bg-blue-600 rounded-xl shadow-lg translate-y-0.5 group-hover:translate-y-1 transition"></div>
            <button class="relative w-full bg-blue-500 text-white py-2.5 rounded-xl text-[10px] font-black uppercase shadow-sm flex items-center justify-center gap-2 group-hover:-translate-y-0.5 transition border border-white/20">
                <i class="fas fa-file-import text-lg"></i> Nhập Excel
            </button>
            <input type="file" accept=".xlsx, .xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20" onchange="importTeamsFromExcel(this)">
        </div>
    </div>
    <div class="mb-4 relative">
        <i class="fas fa-search absolute left-3 top-3 text-slate-400"></i>
        <input type="text" id="search-team" onkeyup="renderTeamList()" placeholder="Tìm tên đội..." class="app-input pl-9 bg-white shadow-sm">
    </div>

    <div class="flex justify-between items-center mb-2 h-8">
        <div class="flex items-center gap-2 admin-only">
             <input type="checkbox" id="select-all-teams" class="w-4 h-4 accent-blue-600 rounded cursor-pointer" onchange="toggleSelectAllTeams(this)">
             <label for="select-all-teams" class="text-xs font-bold text-slate-400 cursor-pointer hover:text-blue-600">Chọn tất cả</label>
        </div>

        <button onclick="deleteSelectedTeams()" id="btn-delete-multi" class="hidden bg-red-100 hover:bg-red-200 text-red-600 px-3 py-1.5 rounded-md shadow-sm flex items-center gap-1 transition-all admin-only">
            <i class="fas fa-trash-alt text-xs"></i> <span class="text-xs font-bold">Xóa Đội</span>
        </button>
    </div>

    <div id="team-list-box" class="space-y-3"></div>
</div>
    <div id="content-results" class="hidden pb-20">
        <div class="flex justify-between items-center mb-4">
            <h2 class="font-black text-xl text-slate-800 uppercase">Kết Quả & Lịch</h2>
        </div>
        
        <div class="flex bg-slate-100 p-1 rounded-xl mb-4 admin-only">
            <button onclick="switchResultMode('edit')" id="btn-res-edit" class="flex-1 py-2 rounded-lg text-xs font-bold bg-white shadow-sm text-blue-600 transition">Nhập Kết Quả</button>
            <button onclick="switchResultMode('view')" id="btn-res-view" class="flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 transition">Xem Lịch</button>
        </div>

        <div id="results-tbody" class="space-y-3"></div> <div id="schedule-list" class="space-y-3 hidden"></div> </div>

    <div id="content-stats" class="hidden pb-20">
        <div class="flex justify-between items-center mb-4">
            <h2 class="font-black text-xl text-slate-800 uppercase">Thống Kê</h2>
            <div class="text-[10px] font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded">Live Update</div>
        </div>
        <div id="stats-content"></div>
    </div>

    <div id="content-version" class="hidden pb-20 px-1">
        <div class="flex justify-between items-center mb-4">
            <h2 class="font-black text-xl text-slate-800 uppercase">Thông tin Phiên bản</h2>
        </div>

        <div class="bg-gradient-to-r from-blue-900 to-blue-700 rounded-2xl p-6 text-white text-center shadow-lg mb-6 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
            <div class="w-20 h-20 bg-white rounded-2xl mx-auto flex items-center justify-center shadow-md mb-3">
                <img src="logohvfc.png" onerror="this.src='https://via.placeholder.com/150?text=LOGO'" class="w-16 h-16 object-contain">
            </div>
            <h1 class="text-2xl font-black uppercase tracking-wider mb-1">HÒA VANG FC</h1>
            <p class="text-[10px] text-blue-200 font-bold uppercase tracking-[0.3em] mb-4">Football Manager App</p>
            <div class="inline-block bg-white/20 px-3 py-1 rounded-full text-xs font-bold backdrop-blur-sm border border-white/30">
                Phiên bản V4.2025 (Final)
            </div>
        </div>

        <div class="space-y-4">
            
            <div class="app-card border-l-4 border-l-blue-600">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-bold text-blue-800 text-sm uppercase">Cập nhật V4.2025</h3>
                    <span class="text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded font-bold">Mới nhất</span>
                </div>
                <ul class="text-xs text-slate-600 space-y-2 list-disc pl-4">
                    <li><b>Dynamic Dashboard:</b> Widget màn hình chính thông minh hơn: Tự động hiển thị danh sách <b>toàn bộ trận đấu của Vòng hiện tại</b> thay vì chỉ 1 trận lẻ.</li>
                    <li><b>Thẻ Version:</b> Di chuyển lịch sử cập nhật vào trong ứng dụng.</li>
                    <li><b>Import Excel (XLSX Integration):</b> Tích hợp engine đọc file Excel. Cho phép nhập danh sách cầu thủ hàng loạt từ file mẫu có sẵn, tiết kiệm 90% thời gian nhập liệu.</li>
                    <li><b>Smart State Recovery (Fix F5)</b> Cơ chế tự động ghi nhớ Giải đấu và Tab đang xem. Khi tải lại trang (F5), ứng dụng tự động khôi phục về đúng vị trí cũ mà không bị văng ra ngoài.</li>
                    <li><b>Transactional Match Locking:</b> Logic chốt trận đấu (Full-time) an toàn với màn hình chờ. Ngăn chặn việc bấm nút nhiều lần hoặc lỗi mạng dẫn đến sai lệch dữ liệu.</li>
                </ul>
            </div>

            <div class="app-card border-l-4 border-l-green-500 opacity-80">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-bold text-slate-700 text-sm uppercase">Cập nhật V3.2025</h3>
                    <span class="text-[10px] text-slate-400 font-bold">25/11/2025</span>
                </div>
                <ul class="text-xs text-slate-500 space-y-1 list-disc pl-4">
                    <li><b>Auto-Link Knockout (Liên kết động):</b> Tự động điền tên đội vào lịch thi đấu vòng trong (Bán kết, Chung kết) dựa trên kết quả BXH vòng bảng (Nhất A, Nhì B...).</li>
                    <li><b>Manual Ranking (Xếp hạng thủ công):</b> Cho phép BTC kéo thả vị trí trên BXH để giải quyết các trường hợp bằng điểm số/chỉ số phụ cần bốc thăm.</li>
                    <li><b>Advanced Stats & Suspensions:</b> Tự động phát hiện và cảnh báo cầu thủ bị treo giò (thẻ đỏ/2 thẻ vàng) trước giờ thi đấu. Thống kê Hat-trick/Poker.</li>
                    <li><b>In ấn PDF Pro:</b> Xuất báo cáo giải đấu chuẩn A4 với đầy đủ Lịch thi đấu, Kết quả, BXH và Bảng vàng vinh danh.</li>
                    <li><b>Hiệu ứng Champion:</b> Pháo hoa chúc mừng tự động khi tìm ra nhà Vô địch (League hoặc Cup).</li>
                    <li>Bổ sung Hình ảnh đại diện của cầu thủ</li>
                    <li>Bổ sung Widget trận đấu sắp tới.</li>
                </ul>
            </div>

            <div class="text-center mt-8 pt-4 border-t border-slate-200 border-dashed">
                <p class="text-xs text-slate-400 font-medium">Phát triển và Thiết kế bởi</p>
                <p class="text-sm font-black text-slate-700 uppercase mt-1">Lee Nai (K99 Hòa Vang)</p>
                <p class="text-[10px] text-slate-400 mt-1">© 2025 All Rights Reserved</p>
            </div>
        </div>
    </div>
    
</main>

        <nav class="bottom-nav">
    <div onclick="switchView('tour-detail')" id="nav-tour-detail" class="nav-item active">
        <i class="fas fa-trophy"></i>Giải Đấu
    </div>

    <div onclick="switchView('results')" id="nav-results" class="nav-item text-blue-600">
        <i class="fas fa-calendar-alt text-2xl"></i>Lịch Đấu
    </div>

    <div onclick="switchView('teams')" id="nav-teams" class="nav-item">
        <i class="fas fa-shield-alt"></i>Đội Bóng
    </div>

    <div onclick="switchView('stats')" id="nav-stats" class="nav-item">
        <i class="fas fa-chart-pie"></i>Thống Kê
    </div>

    <div onclick="switchView('version')" id="nav-version" class="nav-item">
        <i class="fas fa-info-circle"></i>Version
    </div>
</nav>

    </div>

    <div id="modal-team" class="mobile-modal">
        <div class="mobile-modal-header">
            <h3 class="font-bold text-lg uppercase">Chi tiết Đội Bóng</h3>
            <button onclick="document.getElementById('modal-team').classList.remove('open')" class="w-8 h-8 rounded-full bg-slate-100"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-4 space-y-4">
            <input type="hidden" id="team-id">
            <div class="flex justify-center mb-4">
                <div class="w-24 h-24 rounded-full border-2 border-slate-200 p-1 relative group overflow-hidden">
                    <img id="team-logo-preview" src="hvfclogo.png" class="w-full h-full object-contain rounded-full">
                    <input type="file" id="team-logo-upload" accept="image/*" class="absolute inset-0 opacity-0 z-10" onchange="previewLogo(this)">
                    <div class="absolute inset-0 bg-black/50 flex items-center justify-center text-white text-[10px] font-bold opacity-0 group-hover:opacity-100 transition">ĐỔI ẢNH</div>
                </div>
            </div>
            
            <div><label class="text-xs font-bold text-slate-500">Tên Đội Bóng (*)</label><input type="text" id="team-name" class="app-input uppercase" oninput="this.value=this.value.toUpperCase()"></div>
            <div><label class="text-xs font-bold text-slate-500">Tên Viết Tắt</label><input type="text" id="team-short-name" class="app-input uppercase" oninput="this.value=this.value.toUpperCase()"></div>
            <div><label class="text-xs font-bold text-slate-500">Trưởng Đoàn</label><input type="text" id="team-leader" class="app-input" placeholder="Nhập Tên Trưởng Đoàn"></div>
            <div><label class="text-xs font-bold text-slate-500">Huấn Luyện Viên</label><input type="text" id="team-coach" class="app-input" placeholder="Nhập Tên HLV trưởng"></div>
            <div><label class="text-xs font-bold text-slate-500">Số Điện thoại liên hệ</label><input type="tel" id="team-phone" class="app-input" placeholder="Nhập số điện thoại"></div>

            <div class="flex gap-3 pt-4">
                <button onclick="deleteTeamFromModal()" class="app-btn bg-red-100 text-red-600">Xóa</button>
                <button onclick="saveTeam()" class="app-btn bg-blue-600 text-white">Lưu</button>
            </div>

            <div id="team-detail-block" class="mt-8 hidden">
                <div class="flex justify-between items-center mb-2"><h4 class="font-bold text-slate-700">Thành Viên</h4><button onclick="openMemberModal(-1)" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded font-bold">+ Thêm Thành Viên</button></div>
                <div id="team-members-list" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <div id="modal-member" class="mobile-modal z-[110]">
        <div class="mobile-modal-header bg-white border-b sticky top-0 z-20">
            <h3 class="font-bold text-lg text-slate-800">Thông tin thành viên</h3>
            <button onclick="document.getElementById('modal-member').classList.remove('open')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-4 space-y-4">
            <div class="flex justify-center mb-2">
                <div class="w-24 h-24 rounded-full border-2 border-slate-200 p-1 relative group overflow-hidden bg-slate-50">
                    <img id="mem-photo-preview" src="https://via.placeholder.com/150?text=IMG" class="w-full h-full object-cover rounded-full">
                    
                    <input type="file" id="mem-photo-upload" accept="image/*" class="absolute inset-0 opacity-0 z-10 cursor-pointer" onchange="previewMemberPhoto(this)">
                    
                    <div class="absolute inset-0 bg-black/40 flex items-center justify-center text-white text-[10px] font-bold opacity-0 group-hover:opacity-100 transition pointer-events-none">
                        <i class="fas fa-camera mr-1"></i> ĐỔI ẢNH
                    </div>
                </div>
            </div>
            <div class="text-center text-[10px] text-slate-400 italic mb-4">Chạm vào hình tròn để tải ảnh lên</div>
            <div><label class="text-xs font-bold text-slate-500">Họ và Tên (*)</label><input type="text" id="mem-name" class="app-input" placeholder="Nguyễn Văn A"></div>
            
            <div class="grid grid-cols-2 gap-3">
                <div><label class="text-xs font-bold text-slate-500">Số Áo</label><input type="number" id="mem-number" class="app-input text-center font-black" placeholder="#"></div>
                <div>
                    <label class="text-xs font-bold text-slate-500">Vai Trò</label>
                    <select id="mem-role" class="app-input font-bold">
                        <option value="Cầu thủ">Cầu thủ</option>
                        <option value="Đội trưởng">Đội trưởng</option>
                        <option value="Đội phó">Đội phó</option>
                        <option value="Thủ môn 1">Thủ môn 1</option>
                        <option value="Thủ môn 2">Thủ môn 2</option>
                        <option value="Săn sóc viên">Săn sóc viên</option>
                    </select>
                </div>
            </div>
            
            <button onclick="saveMember()" class="app-btn bg-blue-600 text-white mt-4 shadow-lg">
                <i class="fas fa-save"></i> Lưu Thông Tin
            </button>
        </div>
    </div>
    <div id="modal-bulk-members" class="mobile-modal z-[150]">
            <div class="mobile-modal-header bg-white border-b sticky top-0 z-20 shadow-sm">
                <div class="flex flex-col">
                    <h3 class="font-black text-lg text-blue-900 uppercase">Danh Sách Thành Viên</h3>
                    <p class="text-[10px] text-slate-500 font-bold">Chỉnh sửa nhanh toàn bộ đội bóng</p>
                </div>
                <button onclick="document.getElementById('modal-bulk-members').classList.remove('open')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200"><i class="fas fa-times"></i></button>
            </div>
                    
            <div class="p-3 pb-24">
                <div class="flex gap-2 mb-2 px-1 text-[9px] font-black text-slate-400 uppercase tracking-wider items-center">
                <div class="w-10 text-center">Ảnh</div> <div class="w-8 text-center">Số</div>
                <div class="flex-1">Họ và Tên</div>
                <div class="w-20">Vai trò</div>
                <div class="w-6"></div>
            </div>
                
                <div id="bulk-members-list" class="space-y-2 mb-4"></div>

                <button onclick="addBulkRow()" class="w-full py-3 border-2 border-dashed border-slate-300 rounded-xl text-slate-400 font-bold text-xs hover:border-blue-400 hover:text-blue-500 transition mb-4">
                    <i class="fas fa-plus mr-1"></i> Thêm dòng trống
                </button>

                <div class="grid grid-cols-2 gap-3 sticky bottom-4">
                    <button onclick="document.getElementById('modal-bulk-members').classList.remove('open')" class="app-btn bg-slate-200 text-slate-600">Hủy bỏ</button>
                    <button onclick="saveBulkMembers()" class="app-btn bg-blue-600 text-white shadow-lg shadow-blue-200">
                        <i class="fas fa-save"></i> Lưu Danh Sách
                    </button>
                </div>
            </div>
        </div>
    <div id="modal-event" class="mobile-modal z-[120]">
        <div class="mobile-modal-header bg-slate-900 text-white border-none">
            <div><p class="text-[10px] text-slate-400 font-bold uppercase" id="evt-match-info">MATCH</p><h3 class="font-black text-lg uppercase" id="evt-match-title">A vs B</h3></div>
            <button onclick="closeEventModal()" class="w-8 h-8 rounded-full bg-slate-700 text-white"><i class="fas fa-check"></i></button>
        </div>
        <input type="hidden" id="evt-match-id">
        <div class="p-3 space-y-3 pb-24">
            <div class="app-card border-l-4 border-l-blue-600">
                <div class="flex justify-between items-center mb-2 border-b pb-2">
                    <div class="flex items-center gap-2"><img id="evt-t1-logo" src="" class="w-8 h-8 rounded-full"><span class="font-bold text-blue-900" id="evt-t1-name">TEAM A</span></div>
                    <span class="text-3xl font-black text-blue-600" id="evt-t1-score">0</span>
                </div>
                <div class="flex gap-2 mb-2"><select id="evt-p1-select" class="app-input py-2 text-xs"></select></div>
                <div class="flex gap-2">
                    <button onclick="addEvent('goal', 1)" class="flex-1 bg-green-600 text-white py-2 rounded font-bold text-xs"><i class="fas fa-futbol"></i> Ghi Bàn</button>
                    <button onclick="addEvent('yellow', 1)" class="w-10 bg-yellow-400 text-yellow-900 rounded font-bold"><i class="fas fa-square"></i></button>
                    <button onclick="addEvent('red', 1)" class="w-10 bg-red-600 text-white rounded font-bold"><i class="fas fa-square"></i></button>
                </div>
                <div id="evt-list-t1" class="mt-2 space-y-1"></div>
            </div>

            <div class="app-card border-l-4 border-l-red-600">
                <div class="flex justify-between items-center mb-2 border-b pb-2">
                    <div class="flex items-center gap-2"><img id="evt-t2-logo" src="" class="w-8 h-8 rounded-full"><span class="font-bold text-red-900" id="evt-t2-name">TEAM B</span></div>
                    <span class="text-3xl font-black text-red-600" id="evt-t2-score">0</span>
                </div>
                <div class="flex gap-2 mb-2"><select id="evt-p2-select" class="app-input py-2 text-xs"></select></div>
                <div class="flex gap-2">
                    <button onclick="addEvent('goal', 2)" class="flex-1 bg-green-600 text-white py-2 rounded font-bold text-xs"><i class="fas fa-futbol"></i> Ghi Bàn</button>
                    <button onclick="addEvent('yellow', 2)" class="w-10 bg-yellow-400 text-yellow-900 rounded font-bold"><i class="fas fa-square"></i></button>
                    <button onclick="addEvent('red', 2)" class="w-10 bg-red-600 text-white rounded font-bold"><i class="fas fa-square"></i></button>
                </div>
                <div id="evt-list-t2" class="mt-2 space-y-1"></div>
            </div>

            <div id="penalty-section" class="hidden app-card border-t-4 border-t-purple-600 text-center">
                <h4 class="font-bold text-purple-800 uppercase mb-2">Luân Lưu</h4>
                <div class="flex justify-center gap-4 items-center">
                    <input type="number" id="evt-p1-score" class="w-16 h-16 text-center text-2xl font-black border rounded-xl" onchange="updatePenalty()">
                    <span>-</span>
                    <input type="number" id="evt-p2-score" class="w-16 h-16 text-center text-2xl font-black border rounded-xl" onchange="updatePenalty()">
                </div>
            </div>
            
            <button onclick="closeEventModal()" class="app-btn bg-slate-800 text-white">Xong</button>
        </div>
    </div>
    
    <div id="modal-edit-tour" class="mobile-modal z-[110]">
         <div class="mobile-modal-header bg-white border-b sticky top-0 z-20">
             <h3 class="font-bold text-lg text-blue-800 uppercase">Cập nhật thông tin giải</h3>
             <button onclick="document.getElementById('modal-edit-tour').classList.remove('open')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500"><i class="fas fa-times"></i></button>
         </div>
         <div class="p-4 space-y-4">
             <input type="hidden" id="edit-tour-id">
             <input type="hidden" id="edit-tour-format">
             <input type="hidden" id="edit-group-count">

             <div class="flex justify-center mb-4 mt-2">
                <div class="w-24 h-24 rounded-full border-4 border-slate-100 p-1 relative group overflow-hidden bg-white shadow-md">
                    <img id="edit-tour-logo-preview" src="hvfclogo.png" class="w-full h-full object-contain rounded-full">
                    <input type="file" id="edit-tour-logo-upload" accept="image/*" class="absolute inset-0 opacity-0 z-10 cursor-pointer" onchange="previewTourLogo(this, 'edit-tour-logo-preview')">
                    <div class="absolute inset-0 bg-black/50 flex items-center justify-center text-white text-[10px] font-bold opacity-0 group-hover:opacity-100 transition">ĐỔI LOGO</div>
                </div>
            </div>
             <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Tên Giải Đấu</label>
                <input type="text" id="edit-tour-name" class="app-input uppercase font-black text-blue-900 text-lg" placeholder="NHẬP TÊN GIẢI...">
             </div>

             <div class="grid grid-cols-2 gap-3">
                 <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Trưởng BTC</label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-slate-400"><i class="fas fa-user-tie"></i></span>
                        <input type="text" id="edit-tour-organizer" class="app-input pl-9" placeholder="Tên Trưởng BTC">
                    </div>
                 </div>
                 
                 <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">SĐT Liên Hệ</label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-slate-400"><i class="fas fa-phone"></i></span>
                        <input type="tel" id="edit-tour-phone" class="app-input pl-9" placeholder="Số điện thoại">
                    </div>
                 </div>
             </div>

             <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Địa điểm / Sân bóng</label>
                <div class="relative">
                    <span class="absolute left-3 top-3 text-slate-400"><i class="fas fa-map-marker-alt"></i></span>
                    <input type="text" id="edit-tour-location" class="app-input pl-9" placeholder="Nhập tên sân bóng...">
                </div>
             </div>

             <div class="grid grid-cols-2 gap-3 bg-slate-50 p-3 rounded-xl border border-slate-200">
                 <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Ngày Khai Mạc</label>
                    <input type="date" id="edit-tour-start" class="app-input bg-white text-xs">
                 </div>
                 <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Ngày Bế Mạc</label>
                    <input type="date" id="edit-tour-end" class="app-input bg-white text-xs">
                 </div>
             </div>

             <div id="edit-group-settings" class="mt-4 bg-white border border-slate-200 rounded-xl p-3 shadow-sm">
                <label class="text-xs font-bold text-blue-700 uppercase mb-2 block flex items-center">
                    <i class="fas fa-users-cog mr-2"></i> Cập nhật danh sách đội
                </label>
                <div class="text-[10px] text-slate-400 italic mb-2">
                    * Bạn có thể thay đổi các đội tham gia. Lưu ý: Số lượng bảng đấu không thể thay đổi.
                </div>
                <div id="edit-bucket-assigner" class="space-y-4">
                    <div id="edit-bucket-targets" class="space-y-2"></div>
                </div>
             </div>

            <div class="mt-3">
                <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Cập nhật quy đổi Fairplay</label>
                <select id="edit-tour-red-weight" class="app-input text-sm font-bold text-red-700">
                    <option value="3">1 Thẻ Đỏ = 3 điểm</option>
                    <option value="2">1 Thẻ Đỏ = 2 điểm</option>
                </select>
            </div>
             <div class="pt-2">
                 <button onclick="saveTourSettings()" class="app-btn bg-blue-600 text-white shadow-lg uppercase tracking-wide">
                    <i class="fas fa-save"></i> Lưu Thông Tin
                 </button>
             </div>
         </div>
    </div>
    
    <div id="modal-advance" class="mobile-modal z-[110]">
         <div class="mobile-modal-header"><h3 class="font-bold text-lg">Vào Knock-out</h3><button onclick="document.getElementById('modal-advance').classList.remove('open')" class="w-8 h-8 rounded-full bg-slate-100"><i class="fas fa-times"></i></button></div>
         <div class="p-4 space-y-4">
             <select id="advance-rule" class="app-input" onchange="updateAdvancePreview()"><option value="1">Lấy Nhất Bảng</option><option value="2">Lấy Nhất + Nhì</option></select>
             <div class="flex items-center gap-2"><input type="checkbox" id="advance-wildcard" class="w-5 h-5" onchange="updateAdvancePreview()"><label>Lấy vé vớt</label></div>
             <div id="advance-preview-list" class="space-y-2"></div>
             <div id="advance-suggestion" class="text-xs italic text-slate-500"></div>
             <button onclick="generateKnockoutFromGroups()" class="app-btn bg-red-600 text-white">Tạo Lịch</button>
         </div>
    </div>

    <div id="modal-prepare-round" class="mobile-modal z-[110]">
         <div class="mobile-modal-header"><h3 class="font-bold text-lg">Bốc thăm</h3><button onclick="document.getElementById('modal-prepare-round').classList.remove('open')" class="w-8 h-8 rounded-full bg-slate-100"><i class="fas fa-times"></i></button></div>
         <div class="p-4 flex flex-col h-full">
             <div id="sort-team-list" class="flex-1 overflow-y-auto space-y-2 pb-4"></div>
             <div id="preview-knockout-msg" class="text-center font-bold text-red-600 mb-2"></div>
             <button onclick="generateKnockoutMatches()" class="app-btn bg-red-600 text-white">Xác Nhận</button>
         </div>
    </div>

    <div id="custom-alert-modal" class="fixed inset-0 bg-black/80 z-[200] flex items-center justify-center p-6 hidden">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 text-center shadow-2xl">
            <div id="alert-icon-container" class="w-16 h-16 rounded-full bg-blue-100 mx-auto flex items-center justify-center mb-4"><i id="alert-icon" class="fas fa-info text-2xl text-blue-600"></i></div>
            <h3 id="alert-title" class="text-xl font-black text-slate-800 uppercase mb-2">Thông báo</h3>
            <p id="alert-msg" class="text-sm text-slate-500 font-medium mb-4">Content</p>
            <div id="prompt-input-container" class="hidden mb-4"><input type="text" id="alert-input" class="app-input text-center text-lg"></div>
            <div id="alert-actions" class="flex gap-2 justify-center"></div>
        </div>
    </div>
    <div id="modal-manual-rank" class="mobile-modal z-[130]">
        <div class="mobile-modal-header bg-blue-900 text-white border-none">
            <h3 class="font-bold text-lg uppercase" id="manual-rank-title">Điều chỉnh thứ hạng</h3>
            <button onclick="closeManualRankModal()" class="w-8 h-8 rounded-full bg-blue-800 text-white"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-4">
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-xs text-yellow-800 mb-4">
                <i class="fas fa-info-circle mr-1"></i> <b>Hướng dẫn:</b> Nếu các đội bằng điểm/chỉ số, hãy tổ chức bốc thăm, sau đó dùng mũi tên bên dưới để xếp lại vị trí. Hệ thống sẽ dùng thứ tự này để xét vào vòng trong.
            </div>
            
            <div id="manual-rank-list" class="space-y-2">
                </div>

            <div class="flex gap-2 mt-6">
                <button onclick="resetManualRank()" class="flex-1 app-btn bg-slate-200 text-slate-600">Mặc định</button>
                <button onclick="saveManualRank()" class="flex-1 app-btn bg-blue-600 text-white">Lưu Thứ Hạng</button>
            </div>
        </div>
    </div>
    <div id="modal-quick-switch" class="mobile-modal z-[150]">
        <div class="mobile-modal-header bg-white border-b sticky top-0 z-20">
            <h3 class="font-bold text-lg text-slate-800">Chuyển Đến Giải Khác</h3>
            <button onclick="document.getElementById('modal-quick-switch').classList.remove('open')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-4 bg-slate-50 min-h-screen pb-24">
            <div id="quick-switch-list" class="space-y-3"></div>
        </div>
    </div>
    <div id="print-area"></div>

    <script>
        // --- CẤU HÌNH LƯU TRỮ LOCAL (OFFLINE - V4.2025) ---
        const STORAGE_KEY = 'hvfc_manager_data_v4';   
        var appData = { teams: [], tournaments: [], currentTourId: null };
        var currentUser = null;

        const DEFAULT_RANKING_RULES = [
            { id: 'pts', name: 'Điểm số (Points)', active: true, locked: true }, 
            { id: 'h2h', name: 'Thành tích đối đầu (Head-to-Head)', active: true },
            { id: 'gd', name: 'Hiệu số bàn thắng (Goal Diff)', active: true },
            { id: 'gf', name: 'Tổng bàn thắng (Goals For)', active: true },
            { id: 'fps', name: 'Fair Play (Thẻ phạt)', active: true }
        ];
        let currentRankingRules = [];
        
        var groupBuckets = {}; var editGroupBuckets = {}; var groupLimits = {}; 
        var activeEventMatchId = null; var selectedTeamId = null; var editingMemberIdx = -1;
        var tempRoundTeams = []; var tempLosers = []; var pendingByeTeam = null; var tempQualifiedTeams = [];
        // ------------------------------------------------------
        // --- BƯỚC 3: HÀM IN BÁO CÁO GIẢI ĐẤU (FULL THÔNG TIN) ---
        window.printTournament = function() {
            const t = appData.tournaments.find(x => x.id === appData.currentTourId);
            if (!t) return;

            const printArea = document.getElementById('print-area');
            printArea.innerHTML = ''; 

            // --- 1. CHUẨN BỊ DỮ LIỆU LỊCH THI ĐẤU ---
            let allMatches = [];
            if(t.format === 'group') {
                allMatches = t.data.groups.flatMap(g => g.matches.map(m=>({...m, grp:g.name, sortG:g.name, sortR:m.round||0})));
                if(t.data.knockoutMatches) {
                    allMatches = allMatches.concat(t.data.knockoutMatches.map(m=>({...m, grp:'Knockout', sortG:'Z', sortR:m.round||999})));
                }
            } else {
                allMatches = t.data.matches.map(m=>({...m, grp:'Knockout', sortG:'A', sortR:m.round}));
            }

            // Sắp xếp: Bảng -> Vòng -> Ngày giờ
            allMatches.sort((a,b) => a.sortG.localeCompare(b.sortG) || a.sortR - b.sortR || (a.date||'').localeCompare(b.date||'') || (a.time||'').localeCompare(b.time||''));

            // --- 2. XÂY DỰNG HTML BÁO CÁO ---
            let html = `
            <div class="max-w-[210mm] mx-auto bg-white">
                
                <div class="border-b-4 border-double border-slate-800 pb-4 mb-6">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <img src="${t.logo || 'hvfclogo.png'}" onerror="this.src='https://via.placeholder.com/100?text=LOGO'" class="h-16 w-16 object-contain">
                            <div>
                                <div class="text-xs font-bold text-slate-500 uppercase">HỆ THỐNG QUẢN LÝ GIẢI ĐẤU</div>
                                <div class="text-2xl font-black text-blue-900 uppercase leading-none mt-1">${t.name}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-slate-400 font-bold uppercase">Ngày xuất báo cáo</div>
                            <div class="font-mono font-bold text-slate-800">${new Date().toLocaleString('vi-VN')}</div>
                        </div>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 grid grid-cols-2 gap-y-2 gap-x-8 text-xs">
                        <div class="flex justify-between border-b border-slate-200 border-dashed pb-1">
                            <span class="font-bold text-slate-500 uppercase">Trưởng Ban Tổ Chức:</span>
                            <span class="font-black text-slate-900 text-sm">${t.organizer || '---'}</span>
                        </div>
                        <div class="flex justify-between border-b border-slate-200 border-dashed pb-1">
                            <span class="font-bold text-slate-500 uppercase">Điện thoại liên hệ:</span>
                            <span class="font-black text-slate-900 text-sm">${t.phone || '---'}</span>
                        </div>
                        <div class="flex justify-between border-b border-slate-200 border-dashed pb-1">
                            <span class="font-bold text-slate-500 uppercase">Địa điểm tổ chức:</span>
                            <span class="font-black text-slate-900 text-sm">${t.location || 'Sân bóng Hòa Vang'}</span>
                        </div>
                        <div class="flex justify-between border-b border-slate-200 border-dashed pb-1">
                            <span class="font-bold text-slate-500 uppercase">Thời gian giải:</span>
                            <span class="font-black text-slate-900 text-sm">${formatDate(t.startDate)} - ${formatDate(t.endDate)}</span>
                        </div>
                    </div>
                </div>

                <div class="mb-8">
                    <h2 class="font-black text-lg text-white bg-blue-900 px-3 py-1 uppercase mb-4 inline-block rounded-r-lg shadow-sm">
                        I. Bảng Xếp Hạng & Thống Kê
                    </h2>
                    
                    <div class="stats-print-container text-sm">
                        ${renderStats(true)}
                    </div>
                </div>

                <div class="page-break"></div> <div>
                    <h2 class="font-black text-lg text-white bg-red-700 px-3 py-1 uppercase mb-4 inline-block rounded-r-lg shadow-sm">
                        II. Lịch Thi Đấu & Kết Quả Chi Tiết
                    </h2>

                    <table class="w-full text-xs border-collapse border border-slate-300 shadow-sm">
                        <thead class="bg-slate-100 text-slate-700 uppercase font-black">
                            <tr>
                                <th class="border border-slate-300 p-2 w-10 text-center">STT</th>
                                <th class="border border-slate-300 p-2 w-24 text-center">Ngày/Giờ</th>
                                <th class="border border-slate-300 p-2">Bảng/Vòng</th>
                                <th class="border border-slate-300 p-2 text-right w-1/4">Đội 1</th>
                                <th class="border border-slate-300 p-2 w-16 text-center">Tỷ số</th>
                                <th class="border border-slate-300 p-2 text-left w-1/4">Đội 2</th>
                                <th class="border border-slate-300 p-2">Ghi chú</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            // Render các dòng bảng
            allMatches.forEach((m, i) => {
                const t1 = getTeam(m.t1);
                const t2 = getTeam(m.t2);
                
                // Xử lý hiển thị tỷ số
                let scoreDisplay = 'vs';
                let rowClass = 'bg-white';
                let note = '';

                if(m.isFullTime) {
                    scoreDisplay = `${m.s1} - ${m.s2}`;
                    rowClass = 'bg-slate-50'; // Trận đã đá có nền xám nhẹ
                    if(m.p1 !== null && m.p2 !== null) {
                        note = `Pen: ${m.p1}-${m.p2}`;
                    }
                }

                // Tên đội đậm nếu thắng
                const t1Class = (m.isFullTime && (m.s1 > m.s2 || m.p1 > m.p2)) ? 'font-black text-blue-900' : 'font-medium';
                const t2Class = (m.isFullTime && (m.s2 > m.s1 || m.p2 > m.p1)) ? 'font-black text-blue-900' : 'font-medium';

                html += `
                <tr class="${rowClass} border-b border-slate-200">
                    <td class="border border-slate-300 p-2 text-center font-bold text-slate-500">${i + 1}</td>
                    <td class="border border-slate-300 p-2 text-center">
                        <div class="font-bold">${m.time || '--:--'}</div>
                        <div class="text-[10px] text-slate-500">${m.date ? formatDate(m.date) : ''}</div>
                    </td>
                    <td class="border border-slate-300 p-2 font-bold text-slate-700 text-center">
                        ${m.name || m.roundLabel || m.grp}
                    </td>
                    <td class="border border-slate-300 p-2 text-right ${t1Class}">
                        ${t1 ? t1.name : 'Chưa xác định'}
                    </td>
                    <td class="border border-slate-300 p-2 text-center font-black text-lg bg-white">
                        ${scoreDisplay}
                    </td>
                    <td class="border border-slate-300 p-2 text-left ${t2Class}">
                        ${t2 ? t2.name : 'Chưa xác định'}
                    </td>
                    <td class="border border-slate-300 p-2 text-center italic text-slate-500 text-[10px]">
                        ${note}
                    </td>
                </tr>`;
            });

            html += `</tbody></table></div>`;

            // FOOTER KÝ TÊN
            html += `
                <div class="grid grid-cols-2 mt-12 pt-4 break-inside-avoid">
                    <div class="text-center">
                        <h4 class="font-bold text-sm uppercase">Trọng Tài Trưởng</h4>
                        <p class="text-[10px] italic text-slate-500 mt-16">(Ký & Ghi rõ họ tên)</p>
                    </div>
                    <div class="text-center">
                        <h4 class="font-bold text-sm uppercase">Trưởng Ban Tổ Chức</h4>
                        <p class="text-[10px] italic text-slate-500 mt-16">(Ký & Đóng dấu)</p>
                    </div>
                </div>
            </div>`;
            
            printArea.innerHTML = html;
            
            // Đợi 1 chút để ảnh/style load xong rồi mới in
            setTimeout(() => {
                window.print();
            }, 500);
        }
        // 1. Hàm mở Modal (Chỉ nạp thông tin text)
        // 1. Hàm mở Modal (CẬP NHẬT: NẠP DỮ LIỆU ĐỘI BÓNG ĐỂ SỬA)
        window.openEditTourModal = function(){ 
            const t = appData.tournaments.find(x => x.id === appData.currentTourId); 
            if(!t) return;

            document.getElementById('modal-edit-tour').classList.add('open'); 
            
            // Nạp dữ liệu hiện tại
            document.getElementById('edit-tour-id').value = t.id; 
            document.getElementById('edit-tour-name').value = t.name; 
            document.getElementById('edit-tour-logo-preview').src = t.logo || 'hvfclogo.png';
            document.getElementById('edit-tour-logo-upload').value = ''; 
            
            document.getElementById('edit-tour-organizer').value = t.organizer || ''; 
            document.getElementById('edit-tour-phone').value = t.phone || ''; 
            document.getElementById('edit-tour-location').value = t.location || '';
            document.getElementById('edit-tour-start').value = t.startDate || ''; 
            document.getElementById('edit-tour-end').value = t.endDate || ''; 

            const currentRedPoint = (t.config && t.config.redCardPoint) ? t.config.redCardPoint : 3;
            document.getElementById('edit-tour-red-weight').value = currentRedPoint;

            // --- PHẦN MỚI: CHUẨN BỊ DỮ LIỆU ĐỂ SỬA ĐỘI ---
            // Lưu các biến cấu hình vào input ẩn để hàm render bucket đọc được
            document.getElementById('edit-tour-format').value = t.format;
            const grpCount = t.config.groupCount || 1;
            document.getElementById('edit-group-count').value = grpCount;

            // Copy cấu hình buckets hiện tại sang biến editGroupBuckets
            // (Phải dùng JSON.parse/stringify để clone sâu, tránh sửa trực tiếp vào data gốc khi chưa bấm Lưu)
            editGroupBuckets = JSON.parse(JSON.stringify(t.config.buckets || {}));

            // Tính toán limit hiện tại (Số đội mỗi bảng)
            groupLimits = {}; // Reset limit
            for(let i=0; i<grpCount; i++) {
                // Limit mặc định bằng số đội đang có trong bảng đó
                groupLimits['edit-'+i] = editGroupBuckets[i] ? editGroupBuckets[i].length : 0;
            }

            // Gọi hàm vẽ giao diện chọn đội (chế độ edit)
            renderEditBucketAssigner();
            // ---------------------------------------------
        }

        // 2. Hàm Lưu (CẬP NHẬT: LƯU DANH SÁCH ĐỘI MỚI)
        window.saveTourSettings = function(){ 
            if (currentUser !== 'admin') {
                return showAppAlert("Cảnh báo", "Chế độ Khách không được phép chỉnh sửa thông tin!", "error");
            }

            const t = appData.tournaments.find(x => x.id === appData.currentTourId); 
            if(!t) return;

            const newName = document.getElementById('edit-tour-name').value;
            if(!newName.trim()) return showAppAlert('Lỗi', 'Tên giải đấu không được để trống.', 'error');

            // --- KIỂM TRA SỐ LƯỢNG ĐỘI TRƯỚC KHI LƯU ---
            const grpCount = parseInt(document.getElementById('edit-group-count').value);
            let newAllTeamIds = [];
            
            for(let i=0; i<grpCount; i++) {
                const limit = groupLimits['edit-'+i] || 0;
                const currentSelected = editGroupBuckets[i] ? editGroupBuckets[i].length : 0;
                
                // Bắt buộc phải chọn đủ số lượng như cũ (hoặc như limit đã nhập)
                if (limit > 0 && currentSelected !== limit) {
                    return showAppAlert('Lỗi', `Bảng ${String.fromCharCode(65+i)}: Số đội chưa đúng (Yêu cầu: ${limit}, Đang chọn: ${currentSelected}).`, 'error');
                }
                if(editGroupBuckets[i]) newAllTeamIds = newAllTeamIds.concat(editGroupBuckets[i]);
            }
            // -------------------------------------------

            // Cập nhật thông tin text
            t.name = newName.toUpperCase(); 
            t.logo = document.getElementById('edit-tour-logo-preview').src;
            t.organizer = document.getElementById('edit-tour-organizer').value; 
            t.phone = document.getElementById('edit-tour-phone').value; 
            t.location = document.getElementById('edit-tour-location').value;
            t.startDate = document.getElementById('edit-tour-start').value; 
            t.endDate = document.getElementById('edit-tour-end').value;
            
            if(!t.config) t.config = {}; 
            t.config.redCardPoint = parseInt(document.getElementById('edit-tour-red-weight').value);

            // --- LƯU CẤU HÌNH ĐỘI MỚI ---
            t.teamIds = newAllTeamIds; // Cập nhật danh sách tổng ID
            t.config.buckets = JSON.parse(JSON.stringify(editGroupBuckets)); // Cập nhật chia bảng
            
            // Lưu ý: Việc thay đổi đội ở đây CHỈ CẬP NHẬT CẤU HÌNH.
            // Nếu lịch thi đấu đã tạo rồi, tên đội trong lịch cũ sẽ KHÔNG tự đổi (tránh lỗi logic).
            // Tuy nhiên, nếu bạn Reset giải đấu hoặc tạo lịch lại, nó sẽ dùng đội mới này.
            // ---------------------------

            saveToStorage();
            
            document.getElementById('modal-edit-tour').classList.remove('open');
            loadTour(t.id); 
            
            showAppAlert("Thành công", "Đã cập nhật thông tin và danh sách đội bóng.", "success");
        }

        // Modal Helper
        function openMobileModal(id) { document.getElementById(id).classList.add('open'); }
        function closeMobileModal(id) { document.getElementById(id).classList.remove('open'); }
        
        // --- ALERT SYSTEM ---
        const alertModal = document.getElementById('custom-alert-modal');
        const alertTitle = document.getElementById('alert-title');
        const alertMsg = document.getElementById('alert-msg');
        const alertActions = document.getElementById('alert-actions');
        const alertInputContainer = document.getElementById('prompt-input-container');
        const alertInput = document.getElementById('alert-input');
        const alertIcon = document.getElementById('alert-icon');
        const alertIconContainer = document.getElementById('alert-icon-container');

        function showAppAlert(title, msg, type = 'info') {
            return new Promise((resolve) => {
                setupModal(title, msg, type);
                alertActions.innerHTML = `<button onclick="closeAppAlert()" class="flex-1 bg-slate-100 text-slate-800 font-bold py-3 rounded-xl">Đóng</button>`;
                const closeBtn = alertActions.querySelector('button');
                closeBtn.onclick = () => { closeAppAlert(); resolve(); };
                openModal();
            });
        }

        function showAppConfirm(msg, confirmText = 'Đồng ý', onConfirm) {
            setupModal('Xác nhận', msg, 'question');
            alertActions.innerHTML = `
                <button id="btn-confirm-cancel" class="flex-1 bg-slate-100 text-slate-600 font-bold py-3 rounded-xl">Hủy</button>
                <button id="btn-confirm-ok" class="flex-1 bg-red-600 text-white font-bold py-3 rounded-xl">${confirmText}</button>
            `;
            document.getElementById('btn-confirm-cancel').onclick = closeAppAlert;
            document.getElementById('btn-confirm-ok').onclick = () => { closeAppAlert(); if(onConfirm) onConfirm(); };
            openModal();
        }

        function showAppPrompt(msg, defaultValue, onOk) {
            setupModal('Nhập thông tin', msg, 'prompt');
            alertInput.value = defaultValue || '';
            alertActions.innerHTML = `
                <button id="btn-prompt-cancel" class="flex-1 bg-slate-100 text-slate-600 font-bold py-3 rounded-xl">Hủy</button>
                <button id="btn-prompt-ok" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl">OK</button>
            `;
            document.getElementById('btn-prompt-cancel').onclick = closeAppAlert;
            document.getElementById('btn-prompt-ok').onclick = () => { const val = alertInput.value; closeAppAlert(); if(onOk) onOk(val); };
            openModal();
            setTimeout(() => alertInput.focus(), 100);
        }

        function setupModal(title, msg, type) {
            alertTitle.innerText = title;
            alertMsg.innerText = msg;
            alertInputContainer.classList.add('hidden');
            alertIconContainer.className = "w-16 h-16 rounded-full mx-auto flex items-center justify-center mb-4";
            if(type === 'error') { alertIconContainer.classList.add('bg-red-100'); alertIcon.className = 'fas fa-exclamation-triangle text-red-600 text-2xl'; }
            else if (type === 'question') { alertIconContainer.classList.add('bg-yellow-100'); alertIcon.className = 'fas fa-question text-yellow-600 text-2xl'; }
            else if (type === 'prompt') { alertIconContainer.classList.add('bg-purple-100'); alertIcon.className = 'fas fa-pen text-purple-600 text-2xl'; alertInputContainer.classList.remove('hidden'); }
            else { alertIconContainer.classList.add('bg-blue-100'); alertIcon.className = 'fas fa-info text-blue-600 text-2xl'; }
        }
        function openModal() { alertModal.classList.remove('hidden'); }
        function closeAppAlert() { alertModal.classList.add('hidden'); }

        // --- AUTH (ĐÃ CẬP NHẬT: LƯU TRẠNG THÁI SESSION) ---
        function handleLogin(role) { 
            const u = document.getElementById('login-user').value; 
            const p = document.getElementById('login-pass').value; 
            const remember = document.getElementById('remember-me').checked;
            if(role === 'admin') { 
                if(u === 'Lee Nai' && p === 'Abcd1234@') {
                    if (remember) { localStorage.setItem('hvfc_u', u); localStorage.setItem('hvfc_p', p); localStorage.setItem('hvfc_r', 'true'); } 
                    else { localStorage.removeItem('hvfc_u'); localStorage.removeItem('hvfc_p'); localStorage.removeItem('hvfc_r'); }
                    loginSuccess('admin'); 
                } else showAppAlert('Lỗi', 'Sai tài khoản/mật khẩu', 'error'); 
            } else loginSuccess('guest'); 
        }

        function loginSuccess(role) { 
            currentUser = role;
            sessionStorage.setItem('hvfc_session_role', role);

            // Xử lý giao diện Đăng nhập
            document.getElementById('welcome-screen').style.display = 'none'; 
            document.getElementById('app-container').classList.remove('hidden'); 
            document.getElementById('user-role-lbl').innerText = role==='admin'?"Admin (Quản trị)":"Khách (Chỉ xem)"; 
            document.querySelector('.bottom-nav').classList.remove('hidden');

            // --- PHÂN QUYỀN GUEST ---
            if(role === 'guest') {
                document.body.classList.add('guest-mode'); 
                const adminIds = ['btn-global-edit', 'btn-delete-multi', 'btn-delete-multi-tour', 'group-to-knockout-area', 'knockout-actions'];
                adminIds.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.classList.add('hidden');
                });
            } else {
                document.body.classList.remove('guest-mode');
                const adminIds = ['btn-global-edit', 'btn-delete-multi', 'btn-delete-multi-tour', 'group-to-knockout-area', 'knockout-actions'];
                adminIds.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.classList.remove('hidden');
                });
            }
            
            // CHỈ CẦN GỌI HÀM NÀY, MỌI VIỆC KHÔI PHỤC NÓ SẼ TỰ LO
            loadFromStorage(); 
        }

        function handleLogout() { 
            // 3. MỚI: Xóa Session khi đăng xuất thật sự
            sessionStorage.removeItem('hvfc_session_role');
            sessionStorage.removeItem('hvfc_last_view');
            location.reload(); 
        }
        // --- LOGIC NÚT HOME: QUAY VỀ TRANG QUẢN LÝ GIẢI ---
        // --- SỬA LỖI: HÀM goHome CHUẨN (XỬ LÝ CẢ LOGIN VÀ NAV) ---
        window.goHome = function() {
    // Hiện lại thanh menu dưới
    const bottomNav = document.querySelector('.bottom-nav');
    if (bottomNav) bottomNav.classList.remove('hidden');

    if (!currentUser) return; // Nếu chưa đăng nhập thì thôi

    // Ẩn trang history (nếu có)
    const histEl = document.getElementById('content-history');
    if (histEl) histEl.classList.add('hidden');
    
    // Ẩn trang welcome
    const welcomeEl = document.getElementById('welcome-screen');
    if (welcomeEl) welcomeEl.style.display = 'none';

    // Hiện app container
    const appContainer = document.getElementById('app-container');
    if (appContainer) appContainer.classList.remove('hidden');

    // Mặc định về trang Danh sách giải
    switchView('tour-list');
}
        // --- CORE FUNCTIONS (Simplified for Mobile) ---
        function generateId() { return Math.random().toString(36).substr(2,9); }
        function formatDate(dStr) { if(!dStr) return ''; const [y, m, d] = dStr.split('-'); return `${d}/${m}/${y}`; }
        function getTeam(tid) { return appData.teams.find(x=>x.id===tid); }
        // --- HÀM TẢI DỮ LIỆU TỪ CLOUD ---
// --- HÀM TẢI DỮ LIỆU TỪ CLOUD (ĐÃ SỬA LỖI F5) ---
        // --- HÀM TẢI DỮ LIỆU TỪ MÁY (OFFLINE) ---
// --- BỘ HÀM CORE ĐÃ ĐƯỢC DỌN DẸP SẠCH SẼ (V4.2025) ---

// 1. HÀM TẢI DỮ LIỆU (OFFLINE)
function loadFromStorage() {
    const rawData = localStorage.getItem(STORAGE_KEY);
    if (rawData) {
        try {
            const data = JSON.parse(rawData);
            appData.teams = data.teams || [];
            appData.tournaments = data.tournaments || [];
        } catch (e) {
            console.error("Dữ liệu lỗi, khởi tạo mới:", e);
            appData = { teams: [], tournaments: [] };
        }
    } else {
        appData = { teams: [], tournaments: [] };
    }

    // Khôi phục giải đang xem
    const savedTourId = sessionStorage.getItem('hvfc_current_tour_id');
    if (savedTourId) {
        const tourExists = appData.tournaments.find(t => t.id === savedTourId);
        if (tourExists) {
            appData.currentTourId = savedTourId;
        } else {
            sessionStorage.removeItem('hvfc_current_tour_id');
            appData.currentTourId = null;
        }
    }

    // Vẽ lại giao diện
    renderTeamList();
    renderSavedTours();

    // Khôi phục View
    const lastView = sessionStorage.getItem('hvfc_last_view') || 'tour-list';
    switchView(lastView);
}

// 2. HÀM LƯU DỮ LIỆU (OFFLINE)
function saveToStorage() {
    if(currentUser === 'guest') {
        showAppAlert("Cảnh báo", "Chế độ Khách không được quyền chỉnh sửa!", "error");
        return Promise.reject("Guest Mode");
    }

    return new Promise((resolve, reject) => {
        try {
            const dataToSave = JSON.stringify({
                teams: appData.teams,
                tournaments: appData.tournaments
            });
            localStorage.setItem(STORAGE_KEY, dataToSave);
            
            // Toast thông báo
            const saveInd = document.createElement('div');
            saveInd.className = 'fixed bottom-24 right-4 bg-green-600/90 text-white px-3 py-1 rounded-full text-xs font-bold z-[9999] flex items-center gap-2 animate-bounce';
            saveInd.innerHTML = '<i class="fas fa-save"></i> Đã lưu';
            document.body.appendChild(saveInd);
            setTimeout(() => saveInd.remove(), 1000);

            resolve({ success: true });
        } catch (e) {
            if (e.name === 'QuotaExceededError') {
                showAppAlert("Bộ nhớ đầy", "Dung lượng trình duyệt đã đầy. Hãy xóa bớt ảnh hoặc giải đấu cũ.", "error");
            }
            reject(e);
        }
    });
}

    // Hàm hiển thị trang lịch sử (gọi từ màn hình login hoặc menu)
function showVersionHistory() {
    // 1. Nếu đang ở màn hình login thì ẩn đi, hiện khung app chính
    document.getElementById('welcome-screen').style.display = 'none';
    document.getElementById('app-container').classList.remove('hidden');
    
    // 2. Ẩn tất cả các tab chức năng (Đội bóng, Giải đấu...)
    ['content-teams','content-tournament','content-results','content-schedule','content-stats'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
    });
    
    // 3. Xóa trạng thái active ở menu dưới (cho sạch)
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

    // 4. QUAN TRỌNG: Ẩn thanh menu dưới cùng (Bottom Nav)
    // Để người dùng không thể bấm chuyển tab
    document.querySelector('.bottom-nav').classList.add('hidden');

    // 5. Hiện trang history
    document.getElementById('content-history').classList.remove('hidden');
    
    // Cuộn lên đầu trang
    window.scrollTo(0,0);
}

// Cập nhật lại hàm goHome để nó xử lý việc quay lại từ trang History
// (Tìm hàm goHome cũ và thay thế hoặc bổ sung logic này)
        // --- TEAM LOGIC ---
        // --- TÌM VÀ THAY THẾ HÀM renderTeamList ---
        // --- TÌM VÀ THAY THẾ HÀM renderTeamList ---
        function renderTeamList() {
            const c = document.getElementById('team-list-box'); 
            c.innerHTML = ''; 
            
            const term = document.getElementById('search-team').value.toLowerCase();
            
            // --- XỬ LÝ ẨN HIỆN NÚT CHỨC NĂNG CHO KHÁCH ---
            const btnCreate = document.querySelector('button[onclick="createNewTeams()"]');
            const chkAll = document.getElementById('select-all-teams').parentElement;
            
            if (currentUser === 'guest') {
                if(btnCreate) btnCreate.classList.add('hidden'); // Ẩn nút +
                if(chkAll) chkAll.classList.add('hidden');       // Ẩn checkbox chọn tất cả
            } else {
                if(btnCreate) btnCreate.classList.remove('hidden');
                if(chkAll) chkAll.classList.remove('hidden');
            }
            // ---------------------------------------------

            appData.teams.filter(t => t.name.toLowerCase().includes(term)).forEach(t => {
                const mems = t.members || []; 
                const captain = mems.find(m => m.role === 'Đội trưởng');
                const captainName = captain ? captain.name : '---';

                // Chỉ hiện checkbox xóa nếu là Admin
                const checkboxHtml = (currentUser === 'admin') ? 
                    `<input type="checkbox" class="team-select-check w-5 h-5 absolute top-3 right-3 accent-red-600 z-10" value="${t.id}" onclick="event.stopPropagation(); toggleDeleteButton();">` : '';

                const d = document.createElement('div');
                d.className = "app-card relative p-3 border border-slate-200 shadow-sm bg-white hover:border-blue-400 transition mb-3";
                d.onclick = (e) => { if(e.target.type !== 'checkbox') showTeamDetail(t.id); };

                d.innerHTML = `
                    ${checkboxHtml}
                    <div class="flex gap-3 items-start">
                        <div class="w-28 h-28 shrink-0 border rounded-xl p-1 bg-slate-50 flex items-center justify-center shadow-inner">
                            <img src="${t.logo||'hvfclogo.png'}" class="w-full h-full object-contain">
                        </div>

                        <div class="flex-1 min-w-0 py-0.5">
                            <div class="pr-6 mb-1.5">
                                <h4 class="font-black text-slate-800 text-sm uppercase leading-tight inline">
                                    ${t.name}
                                </h4>
                                <span class="inline-block ml-1 text-[10px] font-black text-white bg-blue-600 px-1.5 py-0.5 rounded tracking-wider align-text-top">
                                    ${t.shortName || '---'}
                                </span>
                            </div>

                            <div class="flex flex-col gap-1 text-[11px] text-slate-500">
                                <div class="flex items-center gap-2 truncate">
                                    <i class="fas fa-user-tie w-4 text-center text-slate-400"></i>
                                    <span class="font-bold text-slate-700">HLV:</span> 
                                    <span class="truncate">${t.coach || '---'}</span>
                                </div>
                                <div class="flex items-center gap-2 truncate">
                                    <i class="fas fa-user-shield w-4 text-center text-slate-400"></i>
                                    <span class="font-bold text-slate-700">T.Đoàn:</span> 
                                    <span class="truncate">${t.leader || '---'}</span>
                                </div>
                                <div class="flex items-center gap-2 truncate pt-1 border-t border-dashed border-slate-200 mt-1">
                                    <i class="fas fa-phone w-4 text-center text-green-500"></i>
                                    <span class="font-bold text-green-600">${t.phone || 'Chưa cập nhật'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                c.appendChild(d);
            });
            toggleDeleteButton();
        }
        function toggleSelectAllTeams(src) { document.querySelectorAll('.team-select-check').forEach(c => c.checked = src.checked); toggleDeleteButton(); }
        function toggleDeleteButton() { const cnt = document.querySelectorAll('.team-select-check:checked').length; document.getElementById('btn-delete-multi').classList.toggle('hidden', cnt===0); }
        function deleteSelectedTeams() { showAppConfirm("Xóa các đội đã chọn?", "Xóa", () => { const ids = Array.from(document.querySelectorAll('.team-select-check:checked')).map(c=>c.value); appData.teams = appData.teams.filter(t => !ids.includes(t.id)); saveToStorage(); renderTeamList(); }); }
        
        // --- 1. CẬP NHẬT HÀM showTeamDetail ---
        // --- TÌM VÀ THAY THẾ HÀM showTeamDetail ---
        // --- HÀM CHI TIẾT ĐỘI BÓNG (GIAO DIỆN PRO V3.2025) ---
        function showTeamDetail(id) {
            selectedTeamId = id; const t = getTeam(id);
            const isGuest = (currentUser === 'guest');

            // Nạp dữ liệu vào Form
            document.getElementById('team-id').value = t.id;
            const inputs = ['team-name', 'team-short-name', 'team-leader', 'team-coach', 'team-phone'];
            inputs.forEach(id => document.getElementById(id).value = t[id.replace('team-','').replace('short-name','shortName')] || '');
            
            document.getElementById('team-logo-preview').src = t.logo || 'hvfclogo.png';
            
            // --- XỬ LÝ QUYỀN KHÁCH (ẨN/HIỆN INPUT) ---
            const actionBtns = document.querySelector('#modal-team .flex.gap-3.pt-4');
            const fileInput = document.getElementById('team-logo-upload');
            
            if(isGuest) {
                if(actionBtns) actionBtns.style.display = 'none'; // Ẩn nút Lưu/Xóa
                if(fileInput) fileInput.disabled = true; // Cấm upload ảnh
            } else {
                if(actionBtns) actionBtns.style.display = 'flex';
                if(fileInput) fileInput.disabled = false;
            }

            openMobileModal('modal-team');
            
            const mc = document.getElementById('team-members-list'); 
            mc.innerHTML = '';
            document.getElementById('team-detail-block').classList.remove('hidden');
            
            // --- NÚT CHỨC NĂNG THÀNH VIÊN ---
            const btnAddMem = document.querySelector('#team-detail-block button');
            if(btnAddMem) btnAddMem.style.display = isGuest ? 'none' : 'block';

            if (!isGuest) {
                mc.innerHTML += `
                <button onclick="openBulkMemberEdit()" class="w-full mb-3 bg-white border border-blue-200 text-blue-600 py-2 rounded-xl font-bold text-xs shadow-sm hover:bg-blue-50 transition uppercase flex items-center justify-center gap-2">
                    <i class="fas fa-list-ol"></i> Chỉnh sửa danh sách thành viên (Nhập nhanh)
                </button>`;
            }

            // --- RENDER DANH SÁCH THÀNH VIÊN (GIAO DIỆN MỚI) ---
            t.members.forEach((m,i) => {
                
                // 1. XỬ LÝ AVATAR (Sửa lỗi: Không dùng số áo làm ảnh nữa)
                // Nếu không có ảnh -> Hiện icon người (fas fa-user)
                let avatarHtml = m.photo 
                    ? `<img src="${m.photo}" class="w-12 h-12 rounded-full object-cover border-2 border-white shadow-md">`
                    : `<div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center border-2 border-white shadow-sm text-slate-300"><i class="fas fa-user text-xl"></i></div>`;

                // 2. XỬ LÝ SỐ ÁO (HÌNH VUÔNG TO)
                // Layout: Ô vuông, trên ghi "SỐ", dưới ghi số áo to
                const numberBoxHtml = `
                    <div class="w-11 h-11 bg-slate-50 border-2 border-slate-200 rounded-xl flex flex-col items-center justify-center shrink-0 shadow-sm ml-2">
                        <span class="text-[7px] font-black text-slate-400 uppercase leading-none mb-0.5">SỐ</span>
                        <span class="text-lg font-black text-slate-800 leading-none">${m.number || '?'}</span>
                    </div>
                `;

                // 3. XỬ LÝ ĐỘI TRƯỞNG (CHỮ C MÀU VÀNG)
                const captainBadge = (m.role === 'Đội trưởng') 
                    ? `<span class="inline-flex items-center justify-center w-5 h-5 ml-1 bg-yellow-400 text-yellow-900 text-[10px] font-black rounded-full border border-white shadow-sm" title="Đội trưởng">C</span>` 
                    : '';

                // Nút thao tác (Admin mới thấy)
                const actionButtons = isGuest ? '' : `
                    <div class="flex flex-col gap-1 justify-center ml-2 pl-2 border-l border-slate-100 shrink-0">
                        <button onclick="openMemberModal(${i})" class="w-7 h-7 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center hover:bg-blue-100"><i class="fas fa-pen text-[10px]"></i></button>
                        <button onclick="deleteMember(${i})" class="w-7 h-7 rounded-lg bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-100"><i class="fas fa-trash text-[10px]"></i></button>
                    </div>`;

                // --- GỘP HTML ---
                mc.innerHTML += `
                <div class="flex items-center p-2 bg-white rounded-2xl border border-slate-100 mb-2 shadow-sm">
                    <div class="shrink-0 relative">
                        ${avatarHtml}
                    </div>
                    
                    <div class="flex-1 min-w-0 pl-3"> 
                        <div class="flex items-center">
                            <div class="font-bold text-slate-800 text-sm truncate leading-tight">${m.name}</div>
                            ${captainBadge}
                        </div>
                        <div class="text-[11px] font-bold text-blue-600 truncate mt-1 opacity-80">${m.role}</div>
                    </div>

                    ${numberBoxHtml}

                    ${actionButtons}
                </div>`;
            });
        }
        // --- TÌM VÀ THAY THẾ HÀM createNewTeams ---
        function createNewTeams() {
            showAppPrompt("Số lượng đội bóng cần tạo thêm:", "1", (val) => {
                const count = parseInt(val);
                if (isNaN(count) || count <= 0) return;

                // Tìm số thứ tự đội lớn nhất hiện có để đặt tên (HVFC 1, HVFC 2...)
                let maxIndex = 0;
                appData.teams.forEach(t => {
                    const match = t.name.match(/HVFC (\d+)/);
                    if (match) {
                        const num = parseInt(match[1]);
                        if (num > maxIndex) maxIndex = num;
                    }
                });

                for (let i = 1; i <= count; i++) {
                    const nextNum = maxIndex + i;
                    let mems = [];

                    // --- LOGIC TẠO THÀNH VIÊN MỚI THEO YÊU CẦU ---
                    // Số 1: Đội trưởng
                    mems.push({name:'Đội Trưởng', role:'Đội trưởng', number:1});
                    // Số 2: Đội phó
                    mems.push({name:'Đội Phó', role:'Đội phó', number:2});
                    // Số 3: Thủ môn
                    mems.push({name:'Thủ Môn 1', role:'Thủ môn 1', number:3});
                    
                    // Số 4 -> 20: Cầu thủ
                    for(let j=4; j<=20; j++) {
                        mems.push({name:`Cầu thủ số ${j}`, role:'Cầu thủ', number:j});
                    }

                    appData.teams.push({
                        id: generateId(),
                        name: `HVFC ${nextNum}`,
                        shortName: `HV${nextNum}`,
                        logo: 'hvfclogo.png',
                        leader: '', // Trưởng đoàn
                        coach: '',  // THÊM: Huấn luyện viên
                        phone: '',
                        members: mems
                    });
                }
                
                saveToStorage();
                renderTeamList();
            });
        }
        function previewLogo(input) { 
        if(input.files && input.files[0]) { 
            // Nén cực mạnh: Max width 100px, chất lượng 0.5
            compressImage(input.files[0], 100, 0.5, function(base64Img) {
                document.getElementById('team-logo-preview').src = base64Img;
            });
        } 
    }
        // --- HÀM MỚI: XEM TRƯỚC LOGO GIẢI ĐẤU ---
        function previewTourLogo(input, imgId) {
        if (input.files && input.files[0]) {
            compressImage(input.files[0], 120, 0.5, function(base64Img) {
                document.getElementById(imgId).src = base64Img;
            });
        }
    }
        function saveTeam() { 
            const t = getTeam(selectedTeamId); 
            if(!t) return; 
            
            t.name = document.getElementById('team-name').value; 
            t.shortName = document.getElementById('team-short-name').value; 
            t.leader = document.getElementById('team-leader').value; 
            t.coach = document.getElementById('team-coach').value; // MỚI: Lưu tên HLV
            t.phone = document.getElementById('team-phone').value; 
            t.logo = document.getElementById('team-logo-preview').src; 
            
            saveToStorage(); 
            renderTeamList(); 
            closeMobileModal('modal-team'); 
        }
        function deleteTeamFromModal() { showAppConfirm("Xóa đội này?", "Xóa", () => { appData.teams = appData.teams.filter(t=>t.id!==selectedTeamId); saveToStorage(); renderTeamList(); closeMobileModal('modal-team'); }); }
        
        // --- TÍNH NĂNG ẢNH CẦU THỦ (V3.2025 UPDATE) ---

    // 1. Hàm xem trước ảnh khi chọn file
    function previewMemberPhoto(input) {
        if (input.files && input.files[0]) {
            compressImage(input.files[0], 80, 0.5, function(base64Img) {
                document.getElementById('mem-photo-preview').src = base64Img;
            });
        }
    }

    // 2. Cập nhật hàm Mở Modal (để load ảnh cũ lên nếu có)
    function openMemberModal(idx) { 
        editingMemberIdx = idx; 
        const t = getTeam(selectedTeamId); 
        // Lấy thông tin thành viên (nếu thêm mới thì tạo rỗng)
        const m = idx > -1 ? t.members[idx] : {name:'', number:'', role:'Cầu thủ', photo: null}; 
        
        document.getElementById('mem-name').value = m.name; 
        document.getElementById('mem-number').value = m.number; 
        document.getElementById('mem-role').value = m.role; 
        
        // Load ảnh: Nếu có ảnh thì hiện, không thì hiện ảnh mặc định
        const defaultImg = 'https://via.placeholder.com/150?text=NO+IMG';
        document.getElementById('mem-photo-preview').src = m.photo || defaultImg;
        
        // Reset input file để có thể chọn lại cùng 1 file nếu muốn
        document.getElementById('mem-photo-upload').value = '';

        openMobileModal('modal-member'); 
    }

    // 3. Cập nhật hàm Lưu (để lưu cả dữ liệu ảnh)
    function saveMember() { 
        const t = getTeam(selectedTeamId); 
        
        // Lấy dữ liệu từ form
        const name = document.getElementById('mem-name').value;
        const number = document.getElementById('mem-number').value;
        const role = document.getElementById('mem-role').value;
        
        // Lấy nguồn ảnh từ thẻ img preview (Base64)
        const photoSrc = document.getElementById('mem-photo-preview').src;
        // Kiểm tra xem có phải ảnh thật không hay là ảnh placeholder mặc định
        // Nếu là placeholder 'via.placeholder.com' thì ta coi như chưa có ảnh (null), trừ khi bạn muốn lưu placeholder
        const isPlaceholder = photoSrc.includes('via.placeholder.com');
        const finalPhoto = isPlaceholder ? null : photoSrc;

        if(!name) return showAppAlert('Lỗi', 'Vui lòng nhập tên thành viên', 'error');
        
        const m = { 
            name: name, 
            number: number, 
            role: role,
            photo: finalPhoto // Lưu chuỗi Base64 ảnh
        }; 
        
        if(editingMemberIdx > -1) {
            // Nếu đang sửa: Giữ lại các thuộc tính cũ khác nếu có, ghi đè cái mới
            t.members[editingMemberIdx] = {...t.members[editingMemberIdx], ...m};
        } else {
            t.members.push(m); 
        }
        
        saveToStorage(); 
        showTeamDetail(selectedTeamId); 
        closeMobileModal('modal-member'); 
    }

        // --- TOURNAMENT LOGIC (ADAPTED) ---
        function showTourDashboard() { 
    // Reset ID giải đấu hiện tại
    appData.currentTourId = null;
    sessionStorage.removeItem('hvfc_current_tour_id');

    // Chuyển về trang danh sách giải (Thay vì tour-dash cũ)
    switchView('tour-list');
}
        // --- 1. HÀM RENDER DANH SÁCH GIẢI (GIAO DIỆN CHI TIẾT) ---
        // --- 1. HÀM RENDER DANH SÁCH GIẢI (CẬP NHẬT: HIỆN ĐẦY ĐỦ THÔNG TIN) ---
        // --- 1. HÀM RENDER DANH SÁCH GIẢI (GIAO DIỆN CARD CÂN ĐỐI V3) ---
        // --- HÀM RENDER DANH SÁCH GIẢI (CẬP NHẬT) ---
// 1. CẬP NHẬT HÀM RENDER DANH SÁCH (DẠNG NGANG, COMPACT)
    function renderSavedTours() {
        const c = document.getElementById('top-tour-list'); 
        if (!c) return;
        c.innerHTML = '';
        
        const tours = appData.tournaments || [];
        // Đảo ngược để giải mới nhất lên đầu
        const sortedTours = [...tours].reverse(); 

        if (tours.length === 0) {
            c.innerHTML = '<div class="text-[10px] text-slate-400 italic w-full text-center py-2">Chưa có giải đấu</div>';
            return;
        }

        sortedTours.forEach(t => {
            const isActive = (t.id === appData.currentTourId);
            // Style thẻ nhỏ gọn
            const activeClass = isActive 
                ? 'bg-blue-600 text-white ring-2 ring-blue-300 shadow-md transform scale-105' 
                : 'bg-slate-50 text-slate-600 border border-slate-200 hover:bg-slate-100';
            
            const logo = t.logo || 'hvfclogo.png';

            c.innerHTML += `
            <div onclick="loadTour('${t.id}')" class="min-w-[140px] p-2 rounded-xl cursor-pointer transition-all snap-start flex flex-col items-center gap-1 ${activeClass}">
                <img src="${logo}" class="w-8 h-8 object-contain bg-white rounded-full p-0.5">
                <div class="text-[10px] font-black uppercase truncate w-full text-center leading-tight">${t.name}</div>
                <div class="text-[8px] opacity-80 font-bold">${t.format==='group'?'LEAGUE':'CÚP'}</div>
            </div>`;
        });
    }

    // 2. CẬP NHẬT HÀM LOAD TOUR (ĐỂ VẼ LẠI LIST KHI CHỌN)
    function loadTour(id) { 
        appData.currentTourId = id; 
        sessionStorage.setItem('hvfc_current_tour_id', id);
        
        // Vẽ lại danh sách để cập nhật trạng thái Active (màu xanh)
        renderSavedTours();

        // Hiển thị nội dung chi tiết
        document.getElementById('no-tour-selected-msg').classList.add('hidden');
        document.getElementById('tour-active').classList.remove('hidden');
        
        renderActiveTour(); 
    }

    // --- HÀM CHUYỂN TAB CHUẨN (FIX LỖI HIỂN THỊ VERSION & GỘP DANH SÁCH GIẢI) ---
    function switchView(view) {
        sessionStorage.setItem('hvfc_last_view', view);

        // 1. DANH SÁCH CÁC THẺ CẦN ẨN KHI CHUYỂN TAB
        // (Quan trọng: Phải liệt kê đầy đủ ID của các trang nội dung ở đây)
        const contents = [
            'content-teams', 
            'content-tour-detail', 
            'content-results', 
            'content-stats', 
            'content-version',  // <--- Đã bổ sung thẻ này để nó được ẩn đi
            'tour-create',
            'content-tour-list' // Thẻ cũ (nếu còn sót)
        ];

        // Thực hiện ẩn tất cả
        contents.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.classList.add('hidden');
        });

        // 2. Xóa trạng thái active (sáng đèn) của thanh menu
        const navs = ['nav-teams', 'nav-tour-detail', 'nav-results', 'nav-stats', 'nav-version'];
        navs.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.classList.remove('active');
        });
        
        // 3. Xử lý logic hiển thị
        let targetContent = 'content-' + view;
        
        // Fix lỗi cho code cũ nếu còn gọi 'tour-list' thì chuyển về 'tour-detail'
        if(view === 'tour-list') { 
            view = 'tour-detail'; 
            targetContent = 'content-tour-detail';
        }

        // --- LOGIC RIÊNG CHO TỪNG TAB ---

        // A. Tab Giải Đấu (Vẽ lại danh sách ngang + Chi tiết giải)
        if (view === 'tour-detail') {
            if(typeof renderSavedTours === 'function') renderSavedTours();
            
            if (!appData.currentTourId) {
                // Nếu chưa chọn giải nào
                const noMsg = document.getElementById('no-tour-selected-msg');
                const activeDiv = document.getElementById('tour-active');
                if(noMsg) noMsg.classList.remove('hidden');
                if(activeDiv) activeDiv.classList.add('hidden');
            } else {
                // Nếu đã chọn giải
                const noMsg = document.getElementById('no-tour-selected-msg');
                const activeDiv = document.getElementById('tour-active');
                if(noMsg) noMsg.classList.add('hidden');
                if(activeDiv) activeDiv.classList.remove('hidden');
                if(typeof renderActiveTour === 'function') renderActiveTour(); 
            }
        }

        // B. Tab Kết quả (Tự động chọn chế độ Nhập/Xem)
        if(view === 'results') {
            if (appData.currentTourId) {
                const mode = (currentUser === 'admin') ? 'edit' : 'view';
                if(typeof switchResultMode === 'function') switchResultMode(mode);
            } else {
                const resBody = document.getElementById('results-tbody');
                if(resBody) resBody.innerHTML = '<p class="text-center p-10 text-slate-400 italic">Vui lòng chọn giải đấu ở tab "Giải Đấu" trước.</p>';
                // Ẩn luôn danh sách xem lịch
                const schList = document.getElementById('schedule-list');
                if(schList) schList.classList.add('hidden');
            }
        }

        // C. Các tab khác (Vẽ lại dữ liệu)
        if (view === 'teams' && typeof renderTeamList === 'function') renderTeamList();
        if (view === 'stats' && typeof renderStats === 'function') renderStats();

        // 4. HIỂN THỊ THẺ ĐÍCH VÀ SÁNG ĐÈN MENU
        const contentEl = document.getElementById(targetContent);
        const navEl = document.getElementById('nav-' + view);
        
        if(contentEl) contentEl.classList.remove('hidden');
        if(navEl) navEl.classList.add('active');
    }

    // 4. THÊM HÀM XÓA GIẢI HIỆN TẠI (VÌ ĐÃ XÓA NÚT Ở TRANG LIST CŨ)
    function deleteCurrentTour() {
        if(!appData.currentTourId) return;
        const t = appData.tournaments.find(x => x.id === appData.currentTourId);
        if(!t) return;

        showAppConfirm(`Bạn có chắc chắn muốn xóa giải: ${t.name}?`, "Xóa Vĩnh Viễn", () => {
            appData.tournaments = appData.tournaments.filter(x => x.id !== appData.currentTourId);
            appData.currentTourId = null;
            sessionStorage.removeItem('hvfc_current_tour_id');
            saveToStorage();
            
            // Reset giao diện
            document.getElementById('no-tour-selected-msg').classList.remove('hidden');
            document.getElementById('tour-active').classList.add('hidden');
            renderSavedTours();
            showAppAlert("Đã xóa", "Giải đấu đã được xóa.", "success");
        });
    }

    // 5. CẬP NHẬT GO HOME
    window.goHome = function() {
        document.querySelector('.bottom-nav').classList.remove('hidden');
        document.getElementById('content-history').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
        switchView('tour-detail'); // Về thẳng trang quản lý
    }

// --- 2. XỬ LÝ KHI BẤM "CHỌN TẤT CẢ" ---
function toggleSelectAllTours() {
    const masterCheck = document.getElementById('select-all-tours');
    // Đảo ngược trạng thái hiện tại (vì ta click vào div cha)
    masterCheck.checked = !masterCheck.checked;
    
    const isChecked = masterCheck.checked;
    
    // Tìm tất cả checkbox con và gán giống trạng thái checkbox tổng
    document.querySelectorAll('.tour-select-check').forEach(c => c.checked = isChecked);
    
    updateDeleteButtonUI();
}

// --- 3. XỬ LÝ KHI BẤM 1 CHECKBOX CON (Logic thông minh) ---
function handleSingleCheck() {
    const allChecks = document.querySelectorAll('.tour-select-check');
    const checkedChecks = document.querySelectorAll('.tour-select-check:checked');
    const masterCheck = document.getElementById('select-all-tours');
    
    // Nếu số lượng đã chọn = Tổng số lượng -> Tự động tích "Chọn tất cả"
    // Ngược lại -> Bỏ tích "Chọn tất cả"
    if (allChecks.length > 0 && allChecks.length === checkedChecks.length) {
        masterCheck.checked = true;
    } else {
        masterCheck.checked = false;
    }
    
    updateDeleteButtonUI();
}

// --- 4. CẬP NHẬT GIAO DIỆN NÚT XÓA ---
function updateDeleteButtonUI() {
    const count = document.querySelectorAll('.tour-select-check:checked').length;
    const btn = document.getElementById('btn-delete-multi-tour');
    const lblCount = document.getElementById('lbl-delete-count');
    const lblSelectAll = document.getElementById('lbl-select-all');
    
    if (count > 0) {
        btn.classList.remove('hidden');
        lblCount.innerText = `Xóa (${count})`; // Hiện số lượng cần xóa
        lblSelectAll.innerText = count === document.querySelectorAll('.tour-select-check').length ? "Bỏ chọn tất cả" : "Chọn tất cả";
    } else {
        btn.classList.add('hidden');
        lblSelectAll.innerText = "Chọn tất cả";
    }
}
//Modal chuyển nhanh
function openQuickSwitchModal() {
    const list = document.getElementById('quick-switch-list');
    list.innerHTML = '';
    
    appData.tournaments.slice().reverse().forEach(t => {
        const isActive = (t.id === appData.currentTourId);
        const bgClass = isActive ? 'bg-blue-50 border-blue-500 ring-1 ring-blue-500' : 'bg-white border-slate-200 hover:border-blue-300';
        
        list.innerHTML += `
        <div onclick="quickSwitchTo('${t.id}')" class="flex items-center gap-3 p-3 rounded-xl border shadow-sm cursor-pointer transition-all ${bgClass}">
            <img src="${t.logo || 'hvfclogo.png'}" class="w-10 h-10 object-contain rounded bg-white p-0.5 border border-slate-100">
            <div class="flex-1">
                <div class="font-bold text-sm text-slate-800 uppercase leading-tight">${t.name}</div>
                <div class="text-[10px] text-slate-500">${t.format === 'group' ? 'League' : 'Knock-out'}</div>
            </div>
            ${isActive ? '<i class="fas fa-check-circle text-blue-600 text-xl"></i>' : ''}
        </div>`;
    });
    
    document.getElementById('modal-quick-switch').classList.add('open');
}

function quickSwitchTo(id) {
    if (id === appData.currentTourId) {
        document.getElementById('modal-quick-switch').classList.remove('open');
        return;
    }
    loadTour(id); // Hàm này đã có logic chuyển view và render lại
    document.getElementById('modal-quick-switch').classList.remove('open');
}
// --- 5. THỰC HIỆN XÓA ---
function deleteSelectedTours() {
    const checkedBoxes = document.querySelectorAll('.tour-select-check:checked');
    const ids = Array.from(checkedBoxes).map(c => c.value);
    
    if (ids.length === 0) return;

    showAppConfirm(
        `Bạn có chắc chắn muốn xóa vĩnh viễn ${ids.length} giải đấu đã chọn?`, 
        "XÓA NGAY", 
        () => {
            // Lọc giữ lại những giải KHÔNG nằm trong danh sách xóa
            appData.tournaments = appData.tournaments.filter(t => !ids.includes(t.id));
            saveToStorage();
            
            // Vẽ lại danh sách
            renderSavedTours();
            
            // Thông báo
            showAppAlert("Đã xóa", "Dữ liệu đã được cập nhật.", "success");
        }
    );
}
        function deleteTourFromList(id) { showAppConfirm("Xóa giải đấu này?", "Xóa", () => { appData.tournaments = appData.tournaments.filter(t=>t.id!==id); saveToStorage(); renderSavedTours(); }); }
        function showTourCreate() {
        // SỬA LỖI: Không gọi 'content-tour-list' nữa vì thẻ đó đã bị xóa
        
        // Ẩn nội dung chi tiết giải
        document.getElementById('content-tour-detail').classList.add('hidden');
        
        // Hiện Form tạo
        document.getElementById('tour-create').classList.remove('hidden');
        
        // Reset Form
        document.getElementById('new-tour-name').value = '';
        document.getElementById('new-tour-logo-preview').src = 'hvfclogo.png';
        document.getElementById('new-tour-logo-upload').value = '';
        
        // Reset biến tạm
        groupBuckets = {}; groupLimits = {};
        renderBucketAssigner();
    }
        function toggleGroupSettings() { 
    const f = document.getElementById('new-tour-format').value; 
    
    // Luôn hiện phần cài đặt nhóm (để chọn đội)
    document.getElementById('group-settings').classList.remove('hidden'); 
    
    // Chỉ ẩn/hiện phần nhập số lượng bảng và lượt đấu tùy theo thể thức
    const isGroup = (f === 'group');
    document.getElementById('turns-container').classList.toggle('hidden', !isGroup);
    
    // Nếu là Knockout, khóa số bảng về 1. Nếu là Group, cho chọn.
    const groupCountSelect = document.getElementById('new-group-count');
    if (!isGroup) {
        groupCountSelect.value = 1;
        groupCountSelect.parentElement.classList.add('hidden'); // Ẩn ô chọn số bảng đi cho gọn
    } else {
        groupCountSelect.parentElement.classList.remove('hidden');
    }

    renderBucketAssigner(); 
}
        
        // Bucket Logic Simplified
        function renderBucketAssignerBase(prefix, buckets, countId) {
            const num = parseInt(document.getElementById(countId).value); const c = document.getElementById(prefix+'bucket-assigner'); const t = document.getElementById(prefix+'bucket-targets');
            const fmt = document.getElementById(prefix === 'edit-' ? 'edit-tour-format' : 'new-tour-format').value;
            if(fmt!=='group' && num < 2) { c.classList.add('hidden'); return; }
            c.classList.remove('hidden'); t.innerHTML='';
            for(let i=0; i<num; i++) { if(!buckets[i]) buckets[i]=[]; t.innerHTML+=`<div class="bg-white p-2 rounded border"><h6 class="text-xs font-bold text-blue-600">BẢNG ${String.fromCharCode(65+i)}</h6><div id="${prefix}bkt-${i}" class="min-h-[20px]"></div></div>`; }
            let tIds = []; if(prefix==='') tIds = Array.from(document.querySelectorAll('.tour-check:checked')).map(c=>c.value); else { const tour = appData.tournaments.find(x=>x.id===appData.currentTourId); tIds = tour?tour.teamIds:[]; }
            const src = document.getElementById(prefix+'bucket-source'); src.innerHTML='';
            tIds.forEach(tid => {
                const tm = getTeam(tid); if(!tm) return;
                let assigned = false; for(let k in buckets) if(buckets[k].includes(tid)) assigned=true;
                if(!assigned) {
                     let btns = ''; for(let i=0; i<num; i++) btns+=`<button onclick="assign('${tid}',${i},'${prefix}')" class="bg-slate-200 px-2 py-1 rounded ml-1 font-bold">${String.fromCharCode(65+i)}</button>`;
                     src.innerHTML+=`<div class="flex justify-between items-center py-1 border-b text-xs"><span>${tm.name}</span><div>${btns}</div></div>`;
                }
            });
            for(let k in buckets) { const d = document.getElementById(`${prefix}bkt-${k}`); if(d) { d.innerHTML=''; buckets[k].forEach(tid=>{ const tm=getTeam(tid); if(tm) d.innerHTML+=`<div class="flex justify-between text-xs bg-slate-50 p-1 mb-1 rounded"><span>${tm.name}</span><button onclick="unassign('${tid}',${k},'${prefix}')" class="text-red-500 font-bold">x</button></div>`; }); } }
        }
        window.assign = function(tid, bIdx, pre='') { const b = pre==='edit-'?editGroupBuckets:groupBuckets; b[bIdx].push(tid); renderBucketAssignerBase(pre,b,pre+'group-count'); }
        window.unassign = function(tid, bIdx, pre='') { const b = pre==='edit-'?editGroupBuckets:groupBuckets; b[bIdx] = b[bIdx].filter(x=>x!==tid); renderBucketAssignerBase(pre,b,pre+'group-count'); }
        // --- LOGIC PHÂN BẢNG MỚI (CỘT & FILTER ĐỘI) ---

// Hàm vẽ giao diện phân bảng
function renderBucketAssigner() {
    renderModernBucketAssigner('', groupBuckets, 'new-group-count');
}

function renderEditBucketAssigner() {
    renderModernBucketAssigner('edit-', editGroupBuckets, 'edit-group-count');
}

// --- CẬP NHẬT: GIAO DIỆN CHỌN ĐỘI CÓ ĐÁNH SỐ THỨ TỰ (SEEDING) ---
function renderModernBucketAssigner(prefix, buckets, countId) {
    const num = parseInt(document.getElementById(countId).value); 
    
    const c = document.getElementById(prefix+'bucket-assigner'); 
    const t = document.getElementById(prefix+'bucket-targets');
    const fmt = document.getElementById(prefix === 'edit-' ? 'edit-tour-format' : 'new-tour-format').value;

    c.classList.remove('hidden'); 
    
    // Ẩn nguồn cũ
    const oldSource = document.getElementById(prefix+'bucket-source');
    if(oldSource) oldSource.classList.add('hidden');
    
    // Nếu chưa chọn số bảng
    if (num === 0 || isNaN(num)) {
        t.className = "col-span-2";
        t.innerHTML = '<div class="text-center text-slate-400 text-xs italic py-8 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50">Vui lòng chọn <b>Số Bảng đấu</b> ở trên để bắt đầu xếp đội.</div>';
        return; 
    }

    t.className = (num === 1) ? "grid grid-cols-1 gap-3" : "grid grid-cols-2 gap-3";
    t.innerHTML = '';

    const allTeams = appData.teams;

    for(let i=0; i<num; i++) {
        if(!buckets[i]) buckets[i] = [];
        if(!groupLimits[prefix+i]) groupLimits[prefix+i] = 0; 
        const currentLimit = groupLimits[prefix+i];
        
        let teamListHTML = '';
        if (currentLimit > 0) {
             teamListHTML = `<div class="mt-2 max-h-60 overflow-y-auto border-t border-slate-100 pt-1 space-y-1">`;
             
             // Sắp xếp danh sách: Đưa các đội ĐÃ CHỌN lên đầu để dễ nhìn thứ tự
             // Copy danh sách team để không ảnh hưởng gốc
             const sortedTeams = [...allTeams].sort((a,b) => {
                 const aSelected = buckets[i].includes(a.id);
                 const bSelected = buckets[i].includes(b.id);
                 // Đội đã chọn lên trên
                 if (aSelected && !bSelected) return -1;
                 if (!aSelected && bSelected) return 1;
                 // Nếu cùng chọn, đội nào có index nhỏ hơn (chọn trước) thì lên trên
                 if (aSelected && bSelected) {
                     return buckets[i].indexOf(a.id) - buckets[i].indexOf(b.id);
                 }
                 return 0;
             });

             sortedTeams.forEach(tm => {
                let isTakenInOtherGroup = false;
                // Kiểm tra xem đội này có nằm ở bảng KHÁC không
                for(let k=0; k<num; k++) {
                    if (k !== i && buckets[k] && buckets[k].includes(tm.id)) { isTakenInOtherGroup = true; break; }
                }

                if (!isTakenInOtherGroup) {
                    // Kiểm tra vị trí trong bảng hiện tại
                    const positionIndex = buckets[i].indexOf(tm.id);
                    const isChecked = positionIndex !== -1;
                    
                    // Style hiển thị
                    const highlight = isChecked ? 'bg-blue-50 border-blue-300 shadow-sm' : 'bg-white border-transparent opacity-80 hover:opacity-100';
                    const nameStyle = isChecked ? 'font-bold text-blue-900' : 'font-medium text-slate-600';
                    
                    // TẠO BADGE SỐ THỨ TỰ (QUAN TRỌNG)
                    // Nếu được chọn, hiện số (positionIndex + 1). Nếu không, hiện ô trống.
                    const numberBadge = isChecked 
                        ? `<div class="w-6 h-6 rounded-full bg-blue-600 text-white text-[10px] font-black flex items-center justify-center shadow-md border-2 border-white absolute right-2 top-1/2 -translate-y-1/2 transition-transform transform scale-100">${positionIndex + 1}</div>`
                        : `<div class="w-5 h-5 rounded-full border-2 border-slate-200 absolute right-2 top-1/2 -translate-y-1/2"></div>`;

                    teamListHTML += `
                    <label class="relative flex items-center gap-2 p-2 rounded border ${highlight} cursor-pointer transition-all select-none group">
                        <input type="checkbox" class="absolute opacity-0 w-0 h-0" ${isChecked ? 'checked' : ''} onchange="toggleTeamInGroup('${tm.id}', ${i}, '${prefix}', this.checked)">
                        
                        <img src="${tm.logo||'hvfclogo.png'}" class="w-8 h-8 object-contain bg-white rounded-full border border-slate-100 p-0.5">
                        
                        <div class="flex-1 min-w-0 pr-8">
                            <div class="text-xs ${nameStyle} truncate">${tm.name}</div>
                            ${isChecked ? `<div class="text-[9px] text-blue-500 font-bold">Mã số: ${positionIndex + 1}</div>` : ''}
                        </div>
                        
                        ${numberBadge}
                    </label>`;
                }
             });
             teamListHTML += `</div>`;
        } else {
            teamListHTML = `<div class="text-xs text-slate-400 italic text-center py-6">Nhập số lượng đội để bắt đầu chọn.</div>`;
        }

        let boxTitle = `BẢNG ${String.fromCharCode(65+i)}`;
        if (num === 1) boxTitle = "DANH SÁCH ĐỘI (LEAGUE)";

        t.innerHTML += `
        <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden flex flex-col h-full">
            <div class="bg-slate-100 p-3 border-b border-slate-200 flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <span class="font-black text-blue-800 text-sm uppercase">${boxTitle}</span>
                    <span class="text-xs font-bold ${buckets[i].length === currentLimit ? 'text-green-600' : 'text-red-500'}">
                        ${buckets[i].length}/${currentLimit}
                    </span>
                </div>
                <div class="flex items-center gap-2 bg-white rounded border border-slate-300 px-2 py-1">
                    <span class="text-[10px] text-slate-400 font-bold whitespace-nowrap uppercase">Số lượng:</span>
                    <input type="number" value="${currentLimit === 0 ? '' : currentLimit}" placeholder="0" class="w-full text-sm font-bold text-center outline-none h-6" onchange="updateGroupLimit(${i}, '${prefix}', this.value)">
                </div>
            </div>
            <div class="p-2 bg-slate-50 flex-1">${teamListHTML}</div>
            ${buckets[i].length > 0 ? '<div class="px-2 py-1 bg-blue-50 text-[9px] text-center text-blue-400 italic font-bold border-t border-blue-100">* Bỏ chọn và chọn lại để đổi số thứ tự</div>' : ''}
        </div>`;
    }
}

// Hàm cập nhật giới hạn đội
window.updateGroupLimit = function(groupIndex, prefix, val) {
    const limit = parseInt(val);
    if(limit < 0) return;
    groupLimits[prefix+groupIndex] = limit;
    // Render lại để hiện danh sách hoặc cập nhật cảnh báo
    if(prefix === 'edit-') renderEditBucketAssigner();
    else renderBucketAssigner();
}

// Hàm xử lý chọn đội (Độc quyền: Chọn A thì mất ở B)
window.toggleTeamInGroup = function(teamId, groupIndex, prefix, isChecked) {
    const b = prefix === 'edit-' ? editGroupBuckets : groupBuckets;
    if(!b[groupIndex]) b[groupIndex] = [];

    if(isChecked) {
        // Kiểm tra xem đã đủ số lượng chưa
        const limit = groupLimits[prefix+groupIndex] || 0;
        if (b[groupIndex].length >= limit) {
            // Nếu vượt quá, bỏ check và cảnh báo nhẹ (hoặc chỉ return false)
             // Ở đây ta cho phép check nhưng khi Save sẽ báo lỗi (theo yêu cầu đề bài), 
             // nhưng UX tốt hơn là chặn luôn. Tuy nhiên theo đúng đề bài "cảnh báo khi nhập sai",
             // ta cứ cho chọn, rồi hàm startTournament sẽ bắt lỗi.
             b[groupIndex].push(teamId);
        } else {
             b[groupIndex].push(teamId);
        }
    } else {
        b[groupIndex] = b[groupIndex].filter(id => id !== teamId);
    }

    // Render lại TẤT CẢ các bảng để cập nhật việc ẩn/hiện đội ở bảng khác
    if(prefix === 'edit-') renderEditBucketAssigner();
    else renderBucketAssigner();
}

        function startTournament() {
            // --- CHẶN KHÁCH ---
            if (currentUser !== 'admin') {
                return showAppAlert("Cảnh báo", "Chế độ Khách không được phép tạo giải đấu!", "error");
            }
            // ------------------

            const name = document.getElementById('new-tour-name').value;
            // ... (Giữ nguyên phần còn lại bên dưới)
            const organizer = document.getElementById('new-tour-organizer').value || 'BTC';
            const phone = document.getElementById('new-tour-phone').value || '';
            const location = document.getElementById('new-tour-location').value || 'Sân bóng Hòa Vang';
            
            // --- KHẮC PHỤC LỖI Ở ĐÂY: Lấy giá trị điểm thẻ đỏ ---
            const redWeight = parseInt(document.getElementById('new-tour-red-weight').value) || 3; 
            // ----------------------------------------------------

            if(!name) return showAppAlert('Lỗi','Nhập tên giải','error');

            const format = document.getElementById('new-tour-format').value;
            // Nếu là Knockout thì ép số bảng về 1 để logic dưới chạy đúng
            const groupCount = (format === 'knockout') ? 1 : parseInt(document.getElementById('new-group-count').value);
            
            let allSelectedIds = [];
            
            // Gom ID và Kiểm tra số lượng
            for(let i=0; i<groupCount; i++) {
                const limit = groupLimits[''+i] || 0;
                const currentSelected = groupBuckets[i] ? groupBuckets[i].length : 0;
                
                // Nếu chưa nhập limit hoặc chọn sai số lượng
                if (limit === 0 || currentSelected !== limit) {
                    const groupName = (groupCount === 1) ? '' : `tại Bảng ${String.fromCharCode(65+i)}`;
                    return showAppAlert(
                        'Cảnh báo', 
                        `Số đội bạn chọn ${groupName} chưa đúng (Yêu cầu: ${limit}, Đã chọn: ${currentSelected}).\n\nVui lòng kiểm tra lại!`, 
                        'error'
                    );
                }
                if(groupBuckets[i]) allSelectedIds = allSelectedIds.concat(groupBuckets[i]);
            }

            if(allSelectedIds.length < 2) return showAppAlert('Lỗi','Cần ít nhất 2 đội để tạo giải','error');
            
            // Lấy Logo từ ảnh preview
            const tourLogo = document.getElementById('new-tour-logo-preview').src;

            const t = { 
                id: generateId(), 
                name: name.toUpperCase(), 
                organizer: organizer, 
                phone: phone,        
                location: location,   
                logo: tourLogo,
                format: format, 
                teamIds: allSelectedIds,
                data: {}, 
                config: { 
                    groupCount: groupCount, 
                    turns: parseInt(document.getElementById('new-tour-turns').value), 
                    buckets: JSON.parse(JSON.stringify(groupBuckets)),
                    
                    // Lưu bộ luật xếp hạng
                    rankingRules: JSON.parse(JSON.stringify(currentRankingRules)), 
                    // Lưu cấu hình thẻ đỏ (Biến này giờ đã có giá trị)
                    redCardPoint: redWeight,
                }, 
                startDate: document.getElementById('new-tour-start').value, 
                endDate: document.getElementById('new-tour-end').value 
            };

            initializeTournamentData(t, groupBuckets); 
            appData.tournaments.push(t); 
            saveToStorage(); 
            
            // Reset form sau khi tạo thành công
            groupBuckets = {}; groupLimits = {};
            document.getElementById('new-tour-organizer').value = '';
            document.getElementById('new-tour-phone').value = '';
            document.getElementById('new-tour-location').value = '';
            
            // Chuyển hướng
            loadTour(t.id);
            showAppAlert("Thành công", "Đã khởi tạo giải đấu mới!", "success");
        }

        // --- BƯỚC 3: KHỞI TẠO GIẢI ĐẤU (HỖ TRỢ LẺ ĐỘI TỰ ĐỘNG NGAY VÒNG 1) ---
function initializeTournamentData(tour, buckets) {
    const num = tour.config.groupCount; 
    const turns = tour.config.turns || 1;
    const b = buckets || tour.config.buckets;

    if(tour.format === 'knockout') {
        tour.data = { matches: [], round: 1, byes: {} };
        tour.data.byes[1] = []; // Khởi tạo bye vòng 1
        
        // Lấy danh sách đội tham gia
        const all = tour.teamIds.map(id => getTeam(id));
        const count = all.length;

        // Logic đặt tên vòng 1
        let rLbl = "Vòng 1";
        let mPre = "Trận";
        if(count === 2) { rLbl = "CHUNG KẾT"; mPre = ""; }
        else if(count <= 4) { rLbl = "VÒNG BÁN KẾT"; mPre = "Bán kết"; }
        else if(count <= 8) { rLbl = "VÒNG TỨ KẾT"; mPre = "Tứ kết"; }

        let matchCnt = 1;
        
        for(let i=0; i<all.length; i+=2) {
            if(i+1 < all.length) {
                // Đủ cặp
                let mName = count===2 ? "TRANH CÚP VÔ ĐỊCH" : `${mPre} ${matchCnt}`;
                tour.data.matches.push(createMatch(
                    all[i].id, 
                    all[i+1].id, 
                    1, 
                    mName,
                    rLbl
                ));
                matchCnt++;
            } else {
                // Lẻ đội -> Bye
                tour.data.byes[1].push(all[i].id);
            }
        }
        
        // Vòng tiếp theo sẽ là 2
        tour.data.round = 2;

    } else {
        // (Giữ nguyên logic tạo vòng bảng)
        tour.data.groups = [];
        for(let i=0; i<num; i++) {
            tour.data.groups.push({ 
                name: String.fromCharCode(65+i), 
                matches: createGroupMatches(b[i]||[], turns) 
            });
        }
    }
}
        function createMatch(t1, t2, r, name, roundLbl) { return { id: generateId(), t1, t2, s1:null, s2:null, p1:null, p2:null, events:[], isLive:false, date:'', time:'', venue:'', round: r, name: name, roundLabel: roundLbl || `Vòng ${r}` }; }
        
        // BERGER LOGIC (Correct Round Robin)
        function createGroupMatches(ids, turns) { 
            let teams = [...ids]; if (teams.length % 2 !== 0) teams.push(null);
            const n = teams.length; const roundsPerTurn = n - 1; const matches = [];
            for (let turn = 0; turn < turns; turn++) {
                let roundTeams = [...teams];
                for (let r = 0; r < roundsPerTurn; r++) {
                    const currentRound = r + 1 + (turn * roundsPerTurn);
                    for (let i = 0; i < n / 2; i++) {
                        const t1 = roundTeams[i]; const t2 = roundTeams[n - 1 - i];
                        if (t1 && t2) {
                            const home = turn % 2 === 0 ? t1 : t2; const away = turn % 2 === 0 ? t2 : t1;
                            matches.push(createMatch(home, away, currentRound, '', `Vòng ${currentRound}`));
                        }
                    }
                    roundTeams.splice(1, 0, roundTeams.pop());
                }
            }
            return matches;
        }

        function loadTour(id) { 
    appData.currentTourId = id; 
    
    // Lưu session
    sessionStorage.setItem('hvfc_current_tour_id', id);

    // --- LOGIC MỚI V4: CHUYỂN NGAY SANG TAB CHI TIẾT ---
    switchView('tour-detail');

    // Hiển thị thông báo nhỏ (Toast)
    const toast = document.createElement('div');
    toast.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black/80 text-white px-4 py-2 rounded-xl text-xs font-bold z-[9999] animate-fade-in';
    toast.innerHTML = '<i class="fas fa-check-circle text-green-400 mr-2"></i> Đã chọn giải đấu!';
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 1000);
}
// --- 2. HÀM HIỂN THỊ CHI TIẾT GIẢI (HEADER ĐẦY ĐỦ) ---
// --- 2. HÀM HIỂN THỊ CHI TIẾT GIẢI (CẬP NHẬT: CÓ LOGO GIẢI Ở HEADER) ---
function renderActiveTour() {
    const t = appData.tournaments.find(x => x.id === appData.currentTourId);
    if (!t) return;

    document.getElementById('tour-create').classList.add('hidden');
    document.getElementById('tour-active').classList.remove('hidden');
    
    // --- CẬP NHẬT HEADER VỚI LOGO ---
    // --- CẬP NHẬT HEADER VỚI LOGO (CÁCH ỔN ĐỊNH HƠN) ---
    // 1. Cập nhật tên giải
    document.getElementById('active-tour-title').innerText = t.name;
    document.getElementById('active-tour-title').className = "text-lg font-black uppercase leading-tight pt-1 break-words text-white";

    // 2. Cập nhật ảnh Logo vào thẻ có sẵn (Không vẽ lại HTML)
    const logoImg = document.getElementById('header-tour-logo');
    if (logoImg) {
        // Nếu giải đấu có logo thì hiện, không có thì hiện logo mặc định
        logoImg.src = t.logo || 'hvfclogo.png';
    }
    // --------------------------------

    // Tạo thông tin chi tiết HTML
    const location = t.location || 'Chưa cập nhật sân';
    const organizer = t.organizer || 'Chưa cập nhật BTC';
    const phone = t.phone || '---';
    const formatName = t.format === 'group' ? 'Đấu Bảng (League)' : 'Đấu Cúp (Knock-out)';
    
    const infoHtml = `
    <div class="grid grid-cols-2 gap-x-4 gap-y-2 mt-3 pt-3 border-t border-blue-800/30">
        <div class="flex items-center gap-2 text-[10px] text-blue-200">
            <i class="fas fa-calendar-alt w-3 text-center"></i>
            <span>${formatDate(t.startDate)} - ${formatDate(t.endDate)}</span>
        </div>
        <div class="flex items-center gap-2 text-[10px] text-blue-200">
            <i class="fas fa-sitemap w-3 text-center"></i>
            <span>${formatName}</span>
        </div>
        <div class="flex items-center gap-2 text-[10px] text-blue-200">
            <i class="fas fa-user-tie w-3 text-center"></i>
            <span class="truncate">BTC: ${organizer}</span>
        </div>
        <div class="flex items-center gap-2 text-[10px] text-blue-200">
            <i class="fas fa-phone w-3 text-center"></i>
            <span>${phone}</span>
        </div>
        <div class="col-span-2 flex items-center gap-2 text-[10px] text-blue-200">
            <i class="fas fa-map-marker-alt w-3 text-center text-red-400"></i>
            <span class="truncate font-bold text-white">${location}</span>
        </div>
    </div>`;

    document.getElementById('active-tour-info').innerHTML = infoHtml;
    
    // --- CÁC PHẦN DƯỚI GIỮ NGUYÊN ---
    document.getElementById('tour-standings-preview').classList.remove('hidden');
    const dashboardContent = document.getElementById('tour-standings-content');
    dashboardContent.innerHTML = ''; 

    let isTournamentFinished = false;  
    let showDrawButton = false;        
    const knMatches = t.format === 'knockout' ? t.data.matches : (t.data.knockoutMatches || []);
    if (knMatches.length > 0) {
        const maxR = Math.max(...knMatches.map(m => m.round));
        const currentRoundMatches = knMatches.filter(m => m.round === maxR);
        const isRoundFinished = currentRoundMatches.every(m => m.s1 !== null && m.s2 !== null);
        const hasBye = t.data.byes && t.data.byes[maxR] && t.data.byes[maxR].length > 0;
        const isFinalMatchName = currentRoundMatches.some(m => m.name === 'TRANH CÚP VÔ ĐỊCH');
        const isFinalLabel = currentRoundMatches.some(m => m.roundLabel === 'CHUNG KẾT' || m.roundLabel === 'CHUNG KẾT & HẠNG 3');
        if (isRoundFinished) {
            if (isFinalMatchName || (isFinalLabel && !hasBye)) { isTournamentFinished = true; showDrawButton = false; } 
            else { isTournamentFinished = false; showDrawButton = true; }
        } else { isTournamentFinished = false; showDrawButton = false; }
    } else if (t.format === 'group') {
        const group = t.data.groups[0];
        isTournamentFinished = t.data.groups.every(g => g.matches.every(m => m.s1 !== null && m.s2 !== null));
        if(t.data.knockoutMatches && t.data.knockoutMatches.length > 0) isTournamentFinished = false;
        showDrawButton = false; 
    } else if (t.format === 'knockout' && knMatches.length === 0) { showDrawButton = true; }

    if (isTournamentFinished) {
        const fullStats = renderStats(true);
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = fullStats;
        const podium = tempDiv.querySelector('.relative.mb-6'); 
        if (podium) {
            dashboardContent.appendChild(podium);
            dashboardContent.innerHTML += `<div class="text-center text-xs font-bold text-blue-600 uppercase mt-2 mb-4 animate-pulse">🎉 Mùa giải đã khép lại thành công tốt đẹp! 🎉</div>`;
        } else {
            dashboardContent.innerHTML = `<div class="text-center text-slate-500 italic mb-4">Giải đấu đã kết thúc. Xem chi tiết ở tab Thống Kê.</div>`;
        }
    } else {
        renderNextMatchWidget(t, dashboardContent);
        renderDashboardSuspensions(t, dashboardContent);
        dashboardContent.innerHTML += `<hr class="border-slate-200 border-dashed my-4 mx-2">`;
    }

    const isGuest = (currentUser === 'guest');
    
    const groupToKnockoutArea = document.getElementById('group-to-knockout-area');
    const isGrp = t.format === 'group';
    const hasKoData = knMatches.length > 0;
    const groupCount = (t.config && t.config.groupCount) ? t.config.groupCount : 1;
    const showAdvanceBtn = isGrp && !hasKoData && groupCount > 1;
    
    groupToKnockoutArea.classList.toggle('hidden', isGuest || !showAdvanceBtn);

    const btnDrawContainer = document.getElementById('knockout-actions');
    btnDrawContainer.classList.toggle('hidden', isGuest || !showDrawButton);
    
    if(!isGuest && showDrawButton) {
        const btnText = btnDrawContainer.querySelector('button');
        if(btnText) {
             const maxR = knMatches.length > 0 ? Math.max(...knMatches.map(m => m.round)) : 0;
             const lastRoundMatches = knMatches.filter(m => m.round === maxR);
             const teamsInLastRound = (lastRoundMatches.length * 2) + ((t.data.byes && t.data.byes[maxR]) ? t.data.byes[maxR].length : 0);
             if (teamsInLastRound === 3 || teamsInLastRound === 4) {
                 btnText.innerHTML = '<i class="fas fa-trophy"></i> Tạo Trận Chung Kết';
                 btnText.className = "app-btn bg-yellow-500 text-yellow-900 shadow-lg font-black";
             } else {
                 btnText.innerHTML = '<i class="fas fa-random"></i> Bốc Thăm Vòng Sau';
                 btnText.className = "app-btn bg-red-600 text-white shadow-lg";
             }
        }
    }

    renderBrackets(t);
}

        // --- RESULTS RENDER (MOBILE CARD STYLE) ---
        // --- TÌM VÀ THAY THẾ TOÀN BỘ HÀM renderResultsTable ---
        // --- BƯỚC 1: HIỂN THỊ TÊN TRẬN KNOCK-OUT CHUẨN XÁC TRONG LIST ---
// --- BƯỚC 1: HIỂN THỊ DANH SÁCH TRẬN ĐẤU (CÓ ĐÁNH SỐ THỨ TỰ TRẬN #1, #2...) ---
// --- CẬP NHẬT: NHẬP SÂN THÔNG MINH (CHỈ CẦN NHẬP MÃ SÂN) ---
// --- CẬP NHẬT: NHẬP SÂN VIẾT HOA TỰ ĐỘNG ---
function renderResultsTable(editable) {
    const c = editable ? document.getElementById('results-tbody') : document.getElementById('schedule-list');
    c.innerHTML = '';
    
    if(!appData.currentTourId) { 
        c.innerHTML='<p class="text-center p-8 italic text-slate-400">Vui lòng chọn giải đấu trước.</p>'; return; 
    }
    
    const t = appData.tournaments.find(x=>x.id===appData.currentTourId);
    // Lấy địa điểm tổ chức giải (đã khai báo ở phần tạo giải)
    const tourLocation = t.location || ''; 

    let matches = [];

    // 1. Thu thập dữ liệu
    try {
        if(t.format==='group') { 
            if (t.data.groups) {
                matches = t.data.groups.flatMap(g=>g.matches.map(m=>({...m, grp:g.name, sortG:g.name, sortR:m.round||0}))); 
            }
            if(t.data.knockoutMatches) {
                matches = matches.concat(t.data.knockoutMatches.map(m=>({...m, grp:'Knockout', sortG:'Z', sortR:m.round||999}))); 
            }
        } else { 
            matches = t.data.matches.map(m=>({...m, grp:'Knockout', sortG:'A', sortR:m.round}));
        }
    } catch (e) { console.error("Lỗi dữ liệu giải:", e); }

    // 2. Sắp xếp
    matches.sort((a,b) => a.sortG.localeCompare(b.sortG) || a.sortR - b.sortR || (a.date||'').localeCompare(b.date||'') || (a.time||'').localeCompare(b.time||''));
    
    let currSec = '';
    
    matches.forEach((m,i) => {
        try {
            const t1 = getTeam(m.t1); 
            const t2 = getTeam(m.t2);
            if (!t1 || !t2) return; 

            const matchOrder = i + 1;

            // --- HEADER SECTION ---
            let secLbl = '';
            if (m.grp === 'Knockout') {
                secLbl = m.roundLabel || 'Vòng Knock-out';
            } else {
                secLbl = `Bảng ${m.grp} - ${m.roundLabel||''}`;
            }

            if(secLbl !== currSec) { 
                currSec = secLbl;
                let themeClass = 'bg-slate-100 text-slate-700 border-slate-500';
                if (m.grp === 'Knockout') themeClass = 'bg-red-100 text-red-800 border-red-600';
                else if (['A','C','E','G'].includes(m.grp)) themeClass = 'bg-blue-100 text-blue-800 border-blue-600';
                else themeClass = 'bg-green-100 text-green-800 border-green-600';
                
                c.innerHTML += `<div class="sticky top-0 z-20 ${themeClass} px-3 py-2 text-xs font-black uppercase tracking-wider border-l-4 shadow-sm mb-1 mt-4 first:mt-0 flex justify-between items-center"><span>${currSec}</span></div>`; 
            }
                
            // Chuẩn bị dữ liệu hiển thị
            const s1_h1 = (m.s1_h1!==null && m.s1_h1!==undefined) ? m.s1_h1 : '';
            const s2_h1 = (m.s2_h1!==null && m.s2_h1!==undefined) ? m.s2_h1 : '';
            const s1_h2 = (m.s1_h2!==null && m.s1_h2!==undefined) ? m.s1_h2 : '';
            const s2_h2 = (m.s2_h2!==null && m.s2_h2!==undefined) ? m.s2_h2 : '';
            
            let totalS1 = m.s1 !== null ? m.s1 : '-';
            let totalS2 = m.s2 !== null ? m.s2 : '-';
            
            const isLive = m.isLive ? '<span class="live-badge animate-blink">● LIVE</span>' : '';
            const ftBadge = m.isFullTime ? '<span class="bg-slate-800 text-white text-[9px] font-black px-1 py-0.5 rounded ml-1">FT</span>' : '';
            const pen = (m.p1!==null&&m.p2!==null)?`<div class="text-[10px] text-purple-600 font-bold mt-1">Pen: ${m.p1}-${m.p2}</div>`:'';

            const matchNameDisplay = m.name ? `<div class="text-[10px] text-slate-500 font-bold uppercase tracking-widest text-center mb-1 bg-slate-50 rounded py-0.5 border border-slate-100">${m.name}</div>` : '';

            // Render Events Helper
            const getEventsByHalf = (teamId, half) => {
                if (!m.events || m.events.length === 0) return '';
                const evts = m.events.filter(e => e.teamId === teamId && e.half === half);
                if (evts.length === 0) return '';
                return evts.map(e => {
                    let icon = e.type === 'goal' ? '<i class="fas fa-futbol text-green-600"></i>' : (e.type === 'yellow' ? '<i class="fas fa-square text-yellow-400"></i>' : '<i class="fas fa-square text-red-600"></i>');
                    return `<div class="flex items-center gap-1 text-[9px] text-slate-600 leading-tight"><span>${icon}</span><span class="truncate max-w-[80px]">${e.player}</span></div>`;
                }).join('');
            };
            const evtT1_H1 = getEventsByHalf(m.t1, 'h1'); const evtT1_H2 = getEventsByHalf(m.t1, 'h2');
            const evtT2_H1 = getEventsByHalf(m.t2, 'h1'); const evtT2_H2 = getEventsByHalf(m.t2, 'h2');
            const renderTeamEvents = (h1Evt, h2Evt) => {
                let html = '';
                if(h1Evt) html += `<div class="mb-1 pb-1 border-b border-dashed border-slate-200"><span class="text-[8px] font-bold text-slate-400 uppercase">Hiệp 1</span>${h1Evt}</div>`;
                if(h2Evt) html += `<div><span class="text-[8px] font-bold text-slate-400 uppercase">Hiệp 2</span>${h2Evt}</div>`;
                return html;
            };

            // --- RENDER GIAO DIỆN ---
            if(editable) {
                // ADMIN MODE
                const timeOptions = typeof getTimeOptionsHTML === 'function' ? getTimeOptionsHTML(m.time) : `<option value="${m.time}">${m.time}</option>`;
                const disabledAttr = m.isFullTime ? 'disabled' : '';
                const opacityClass = m.isFullTime ? 'opacity-50 pointer-events-none grayscale' : '';
                const lockIcon = m.isFullTime ? '<i class="fas fa-lock text-red-500 mr-1"></i>' : '';
                
                let actionBtn = !m.isFullTime 
                    ? `<button onclick="toggleMatchStatus('${m.id}')" class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 rounded shadow-sm uppercase"><i class="fas fa-whistle mr-1"></i> Hết Giờ (Full-time)</button>`
                    : `<button onclick="toggleMatchStatus('${m.id}')" class="w-full mt-2 bg-white border border-slate-300 text-slate-600 hover:text-blue-600 text-xs font-bold py-2 rounded shadow-sm uppercase"><i class="fas fa-pen mr-1"></i> Chỉnh sửa kết quả</button>`;
                
                c.innerHTML += `
                <div class="match-card-edit ${m.isFullTime ? 'border-l-4 border-l-slate-400' : ''}">
                    <div class="match-edit-header bg-slate-50 p-2 flex flex-col gap-2 border-b border-slate-200">
                        <div class="flex justify-between items-center w-full">
                            <div class="flex items-center gap-2">
                                ${lockIcon}
                                <div class="bg-blue-600 text-white text-[10px] font-black px-1.5 py-0.5 rounded shadow-sm mr-1">#${matchOrder}</div>
                                <div class="text-xs font-black text-slate-700 uppercase">${m.name || m.roundLabel || 'Vòng ' + m.round}</div>
                            </div>
                            <div class="flex items-center gap-1 bg-white border border-slate-300 rounded-lg px-2 py-1 shadow-sm">
                                <input type="date" class="text-xs font-bold text-slate-700 outline-none bg-transparent p-0" value="${m.date||''}" onchange="updateM('${m.id}','date',this.value)" ${disabledAttr}>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-1 w-full bg-white border border-slate-200 rounded px-2 py-1">
                            <span class="text-[10px] font-bold text-slate-400 uppercase whitespace-nowrap">Sân</span>
                            <input type="text" class="text-xs font-black text-blue-700 w-full outline-none bg-transparent text-center border-b border-dashed border-slate-300 focus:border-blue-500" 
                                placeholder="Nhập số (VD: 1, A)" 
                                value="${m.venue || ''}" 
                                oninput="this.value = this.value.toUpperCase()" 
                                onchange="updateM('${m.id}','venue',this.value)" 
                                ${disabledAttr}>
                            <span class="text-[9px] font-bold text-slate-400 whitespace-nowrap truncate max-w-[120px]">- ${tourLocation}</span>
                        </div>
                    </div>

                    <div class="match-edit-body p-3">
                        <div class="${opacityClass} transition-all duration-300">
                            <div class="flex justify-center items-center gap-3 mb-3">
                                <span class="font-black text-2xl text-blue-700">${totalS1}</span><span class="font-bold text-slate-300 text-lg">-</span><span class="font-black text-2xl text-red-700">${totalS2}</span>
                            </div>
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex flex-col items-center w-[35%]"><img src="${t1.logo||'hvfclogo.png'}" class="w-10 h-10 object-contain mb-1"><span class="text-xs font-bold text-center truncate w-full leading-tight mb-2">${t1.shortName}</span><div class="w-full bg-slate-50 rounded p-1">${renderTeamEvents(evtT1_H1, evtT1_H2)}</div></div>
                                <div class="flex flex-col items-center justify-start w-[30%] gap-2 pt-1">
                                    <div class="flex items-center gap-1 relative group"><div class="absolute -left-6 text-[9px] font-bold text-slate-400 w-5 text-right">H1</div><input type="number" class="w-8 h-8 text-center text-sm font-bold bg-white border border-slate-300 rounded outline-none" placeholder="-" value="${s1_h1}" onclick="openEventModal('${m.id}', 'h1')" readonly><span class="text-slate-300">:</span><input type="number" class="w-8 h-8 text-center text-sm font-bold bg-white border border-slate-300 rounded outline-none" placeholder="-" value="${s2_h1}" onclick="openEventModal('${m.id}', 'h1')" readonly></div>
                                    <div class="flex items-center gap-1 relative group"><div class="absolute -left-6 text-[9px] font-bold text-slate-400 w-5 text-right">H2</div><input type="number" class="w-8 h-8 text-center text-sm font-bold bg-white border border-slate-300 rounded outline-none" placeholder="-" value="${s1_h2}" onclick="openEventModal('${m.id}', 'h2')" readonly><span class="text-slate-300">:</span><input type="number" class="w-8 h-8 text-center text-sm font-bold bg-white border border-slate-300 rounded outline-none" placeholder="-" value="${s2_h2}" onclick="openEventModal('${m.id}', 'h2')" readonly></div>
                                    <div class="text-center mt-1">${isLive}${pen}</div>
                                </div>
                                <div class="flex flex-col items-center w-[35%]"><img src="${t2.logo||'hvfclogo.png'}" class="w-10 h-10 object-contain mb-1"><span class="text-xs font-bold text-center truncate w-full leading-tight mb-2">${t2.shortName}</span><div class="w-full bg-slate-50 rounded p-1">${renderTeamEvents(evtT2_H1, evtT2_H2)}</div></div>
                            </div>
                            <div class="flex justify-between items-center gap-2 mt-2 pt-2 border-t border-slate-100">
                                <select class="bg-slate-50 border border-slate-200 text-slate-700 text-xs font-bold rounded py-1 px-2 outline-none" onchange="updateM('${m.id}','time',this.value)">${timeOptions}</select>
                                <label class="flex items-center gap-1 text-[9px] font-bold text-slate-400 uppercase cursor-pointer"><input type="checkbox" class="accent-red-600" ${m.isLive?'checked':''} onchange="updateM('${m.id}','isLive',this.checked)"> Live</label>
                            </div>
                        </div>
                        ${actionBtn}
                    </div>
                </div>`;
            } else {
                // VIEW MODE (GIAO DIỆN XEM)
                
                let suspensionAlert = '';
                if (!m.isFullTime && typeof getTeamSuspensions === 'function') {
                    try {
                        const susT1 = getTeamSuspensions(m.t1).suspended;
                        const susT2 = getTeamSuspensions(m.t2).suspended;
                        if (susT1.length || susT2.length) {
                             suspensionAlert = `<div class="mt-2 pt-2 border-t border-dashed border-slate-200 text-[9px] flex flex-wrap gap-2 justify-center">`;
                             if(susT1.length) suspensionAlert += `<span class="text-red-600"><i class="fas fa-ban"></i> ${t1.shortName}: ${susT1.map(p=>p.name).join(', ')}</span>`;
                             if(susT2.length) suspensionAlert += `<span class="text-red-600"><i class="fas fa-ban"></i> ${t2.shortName}: ${susT2.map(p=>p.name).join(', ')}</span>`;
                             suspensionAlert += `</div>`;
                        }
                    } catch(err){}
                }

                let detailScore = m.isFullTime ? `<div class="text-[9px] text-slate-500 mt-1 font-medium bg-slate-100 px-1 rounded inline-block">H1: ${s1_h1||0}-${s2_h1||0} &bull; H2: ${s1_h2||0}-${s2_h2||0}</div>` : '';

                // --- TỰ ĐỘNG GHÉP TÊN SÂN ---
                // Chỉ hiển thị nếu đã nhập mã sân (m.venue)
                let venueDisplay = '';
                if(m.venue) {
                    // Logic ghép chuỗi: "Sân" + [Mã] + " - " + [Địa điểm chung]
                    const locSuffix = tourLocation ? ` - ${tourLocation}` : '';
                    venueDisplay = `<div class="text-[9px] text-slate-500 font-bold mt-1 bg-slate-50 border border-slate-100 rounded px-2 py-0.5 inline-block">
                        <i class="fas fa-map-marker-alt text-red-500 mr-1"></i>
                        Sân ${m.venue}${locSuffix}
                    </div>`;
                }

                c.innerHTML += `
                <div class="app-card flex flex-col ${m.isLive?'border-red-500 border-l-4':''} mb-2 p-0 overflow-hidden relative">
                    <div class="absolute top-0 left-0 bg-slate-200 text-[9px] font-black text-slate-600 px-1.5 py-0.5 rounded-br-lg z-10">#${matchOrder}</div>

                    <div class="flex items-stretch pt-2">
                        <div class="w-12 text-center border-r bg-slate-50 flex flex-col justify-center items-center shrink-0 p-1">
                            <div class="text-xs font-bold text-slate-800">${m.time||'--:--'}</div>
                            <div class="text-[9px] text-slate-500">${m.date?formatDate(m.date).substr(0,5):'--/--'}</div>
                        </div>

                        <div class="flex-1 p-2 min-w-0 flex flex-col justify-center">
                            ${matchNameDisplay}
                            
                            <div class="flex justify-between items-center mb-1">
                                <div class="w-[35%] flex items-center justify-end gap-2">
                                    <div class="text-right min-w-0">
                                        <div class="text-sm font-bold text-slate-700 truncate leading-tight">${t1.shortName}</div>
                                        <div class="mt-1">${m.isFullTime ? renderTeamEvents(evtT1_H1, evtT1_H2) : ''}</div>
                                    </div>
                                    <img src="${t1.logo||'hvfclogo.png'}" class="w-8 h-8 object-contain bg-white rounded-full border border-slate-100 p-0.5 shrink-0 shadow-sm">
                                </div>

                                <div class="w-[30%] flex flex-col items-center">
                                    <span class="bg-slate-100 px-2 py-0.5 rounded text-sm font-black whitespace-nowrap border border-slate-200 tracking-widest text-slate-800">
                                        ${totalS1} - ${totalS2} ${ftBadge}
                                    </span>
                                    ${detailScore}
                                    ${venueDisplay} </div>

                                <div class="w-[35%] flex items-center justify-start gap-2">
                                    <img src="${t2.logo||'hvfclogo.png'}" class="w-8 h-8 object-contain bg-white rounded-full border border-slate-100 p-0.5 shrink-0 shadow-sm">
                                    <div class="text-left min-w-0">
                                        <div class="text-sm font-bold text-slate-700 truncate leading-tight">${t2.shortName}</div>
                                        <div class="mt-1">${m.isFullTime ? renderTeamEvents(evtT2_H1, evtT2_H2) : ''}</div>
                                    </div>
                                </div>
                            </div>

                            <div class="text-center mt-1">${isLive}${pen}</div>
                            ${suspensionAlert}
                        </div>
                    </div>
                </div>`;
            }
        } catch (err) { console.error(err); }
    });
}
function switchResultMode(mode) {
    const editBox = document.getElementById('results-tbody');
    const viewBox = document.getElementById('schedule-list');
    const btnEdit = document.getElementById('btn-res-edit');
    const btnView = document.getElementById('btn-res-view');

    if (mode === 'edit') {
        editBox.classList.remove('hidden');
        viewBox.classList.add('hidden');
        if(btnEdit) { btnEdit.className = "flex-1 py-2 rounded-lg text-xs font-bold bg-white shadow-sm text-blue-600 transition"; }
        if(btnView) { btnView.className = "flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 transition"; }
        renderResultsTable(true);
    } else {
        editBox.classList.add('hidden');
        viewBox.classList.remove('hidden');
        if(btnEdit) { btnEdit.className = "flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 transition"; }
        if(btnView) { btnView.className = "flex-1 py-2 rounded-lg text-xs font-bold bg-white shadow-sm text-blue-600 transition"; }
        renderResultsTable(false);
    }
}
        function updateM(id, k, v) { const m = findM(id); if(m){ m[k]=v; saveToStorage(); if(k==='isLive') renderResultsTable(true); } }
        function findM(id) { const t=appData.tournaments.find(x=>x.id===appData.currentTourId); if(t.format==='knockout') return t.data.matches.find(x=>x.id===id); for(let g of t.data.groups) { const m=g.matches.find(x=>x.id===id); if(m) return m; } if(t.data.knockoutMatches) return t.data.knockoutMatches.find(x=>x.id===id); }

        // --- STATS & BRACKETS (HTML Generation) ---
// --- HÀM THỐNG KÊ (ĐÃ FIX LỖI HIỆN BẢNG VÀNG SỚM) ---
function renderStats(retHtml=false) {
    const t = appData.tournaments.find(x=>x.id===appData.currentTourId);
    if(!t) return '';
    
    let html = '';

    // 1. GOM DỮ LIỆU TOÀN GIẢI
    let allMatches = [];
    if(t.format==='group') { 
        allMatches = t.data.groups.flatMap(g=>g.matches);
        if(t.data.knockoutMatches) allMatches = allMatches.concat(t.data.knockoutMatches);
    } else { 
        allMatches = t.data.matches; 
    }

    // --- BIẾN THỐNG KÊ ---
    let totalGoals = 0, totalYellow = 0, totalRed = 0;
    const scorers = {}; 
    const cards = {}; 
    const hatTricks = []; 
    const pokers = [];
    
    let maxGoalMatch = { match: null, goals: -1 }; 

    allMatches.forEach(m => {
        if (m.isFullTime) {
            // Tìm trận cầu đinh
            if (m.s1 !== null && m.s2 !== null) {
                const sumGoals = parseInt(m.s1) + parseInt(m.s2);
                if (sumGoals > maxGoalMatch.goals) {
                    maxGoalMatch.goals = sumGoals;
                    maxGoalMatch.match = m;
                }
            }

            if (m.events) {
                let matchPlayerGoals = {}; 

                m.events.forEach(e => {
                    const team = getTeam(e.teamId); 
                    if(!team) return;
                    
                    const mem = team.members.find(x => x.name === e.player);
                    const pPhoto = (mem && mem.photo) ? mem.photo : 'https://via.placeholder.com/150?text=IMG';
                    const pNum = mem ? mem.number : 0;
                    
                    const pKey = `${e.player}__${team.id}`;

                    if (e.type === 'goal') {
                        totalGoals++;
                        if (!scorers[pKey]) scorers[pKey] = { name: e.player, number: pNum, teamName: team.shortName, photo: pPhoto, goals: 0 };
                        scorers[pKey].goals++;
                        matchPlayerGoals[pKey] = (matchPlayerGoals[pKey] || 0) + 1;
                    }
                    
                    if (e.type === 'yellow' || e.type === 'red') {
                        if (e.type === 'yellow') totalYellow++; else totalRed++;
                        if (!cards[pKey]) cards[pKey] = { name: e.player, number: pNum, teamName: team.shortName, photo: pPhoto, yellow: 0, red: 0 };
                        if(e.type === 'yellow') cards[pKey].yellow++; else cards[pKey].red++;
                    }
                });

                for (let pKey in matchPlayerGoals) {
                    const count = matchPlayerGoals[pKey];
                    const pInfo = scorers[pKey]; 
                    const record = { name: pInfo.name, number: pInfo.number, team: pInfo.teamName, photo: pInfo.photo, match: `${getTeam(m.t1).shortName} vs ${getTeam(m.t2).shortName}`, count: count };
                    if (count === 3) hatTricks.push(record);
                    if (count >= 4) pokers.push(record);
                }
            }
        }
    });

    const sortedScorers = Object.values(scorers).sort((a,b) => b.goals - a.goals);
    const sortedCards = Object.values(cards).sort((a,b) => b.red - a.red || b.yellow - a.yellow);

    // --- A. BẢNG VÀNG & PODIUM (LOGIC ĐÃ SỬA) ---
    let showPodium = false;
    let knMatches = t.format === 'knockout' ? t.data.matches : (t.data.knockoutMatches || []);
    let championId=null, runnerId=null, thirdIds=[];
    
    if (knMatches.length > 0) {
        const maxR = Math.max(...knMatches.map(m=>m.round));
        const finalMatches = knMatches.filter(m=>m.round===maxR);
        
        // 1. Kiểm tra tất cả các trận hiện có đã đá xong chưa
        const allFinished = finalMatches.every(m=>m.s1!==null && m.s2!==null);
        
        // 2. [QUAN TRỌNG] Kiểm tra xem đây có phải là vòng CHUNG KẾT không?
        // Nếu tên trận hoặc tên vòng có chữ "CHUNG KẾT" hoặc "VÔ ĐỊCH"
        const isFinalRound = finalMatches.some(m => 
            (m.roundLabel && m.roundLabel.toUpperCase().includes('CHUNG KẾT')) ||
            (m.name && (m.name === 'TRANH CÚP VÔ ĐỊCH' || m.name === 'CHUNG KẾT'))
        );

        // Chỉ hiện Podium khi đã đá xong HẾT và là vòng CHUNG KẾT
        showPodium = allFinished && isFinalRound;

        if(showPodium) {
            const final = finalMatches.find(m=>m.name!=='TRANH HẠNG BA') || finalMatches[0];
            const third = finalMatches.find(m=>m.name==='TRANH HẠNG BA');
            if(final) {
                const s1=parseInt(final.s1), s2=parseInt(final.s2), p1=parseInt(final.p1||0), p2=parseInt(final.p2||0);
                if(s1>s2 || (s1==s2 && p1>p2)) { championId=final.t1; runnerId=final.t2; } else { championId=final.t2; runnerId=final.t1; }
            }
            if(third) {
                const s1=parseInt(third.s1), s2=parseInt(third.s2), p1=parseInt(third.p1||0), p2=parseInt(third.p2||0);
                if(s1>s2 || (s1==s2 && p1>p2)) thirdIds.push(third.t1); else thirdIds.push(third.t2);
            }
        }
    } else if (t.format === 'group') {
        const grp = t.data.groups[0];
        // Với đấu bảng (League), chỉ hiện khi tất cả trận đã đá
        showPodium = grp.matches.every(m=>m.s1!==null && m.s2!==null);
        if(showPodium) {
             const s = getSortedGroupStats(grp);
             if(s[0]) championId=s[0].id; if(s[1]) runnerId=s[1].id; if(s[2]) thirdIds.push(s[2].id);
        }
    }

    if (showPodium && championId && typeof generatePodiumHTML === 'function') {
        const isLeague = t.format === 'group' && knMatches.length === 0;
        html += generatePodiumHTML(championId, runnerId, thirdIds, isLeague);
    }

    // --- B. THẺ THỐNG KÊ TỔNG QUAN ---
    html += `
    <div class="grid grid-cols-2 gap-2 mb-4">
        <div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex items-center gap-3">
             <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600 text-lg"><i class="fas fa-futbol"></i></div>
             <div><div class="text-2xl font-black text-slate-800 leading-none">${totalGoals}</div><div class="text-[9px] font-bold text-slate-400 uppercase">Tổng bàn thắng</div></div>
        </div>
        <div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex items-center gap-3">
             <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600 text-lg"><i class="fas fa-square"></i></div>
             <div><div class="text-2xl font-black text-slate-800 leading-none">${totalYellow}</div><div class="text-[9px] font-bold text-slate-400 uppercase">Tổng thẻ vàng</div></div>
        </div>
        <div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex items-center gap-3">
             <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center text-red-600 text-lg"><i class="fas fa-square"></i></div>
             <div><div class="text-2xl font-black text-slate-800 leading-none">${totalRed}</div><div class="text-[9px] font-bold text-slate-400 uppercase">Tổng thẻ đỏ</div></div>
        </div>
        <div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex items-center gap-3">
             <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 text-lg"><i class="fas fa-magic"></i></div>
             <div><div class="text-2xl font-black text-slate-800 leading-none">${hatTricks.length + pokers.length}</div><div class="text-[9px] font-bold text-slate-400 uppercase">Hattrick/Poker</div></div>
        </div>
    </div>`;

    // --- C. TRẬN CẦU ĐINH ---
    if (maxGoalMatch.goals > 0) {
        const m = maxGoalMatch.match;
        const t1 = getTeam(m.t1); const t2 = getTeam(m.t2);
        html += `
        <div class="app-card mb-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white border-none relative overflow-hidden">
            <div class="absolute right-0 top-0 opacity-10 text-6xl p-2"><i class="fas fa-fire"></i></div>
            <div class="relative z-10">
                <div class="text-[10px] font-bold uppercase opacity-80 mb-2"><i class="fas fa-star mr-1 text-yellow-300"></i> Trận đấu nhiều bàn thắng nhất (${maxGoalMatch.goals} bàn)</div>
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2"><img src="${t1.logo}" class="w-8 h-8 rounded bg-white p-0.5"><span class="font-bold text-sm">${t1.shortName}</span></div>
                    <div class="bg-white/20 px-3 py-1 rounded text-xl font-black backdrop-blur-sm">${m.s1} - ${m.s2}</div>
                    <div class="flex items-center gap-2"><span class="font-bold text-sm">${t2.shortName}</span><img src="${t2.logo}" class="w-8 h-8 rounded bg-white p-0.5"></div>
                </div>
                <div class="text-center text-[9px] mt-1 font-bold opacity-75">${m.name || m.roundLabel}</div>
            </div>
        </div>`;
    }

    // --- D. DANH SÁCH HAT-TRICK & POKER ---
    if (hatTricks.length > 0 || pokers.length > 0) {
        html += `<div class="mb-4 space-y-2">`;
        pokers.forEach(p => {
             html += `<div class="bg-white p-2 rounded-lg border border-purple-200 shadow-sm flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img src="${p.photo}" class="w-10 h-10 rounded-full object-cover border border-purple-200">
                    <div>
                        <div class="flex items-center gap-1"><span class="bg-purple-600 text-white text-[9px] font-bold px-1 rounded">POKER</span> <span class="font-bold text-xs text-slate-800">${p.name}</span></div>
                        <div class="text-[9px] text-slate-500">${p.team} (#${p.number})</div>
                    </div>
                </div>
                <div class="text-right"><div class="font-black text-purple-600 text-lg">${p.count}</div><div class="text-[8px] text-slate-400">bàn</div></div>
             </div>`;
        });
        hatTricks.forEach(p => {
             html += `<div class="bg-white p-2 rounded-lg border border-orange-200 shadow-sm flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img src="${p.photo}" class="w-10 h-10 rounded-full object-cover border border-orange-200">
                    <div>
                        <div class="flex items-center gap-1"><span class="bg-orange-500 text-white text-[9px] font-bold px-1 rounded">HAT-TRICK</span> <span class="font-bold text-xs text-slate-800">${p.name}</span></div>
                        <div class="text-[9px] text-slate-500">${p.team} (#${p.number})</div>
                    </div>
                </div>
                <div class="text-right"><div class="font-black text-orange-600 text-lg">${p.count}</div><div class="text-[8px] text-slate-400">bàn</div></div>
             </div>`;
        });
        html += `</div>`;
    }

    // --- E. VUA PHÁ LƯỚI ---
    html += `<div class="app-card p-0 overflow-hidden mb-4 border border-slate-200 shadow-sm">
        <div class="bg-slate-100 px-3 py-2 border-b border-slate-200 flex justify-between items-center"><h4 class="font-bold text-xs text-slate-700 uppercase"><i class="fas fa-futbol mr-1 text-green-600"></i> Vua Phá Lưới</h4></div>
        <div class="max-h-80 overflow-y-auto divide-y divide-slate-50 p-2">`;
    if (sortedScorers.length > 0) {
        sortedScorers.forEach((p, index) => {
            let rankColor = index < 3 ? 'bg-yellow-100 text-yellow-700' : 'bg-slate-50 text-slate-500';
            let photoClass = index < 3 ? 'w-10 h-10 border-2 border-yellow-200' : 'w-8 h-8 border border-slate-100';
            
            html += `<div class="flex items-center justify-between py-2 px-1">
                <div class="flex items-center gap-3">
                    <span class="w-5 h-5 rounded flex items-center justify-center text-[10px] font-bold ${rankColor}">${index + 1}</span>
                    <img src="${p.photo}" class="${photoClass} rounded-full object-cover shadow-sm bg-slate-50">
                    <div>
                        <div class="font-bold text-xs text-slate-700">${p.name}</div>
                        <div class="text-[9px] text-slate-400 font-bold uppercase flex items-center gap-1">
                            ${p.teamName} <span class="px-1 bg-slate-100 rounded text-slate-500">#${p.number}</span>
                        </div>
                    </div>
                </div>
                <div class="font-black text-sm text-blue-600 bg-blue-50 px-2 py-0.5 rounded shadow-sm border border-blue-100">${p.goals}</div>
            </div>`;
        });
    } else { html += `<div class="text-center text-xs text-slate-400 italic py-4">Chưa có bàn thắng.</div>`; }
    html += `</div></div>`;

    // --- F. THẺ PHẠT ---
    html += `<div class="app-card p-0 overflow-hidden mb-4 border border-red-100 shadow-sm">
        <div class="bg-red-50 px-3 py-2 border-b border-red-100 flex justify-between items-center"><h4 class="font-bold text-xs text-red-800 uppercase"><i class="fas fa-exclamation-triangle mr-1"></i> Thẻ Phạt</h4></div>
        <div class="max-h-60 overflow-y-auto divide-y divide-red-50 p-2">`;
    if (sortedCards.length > 0) {
        sortedCards.forEach((p) => {
            let cardsHtml = '';
            if(p.red > 0) cardsHtml += `<span class="flex items-center gap-1 bg-red-100 text-red-700 px-1.5 py-0.5 rounded text-[10px] font-bold ml-1"><i class="fas fa-square text-red-600"></i> ${p.red}</span>`;
            if(p.yellow > 0) cardsHtml += `<span class="flex items-center gap-1 bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded text-[10px] font-bold ml-1"><i class="fas fa-square text-yellow-400"></i> ${p.yellow}</span>`;
            
            html += `<div class="flex items-center justify-between py-2 px-1">
                <div class="flex items-center gap-3">
                    <img src="${p.photo}" class="w-8 h-8 rounded-full border border-slate-200 object-cover bg-slate-50">
                    <div>
                        <div class="font-bold text-xs text-slate-700">${p.name}</div>
                        <div class="text-[9px] text-slate-400 font-bold uppercase">${p.teamName} (#${p.number})</div>
                    </div>
                </div>
                <div class="flex">${cardsHtml}</div>
            </div>`;
        });
    } else { html += `<div class="text-center text-xs text-slate-400 italic py-4">Chưa có thẻ phạt.</div>`; }
    html += `</div></div>`;

    // --- G. BẢNG XẾP HẠNG (GIỮ NGUYÊN) ---
    if(t.format==='group') {
         t.data.groups.forEach((g, gIdx) => {
            const stats = getSortedGroupStats(g);
            const manualSortBtn = `
            <button onclick="openManualRankModal(${gIdx})" class="text-[10px] bg-blue-700 hover:bg-blue-600 text-white px-2 py-1 rounded shadow flex items-center gap-1 border border-blue-500">
                <i class="fas fa-sort"></i> Điều chỉnh
            </button>`;

            html += `
            <div class="app-card overflow-hidden p-0 mb-4 border border-slate-200 shadow-sm mt-4">
                <div class="bg-blue-900 text-white px-3 py-2 text-xs font-bold uppercase flex justify-between items-center">
                    <span>BẢNG XẾP HẠNG ${g.name}</span>
                    ${manualSortBtn}
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs text-center whitespace-nowrap border-collapse">
                        <thead class="bg-slate-100 font-bold text-slate-500 text-[10px] uppercase">
                            <tr class="h-8">
                                <th class="p-2 border-r w-8">#</th>
                                <th class="p-2 text-left sticky left-0 bg-slate-100 z-10 border-r min-w-[100px]">Đội</th>
                                <th class="p-2 border-r bg-slate-50">Tr</th>
                                <th class="p-2 border-r text-green-700">T</th>
                                <th class="p-2 border-r text-slate-400">H</th>
                                <th class="p-2 border-r text-red-600">B</th>
                                <th class="p-2 border-r">BT</th>
                                <th class="p-2 border-r">BB</th>
                                <th class="p-2 border-r font-bold">HS</th>
                                <th class="p-2 border-r text-yellow-600"><i class="fas fa-square"></i></th>
                                <th class="p-2 border-r text-red-600"><i class="fas fa-square"></i></th>
                                <th class="p-2 bg-yellow-200 text-blue-800 font-black sticky right-0 z-10 border-l">Đ</th>
                            </tr>
                        </thead>
                        <tbody>`;
            stats.forEach((s,i) => {
                let rankClass = (i<2) ? 'font-bold' : '';
                html += `<tr class="border-b last:border-0 hover:bg-slate-50 ${rankClass}">
                    <td class="p-2 border-r text-slate-400">${i+1}</td>
                    <td class="p-2 text-left sticky left-0 bg-white z-10 border-r flex items-center gap-2">
                        <img src="${getTeam(s.id).logo||'hvfclogo.png'}" class="w-5 h-5 object-contain">
                        <span class="truncate">${s.name}</span>
                    </td>
                    <td class="p-2 border-r bg-slate-50 font-bold">${s.P}</td>
                    <td class="p-2 border-r text-green-700">${s.W}</td>
                    <td class="p-2 border-r text-slate-400">${s.D}</td>
                    <td class="p-2 border-r text-red-600">${s.L}</td>
                    <td class="p-2 border-r">${s.GF}</td>
                    <td class="p-2 border-r">${s.GA}</td>
                    <td class="p-2 border-r font-bold">${s.GF-s.GA}</td>
                    <td class="p-2 border-r text-yellow-600">${s.Y}</td>
                    <td class="p-2 border-r text-red-600">${s.R}</td>
                    <td class="p-2 font-black text-lg text-blue-800 bg-yellow-100 sticky right-0 z-10 border-l">${s.PTS}</td>
                </tr>`;
            });
            html += `</tbody></table></div></div>`;
        });
    }

    if(retHtml) return html;
    document.getElementById('stats-content').innerHTML = html;
}

// --- HÀM PHỤ TRỢ: TẠO HTML BẢNG VÀNG (Dùng chung cho cả 2 thể thức) ---
function generatePodiumHTML(champId, runnerId, thirdIds, isLeague = false) {
    const c = getTeam(champId); const r = getTeam(runnerId);
    const badgeText = isLeague ? "Vô Địch League" : "Nhà Vô Địch";
    
    return `
    <div class="mb-6 relative">
        <div class="absolute inset-0 bg-gradient-to-b from-yellow-100/50 to-transparent rounded-xl"></div>
        <div class="text-center mb-4 pt-2"><h3 class="font-black text-xl text-yellow-600 uppercase tracking-widest drop-shadow-sm">🏆 Bảng Vàng Thành Tích 🏆</h3></div>
        <div class="flex flex-col items-center mb-4 relative z-10">
            <div class="relative w-24 h-24 mb-2">
                <div class="absolute -inset-4 bg-yellow-400 blur-xl opacity-30 rounded-full animate-pulse"></div>
                <img src="${c.logo||'hvfclogo.png'}" class="w-full h-full object-contain drop-shadow-2xl relative z-10">
                <div class="absolute -top-6 left-1/2 -translate-x-1/2 text-4xl">👑</div>
            </div>
            <div class="bg-gradient-to-r from-yellow-400 to-yellow-600 text-white px-4 py-1 rounded-full text-xs font-black uppercase tracking-wide shadow-lg mb-1">${badgeText}</div>
            <div class="font-black text-xl text-slate-800 uppercase">${c.name}</div>
        </div>
        <div class="grid grid-cols-2 gap-4 px-2 relative z-10">
            <div class="bg-white/80 p-3 rounded-xl border border-slate-200 shadow-sm flex flex-col items-center">
                <div class="text-[10px] font-bold text-slate-400 uppercase mb-1">Á Quân 🥈</div>
                <img src="${r.logo||'hvfclogo.png'}" class="w-12 h-12 object-contain mb-1">
                <div class="font-bold text-xs text-slate-700 text-center leading-tight">${r.name}</div>
            </div>
            <div class="bg-white/80 p-3 rounded-xl border border-orange-100 shadow-sm flex flex-col items-center">
                <div class="text-[10px] font-bold text-orange-400 uppercase mb-1">Hạng 3 🥉</div>
                <div class="flex gap-2 justify-center mb-1">${thirdIds.map(tid => `<img src="${getTeam(tid).logo||'hvfclogo.png'}" class="w-6 h-6 object-contain border rounded-full bg-slate-50">`).join('')}</div>
                <div class="font-bold text-[10px] text-slate-700 text-center leading-tight">${thirdIds.length > 0 ? thirdIds.map(tid => getTeam(tid).shortName).join(' & ') : '---'}</div>
            </div>
        </div>
    </div>`;
}

// --- CẬP NHẬT: TÍNH ĐIỂM FAIRPLAY THEO CẤU HÌNH ---
function calculateGroupStats(g) {
    const stats = {}; 
    const tIds = []; 
    g.matches.forEach(m=>{ if(!tIds.includes(m.t1)) tIds.push(m.t1); if(!tIds.includes(m.t2)) tIds.push(m.t2); });
    
    // 1. LẤY CẤU HÌNH THẺ ĐỎ CỦA GIẢI ĐẤU HIỆN TẠI
    const t = appData.tournaments.find(x => x.id === appData.currentTourId);
    // Mặc định là 3 nếu không tìm thấy cấu hình
    const RED_POINT = (t && t.config && t.config.redCardPoint) ? parseInt(t.config.redCardPoint) : 3;

    tIds.forEach(id => {
        const team = getTeam(id);
        stats[id] = { id, name: team ? team.shortName : '???', P:0, W:0, D:0, L:0, PTS:0, GF:0, GA:0, Y:0, R:0, FPS:0 }; 
    });

    g.matches.forEach(m => {
        if(m.isFullTime && m.s1!==null && m.s2!==null) {
            const t1=stats[m.t1]; const t2=stats[m.t2];
            if(t1 && t2) {
                t1.P++; t2.P++; t1.GF+=m.s1; t2.GF+=m.s2; t1.GA+=m.s2; t2.GA+=m.s1;
                
                if(m.s1 > m.s2) { t1.W++; t1.PTS+=3; t2.L++; } 
                else if(m.s2 > m.s1) { t2.W++; t2.PTS+=3; t1.L++; } 
                else { t1.D++; t1.PTS++; t2.D++; t2.PTS++; }

                // Tính điểm thẻ phạt dựa trên RED_POINT động
                (m.events||[]).forEach(e => { 
                    if(stats[e.teamId]) { 
                        if(e.type==='yellow') {
                            stats[e.teamId].Y++; 
                            stats[e.teamId].FPS += 1; // Vàng luôn là 1
                        }
                        if(e.type==='red') {
                            stats[e.teamId].R++; 
                            stats[e.teamId].FPS += RED_POINT; // Đỏ tính theo cấu hình (2 hoặc 3)
                        }
                    } 
                });
            }
        }
    });
    return Object.values(stats);
}

        // --- BƯỚC 2: HIỂN THỊ SƠ ĐỒ THI ĐẤU (LẤY TÊN VÒNG CHUẨN) ---
function renderBrackets(t) {
     const c = document.getElementById('tour-brackets'); 
     c.innerHTML = '';
     
     let ms = t.format === 'knockout' ? t.data.matches : (t.data.knockoutMatches || []);
     if (ms.length === 0) { 
         c.innerHTML = '<p class="text-center text-xs italic text-slate-400 py-4">Chưa có dữ liệu vòng loại trực tiếp.</p>'; 
         return; 
     }

     const maxR = Math.max(...ms.map(m => m.round));
     
     for (let r = 1; r <= maxR; r++) {
         const roundMs = ms.filter(m => m.round === r);
         if (roundMs.length === 0) continue;

         // Lấy tên vòng đấu từ trận đầu tiên trong vòng đó
         // Nếu không có label thì tự động tính dựa trên số trận: 4 trận -> Tứ kết...
         let roundTitle = roundMs[0].roundLabel;
         if (!roundTitle) {
             if (roundMs.length === 4) roundTitle = "VÒNG TỨ KẾT";
             else if (roundMs.length === 2) roundTitle = "VÒNG BÁN KẾT";
             else if (roundMs.length === 1) roundTitle = "CHUNG KẾT";
             else roundTitle = `VÒNG ${r}`;
         }

         c.innerHTML += `
         <div class="bg-white rounded-xl border border-slate-200 mb-4 overflow-hidden shadow-sm">
             <div class="bg-blue-50 p-2 text-xs font-black text-blue-800 uppercase text-center border-b border-blue-100 tracking-wider">
                 ${roundTitle}
             </div>
             <div class="divide-y divide-slate-100">
                 ${roundMs.map(m => {
                     const t1 = getTeam(m.t1);
                     const t2 = getTeam(m.t2);
                     // Logic hiển thị người thắng đậm hơn
                     const winnerClass1 = (m.s1 > m.s2 || (m.s1==m.s2 && m.p1>m.p2)) ? 'text-slate-800' : 'text-slate-500 font-normal';
                     const winnerClass2 = (m.s2 > m.s1 || (m.s2==m.s1 && m.p2>m.p1)) ? 'text-slate-800' : 'text-slate-500 font-normal';
                     
                     // Hiển thị tên trận (VD: Tứ kết 1) nhỏ bên dưới
                     const matchName = m.name ? `<div class="text-[9px] text-center text-slate-400 uppercase tracking-widest mb-1">${m.name}</div>` : '';

                     return `
                     <div class="p-3">
                         ${matchName}
                         <div class="flex justify-between items-center text-xs">
                             <div class="font-bold w-[40%] text-right truncate ${winnerClass1}">${t1 ? t1.shortName : '???'}</div>
                             
                             <div class="bg-slate-100 px-2 py-1 rounded font-black text-slate-700 mx-2 min-w-[40px] text-center">
                                 ${m.s1 !== null ? m.s1 : '-'}:${m.s2 !== null ? m.s2 : '-'}
                                 ${(m.p1 !== null) ? `<sup class="text-[9px] text-purple-600 ml-0.5">(${m.p1}-${m.p2})</sup>` : ''}
                             </div>
                             
                             <div class="font-bold w-[40%] text-left truncate ${winnerClass2}">${t2 ? t2.shortName : '???'}</div>
                         </div>
                     </div>`;
                 }).join('')}
             </div>
         </div>`;
     }
}
        
// Biến toàn cục lưu hiệp đang chọn
var activeHalfContext = 'h1'; 

function openEventModal(id, half = 'h1') {
    activeEventMatchId = id; 
    activeHalfContext = half;
    
    const m = findM(id);
    const t = appData.tournaments.find(x => x.id === appData.currentTourId);
    let isKnockoutMatch = (t.format === 'knockout') || (t.data.knockoutMatches && t.data.knockoutMatches.find(x => x.id === id));

    const t1 = getTeam(m.t1); 
    const t2 = getTeam(m.t2);
    
    // UI Modal
    document.getElementById('evt-match-title').innerText = `${t1.shortName} vs ${t2.shortName}`;
    document.getElementById('evt-t1-name').innerText = t1.shortName; 
    document.getElementById('evt-t1-logo').src = t1.logo;
    document.getElementById('evt-t2-name').innerText = t2.shortName; 
    document.getElementById('evt-t2-logo').src = t2.logo;
    
    // --- 1. GỌI HÀM CẬP NHẬT DANH SÁCH & LỌC TÊN ---
    if(typeof updatePlayerSelects === 'function') updatePlayerSelects(m);

    // --- 2. HIỂN THỊ CẢNH BÁO TREO GIÒ ---
    // Xóa cảnh báo cũ
    const oldAlert = document.getElementById('suspension-alert');
    if(oldAlert) oldAlert.remove();

    try {
        const susT1 = getSuspendedPlayersForMatch(m.t1, m.id);
        const susT2 = getSuspendedPlayersForMatch(m.t2, m.id);

        if (susT1.length > 0 || susT2.length > 0) {
            const alertDiv = document.createElement('div');
            alertDiv.id = 'suspension-alert';
            alertDiv.className = "bg-red-50 border-l-4 border-red-500 p-3 mb-3 text-xs shadow-sm mx-3 mt-3 rounded-r"; // Thêm margin để không bị dính
            
            let html = '<h4 class="font-bold text-red-700 uppercase mb-1"><i class="fas fa-ban mr-1"></i> TREO GIÒ (Cấm thi đấu):</h4>';
            
            if (susT1.length > 0) html += `<div class="mb-1"><span class="font-bold text-slate-700">${t1.shortName}:</span> <span class="text-red-600 font-bold">${susT1.join(', ')}</span></div>`;
            if (susT2.length > 0) html += `<div><span class="font-bold text-slate-700">${t2.shortName}:</span> <span class="text-red-600 font-bold">${susT2.join(', ')}</span></div>`;
            
            html += '<div class="mt-1 text-[10px] text-slate-400 italic">Hệ thống đã ẩn tên các cầu thủ này khỏi danh sách.</div>';
            alertDiv.innerHTML = html;
            
            // Chèn vào vị trí trên cùng của Modal Body (dưới Header)
            // Tìm container chứa nội dung cuộn
            const scrollContainer = document.querySelector('#modal-event > div:nth-child(2)'); 
            if(scrollContainer) {
                scrollContainer.insertBefore(alertDiv, scrollContainer.firstChild);
            }
        }
    } catch(e) { console.log(e); }

    // --- 3. THANH CHỌN HIỆP ---
    let halfSelector = document.getElementById('evt-half-selector');
    if(!halfSelector) {
        const container = document.querySelector('#modal-event .p-3');
        if(container) {
            halfSelector = document.createElement('div');
            halfSelector.id = 'evt-half-selector';
            halfSelector.className = "flex bg-slate-200 rounded-lg p-1 mb-3";
            halfSelector.innerHTML = `<button onclick="switchHalfContext('h1')" id="btn-half-h1" class="flex-1 py-1.5 text-xs font-bold rounded-md transition-all">Hiệp 1</button><button onclick="switchHalfContext('h2')" id="btn-half-h2" class="flex-1 py-1.5 text-xs font-bold rounded-md transition-all">Hiệp 2</button>`;
            
            // Chèn sau alert (nếu có) hoặc đầu tiên
            const alertEl = document.getElementById('suspension-alert');
            if(alertEl && alertEl.parentNode === container) {
                alertEl.insertAdjacentElement('afterend', halfSelector);
            } else {
                container.insertBefore(halfSelector, container.firstChild);
            }
        }
    }
    
    openMobileModal('modal-event');
    switchHalfContext(activeHalfContext);
    renderEvtListInModal(m, isKnockoutMatch);
}

// --- HÀM CẬP NHẬT DROPDOWN CẦU THỦ (LỌC CẢ TREO GIÒ & THẺ TRONG TRẬN) ---
function updatePlayerSelects(m) {
    const t1 = getTeam(m.t1);
    const t2 = getTeam(m.t2);

    // Lấy danh sách treo giò (TỪ TRẬN KHÁC)
    const suspendedT1 = getSuspendedPlayersForMatch(m.t1, m.id);
    const suspendedT2 = getSuspendedPlayersForMatch(m.t2, m.id);

    const generateOptions = (team, teamId, suspendedList) => {
        return team.members.filter(member => {
            // 1. Chặn treo giò từ quá khứ
            if (suspendedList.includes(member.name)) return false;

            // 2. Chặn thẻ trong trận hiện tại
            let yellow = 0, red = 0;
            if (m.events) {
                m.events.forEach(e => {
                    if (e.teamId === teamId && e.player === member.name) {
                        if (e.type === 'yellow') yellow++;
                        if (e.type === 'red') red++;
                    }
                });
            }
            if (red >= 1 || yellow >= 2) return false; 
            
            return true; 
        }).map(x => `<option value="${x.name}">${x.number}. ${x.name}</option>`).join('');
    };

    const p1Select = document.getElementById('evt-p1-select');
    const p2Select = document.getElementById('evt-p2-select');
    
    // Logic giữ lại giá trị đang chọn nếu chưa bị đuổi
    const currentVal1 = p1Select.value;
    const currentVal2 = p2Select.value;

    p1Select.innerHTML = generateOptions(t1, m.t1, suspendedT1);
    p2Select.innerHTML = generateOptions(t2, m.t2, suspendedT2);
    
    const options1 = Array.from(p1Select.options).map(o => o.value);
    const options2 = Array.from(p2Select.options).map(o => o.value);

    if (currentVal1 && options1.includes(currentVal1)) p1Select.value = currentVal1;
    if (currentVal2 && options2.includes(currentVal2)) p2Select.value = currentVal2;
}

// Hàm chuyển đổi tab Hiệp trong Modal
window.switchHalfContext = function(half) {
    activeHalfContext = half;
    
    // Style nút
    const btn1 = document.getElementById('btn-half-h1');
    const btn2 = document.getElementById('btn-half-h2');
    
    const activeClass = "bg-white text-blue-800 shadow-sm";
    const inactiveClass = "text-slate-500 hover:bg-slate-200"; // Sửa lại logic class
    
    if(half === 'h1') {
        btn1.className = `flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${activeClass}`;
        btn2.className = `flex-1 py-1.5 text-xs font-bold rounded-md transition-all text-slate-500`;
    } else {
        btn1.className = `flex-1 py-1.5 text-xs font-bold rounded-md transition-all text-slate-500`;
        btn2.className = `flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${activeClass}`;
    }
}
        function closeEventModal() { 
    const m = findM(activeEventMatchId);
    let hasWinner = false;
    if (m && m.s1 !== null && m.s2 !== null) {
        hasWinner = (m.s1 !== m.s2) || (m.p1 !== null && m.p2 !== null && m.p1 !== m.p2);
    }
    closeMobileModal('modal-event'); 
    
    // --- LOGIC PHÁO HOA ---
    const t = appData.tournaments.find(x => x.id === appData.currentTourId);
    const isKnockout = t.format === 'knockout';
    const isLeague = t.format === 'group' && t.config.groupCount === 1; // Chỉ 1 bảng
    const hasKnockoutPhase = t.data.knockoutMatches && t.data.knockoutMatches.length > 0;

    if (hasWinner) {
        let triggerFireworks = false;

        // 1. Trường hợp CHUNG KẾT Knock-out
        if (m.name === 'CHUNG KẾT' || m.roundLabel === 'CHUNG KẾT' || m.name === 'TRANH CÚP VÔ ĐỊCH') {
            triggerFireworks = true;
        }
        
        // 2. Trường hợp ĐÁ LEAGUE (Vòng tròn, không knockout)
        // Kiểm tra nếu đây là trận đấu cuối cùng của giải và giải không có Knockout
        else if (isLeague && !hasKnockoutPhase) {
            const allMatches = t.data.groups[0].matches;
            const unfinished = allMatches.filter(match => match.s1 === null || match.s2 === null);
            
            // Nếu không còn trận nào chưa đá (unfinished = 0) -> Kết thúc mùa giải
            if (unfinished.length === 0) {
                triggerFireworks = true;
            }
        }

        if (triggerFireworks) {
            setTimeout(() => { shootFireworks(); }, 500);
            showAppAlert("CHÚC MỪNG", "Đã tìm ra NHÀ VÔ ĐỊCH MÙA GIẢI!", "success");
        } else {
            shootMiniFireworks(); // Trận thường
        }
    }

    renderResultsTable(true); 
    renderStats(); 
    renderActiveTour(); 
}
        // Hàm thêm sự kiện (Ghi nhận hiệp đấu)
function addEvent(type, idx) { 
    const m = findM(activeEventMatchId); 
    if(!m.events) m.events=[]; 
    
    // 1. Lấy thông tin người đang được chọn
    const selectId = `evt-p${idx}-select`;
    const playerSelect = document.getElementById(selectId);
    const pl = playerSelect.value; 
    const tid = idx===1 ? m.t1 : m.t2; 
    
    // Kiểm tra xem có cầu thủ nào được chọn không (đề phòng danh sách rỗng)
    if (!pl) return showAppAlert("Lỗi", "Không có cầu thủ hợp lệ để chọn.", "error");

    // --- CHỐT CHẶN: KIỂM TRA SỐ THẺ TRƯỚC KHI THÊM ---
    // Đếm số thẻ hiện tại của cầu thủ này trong trận
    let currentYellow = 0;
    let currentRed = 0;
    
    m.events.forEach(e => {
        if (e.teamId === tid && e.player === pl) {
            if (e.type === 'yellow') currentYellow++;
            if (e.type === 'red') currentRed++;
        }
    });

    // Logic chặn đứng:
    // - Nếu định thêm Thẻ Vàng: Kiểm tra xem đã có 1 vàng (thêm cái nữa là 2 -> OK) hay đã bị đỏ rồi.
    // - Nếu định thêm Thẻ Đỏ: Kiểm tra xem đã bị thẻ đỏ chưa.
    
    if (type === 'yellow') {
        if (currentRed >= 1) return showAppAlert("Chặn", `Cầu thủ ${pl} đã bị thẻ đỏ, không thể phạt thêm.`, "error");
        if (currentYellow >= 2) return showAppAlert("Chặn", `Cầu thủ ${pl} đã bị 2 thẻ vàng, không thể phạt thêm.`, "error");
    } 
    else if (type === 'red') {
        if (currentRed >= 1) return showAppAlert("Chặn", `Cầu thủ ${pl} đã bị thẻ đỏ rồi.`, "error");
        if (currentYellow >= 2) return showAppAlert("Chặn", `Cầu thủ ${pl} đã bị 2 thẻ vàng (đồng nghĩa thẻ đỏ), không thể phạt thêm.`, "error");
    }
    // ----------------------------------------------------

    // 2. Thêm sự kiện vào data
    m.events.push({ type, player: pl, teamId: tid, half: activeHalfContext }); 
    
    saveToStorage(); 
    
    // 3. Render lại danh sách sự kiện bên dưới
    const t = appData.tournaments.find(x => x.id === appData.currentTourId);
    let isKo = (t.format === 'knockout') || (t.data.knockoutMatches && t.data.knockoutMatches.find(x => x.id === m.id));
    renderEvtListInModal(m, isKo); 
    
    // 4. QUAN TRỌNG: CẬP NHẬT LẠI DANH SÁCH DROPDOWN NGAY LẬP TỨC
    // Hàm này sẽ loại bỏ ngay cầu thủ vừa bị đủ thẻ khỏi danh sách
    updatePlayerSelects(m);
}
// --- BƯỚC 1: HÀM LƯU TỶ SỐ LUÂN LƯU (ĐANG BỊ THIẾU) ---
window.updatePenalty = function() {
    // 1. Tìm trận đấu đang mở
    const m = findM(activeEventMatchId);
    if (!m) return;

    // 2. Lấy giá trị từ ô nhập
    const p1Val = document.getElementById('evt-p1-score').value;
    const p2Val = document.getElementById('evt-p2-score').value;

    // 3. Lưu vào dữ liệu (Nếu xóa trắng thì lưu là null, nếu nhập 0 thì lưu là 0)
    m.p1 = (p1Val === '' || p1Val === null) ? null : parseInt(p1Val);
    m.p2 = (p2Val === '' || p2Val === null) ? null : parseInt(p2Val);

    // 4. Lưu ngay vào bộ nhớ máy
    saveToStorage();
}
// Hàm hiển thị & TÍNH ĐIỂM (Quan trọng)
// --- HÀM renderEvtListInModal ĐÃ TỐI ƯU (GỘP LOGIC H1/H2 VÀ PENALTY) ---
function renderEvtListInModal(m, isKnockoutMatch = false) {
    // 1. Tự động xác định xem có phải trận Knock-out không nếu chưa truyền tham số
    if (arguments.length < 2) {
        const t = appData.tournaments.find(x => x.id === appData.currentTourId);
        if (t.format === 'knockout') isKnockoutMatch = true;
        else if (t.data.knockoutMatches && t.data.knockoutMatches.find(x => x.id === m.id)) isKnockoutMatch = true;
    }

    const l1 = document.getElementById('evt-list-t1');
    const l2 = document.getElementById('evt-list-t2');
    l1.innerHTML = '';
    l2.innerHTML = '';

    // Reset biến đếm điểm tạm thời
    let s1_h1 = 0, s2_h1 = 0, s1_h2 = 0, s2_h2 = 0;
    let s1_total = 0, s2_total = 0;

    (m.events || []).forEach((e, i) => {
        // Tạo nhãn hiển thị H1/H2
        const halfLabel = e.half === 'h1' 
            ? '<span class="text-[9px] bg-slate-100 text-slate-500 px-1 rounded ml-1">H1</span>' 
            : '<span class="text-[9px] bg-slate-100 text-slate-500 px-1 rounded ml-1">H2</span>';

        const h = `<div class="flex justify-between text-xs bg-white p-1 rounded border mb-1 items-center"><div><span>${e.type === 'goal' ? '⚽' : (e.type === 'yellow' ? '🟨' : '🟥')} ${e.player}</span>${halfLabel}</div><button onclick="removeEvent(${i})" class="text-red-500 px-2 font-bold">x</button></div>`;

        if (e.teamId === m.t1) {
            l1.innerHTML += h;
            if (e.type === 'goal') {
                if (e.half === 'h1') s1_h1++; else s1_h2++;
                s1_total++;
            }
        } else {
            l2.innerHTML += h;
            if (e.type === 'goal') {
                if (e.half === 'h1') s2_h1++; else s2_h2++;
                s2_total++;
            }
        }
    });

    // 2. Cập nhật dữ liệu vào object trận đấu (Ưu tiên tính từ events)
    if (m.events && m.events.length > 0) {
        m.s1_h1 = s1_h1; m.s2_h1 = s2_h1;
        m.s1_h2 = s1_h2; m.s2_h2 = s2_h2;
        m.s1 = s1_total; 
        m.s2 = s2_total;
    } else {
        // Trường hợp nhập tay thủ công (không qua events) hoặc chưa có event
        m.s1 = m.s1 || 0;
        m.s2 = m.s2 || 0;
    }

    // Hiển thị điểm tổng lên màn hình Modal
    document.getElementById('evt-t1-score').innerText = m.s1;
    document.getElementById('evt-t2-score').innerText = m.s2;

    // 3. Logic Penalty (Chỉ hiện khi Hòa và là Knock-out)
    const penSection = document.getElementById('penalty-section');
    if (m.s1 === m.s2 && isKnockoutMatch) {
        penSection.classList.remove('hidden');
        document.getElementById('evt-p1-score').value = (m.p1 !== null) ? m.p1 : '';
        document.getElementById('evt-p2-score').value = (m.p2 !== null) ? m.p2 : '';
    } else {
        penSection.classList.add('hidden');
        // Reset Penalty nếu không còn hòa
        m.p1 = null;
        m.p2 = null;
        document.getElementById('evt-p1-score').value = '';
        document.getElementById('evt-p2-score').value = '';
    }

    // 4. Cập nhật lại dropdown cầu thủ ngay lập tức
    if (typeof updatePlayerSelects === 'function') updatePlayerSelects(m);
    
    saveToStorage();
}

// Hàm xóa sự kiện (để bổ trợ cho hàm trên)
window.removeEvent = function(idx) {
    const m = findM(activeEventMatchId);
    if (m && m.events) {
        m.events.splice(idx, 1);
        saveToStorage();
        // Gọi lại hàm render đã tối ưu
        renderEvtListInModal(m); 
    }
}

        // --- NEW FEATURES: ADVANCE & PREPARE ---
        function openAdvanceModal() { updateAdvancePreview(); openMobileModal('modal-advance'); }
        function updateAdvancePreview() {
            const t = appData.tournaments.find(x=>x.id===appData.currentTourId);
            const rule = document.getElementById('advance-rule').value;
            const wc = document.getElementById('advance-wildcard').checked;
            tempQualifiedTeams = []; let pool = [];
            t.data.groups.forEach(g => {
                const s = calculateGroupStats(g).sort((a,b)=>b.PTS-a.PTS || (b.GF-b.GA)-(a.GF-a.GA));
                if(s[0]) tempQualifiedTeams.push({...s[0], grp:g.name, rank:1});
                if(rule==='2' && s[1]) tempQualifiedTeams.push({...s[1], grp:g.name, rank:2});
                else if(s[1]) pool.push({...s[1], grp:g.name, rank:2});
                if(rule==='2' && s[2]) pool.push({...s[2], grp:g.name, rank:3});
            });
            pool.sort((a,b)=>b.PTS-a.PTS || (b.GF-b.GA)-(a.GF-a.GA));
            if(wc && pool.length) tempQualifiedTeams.push({...pool[0], isWC:true});
            
            const c = document.getElementById('advance-preview-list'); c.innerHTML='';
            tempQualifiedTeams.forEach(q => c.innerHTML+=`<div class="p-2 bg-slate-50 border rounded text-xs flex justify-between"><b>${q.name}</b><span class="text-blue-600 font-bold">${q.isWC?'Vé vớt':(q.rank===1?'Nhất '+q.grp:'Nhì '+q.grp)}</span></div>`);
            document.getElementById('advance-suggestion').innerText = `Tổng: ${tempQualifiedTeams.length} đội.`;
        }
        // --- CẬP NHẬT HÀM TẠO LỊCH KNOCKOUT (HỖ TRỢ LIÊN KẾT ĐỘNG) ---
function generateKnockoutFromGroups() {
    const t = appData.tournaments.find(x => x.id === appData.currentTourId);
    if (!t) return;

    // Lấy cấu hình từ modal
    const rule = document.getElementById('advance-rule').value; // 1: Lấy Nhất, 2: Nhất + Nhì
    
    // Kiểm tra số bảng
    const groups = t.data.groups;
    const numGroups = groups.length;
    
    if(numGroups < 2) return showAppAlert('Lỗi', 'Cần ít nhất 2 bảng đấu để tạo chéo.', 'error');

    t.data.knockoutMatches = [];
    t.data.knockoutRound = 1;

    // --- LOGIC TẠO CẶP ĐẤU CHÉO (CROSS MATCHING) ---
    // Logic chuẩn: Nhất bảng này đá Nhì bảng kia
    
    // TRƯỜNG HỢP 1: CHỈ LẤY NHẤT BẢNG (Đá Bán kết hoặc Chung kết luôn)
    if (rule === '1') {
        // Tạo cặp: Nhất A vs Nhất B, Nhất C vs Nhất D...
        for (let i = 0; i < numGroups; i += 2) {
            if (i + 1 < numGroups) {
                const g1 = groups[i].name;     // VD: A
                const g2 = groups[i+1].name;   // VD: B
                
                // Tạo trận đấu với Placeholder Info
                const m = createMatch(
                    null, null, 1, // ID đội tạm thời để null, hàm autoUpdate sẽ điền
                    `Trận ${t.data.knockoutMatches.length + 1}`, 
                    'Vòng Knock-out'
                );
                
                // GẮN MÃ ĐỊNH DANH (QUAN TRỌNG)
                // A_1 nghĩa là Nhất bảng A, B_1 nghĩa là Nhất bảng B
                m.placeholderInfo = { t1: `${g1}_1`, t2: `${g2}_1` };
                
                t.data.knockoutMatches.push(m);
            }
        }
    }
    
    // TRƯỜNG HỢP 2: LẤY NHẤT VÀ NHÌ (Đá chéo)
    else if (rule === '2') {
        // Tạo cặp: Nhất A vs Nhì B, Nhất B vs Nhì A
        for (let i = 0; i < numGroups; i += 2) {
            if (i + 1 < numGroups) {
                const g1 = groups[i].name;     // A
                const g2 = groups[i+1].name;   // B
                
                // Cặp 1: Nhất A vs Nhì B
                const m1 = createMatch(null, null, 1, `Bán kết ${t.data.knockoutMatches.length + 1}`, 'Vòng Bán Kết');
                m1.placeholderInfo = { t1: `${g1}_1`, t2: `${g2}_2` };
                t.data.knockoutMatches.push(m1);

                // Cặp 2: Nhất B vs Nhì A
                const m2 = createMatch(null, null, 1, `Bán kết ${t.data.knockoutMatches.length + 1}`, 'Vòng Bán Kết');
                m2.placeholderInfo = { t1: `${g2}_1`, t2: `${g1}_2` };
                t.data.knockoutMatches.push(m2);
            }
        }
    }

    // Gọi ngay hàm update để điền dữ liệu hiện tại vào
    autoUpdatePlaceholderMatches(t);

    saveToStorage(); 
    closeMobileModal('modal-advance'); 
    loadTour(t.id);
    showAppAlert("Thành công", "Đã tạo lịch thi đấu dự kiến.\nCác cặp đấu sẽ tự động cập nhật theo BXH vòng bảng.", "success");
}

        // --- BƯỚC 1: LOGIC CHUẨN BỊ VÒNG SAU (SỬA LỖI PENALTY & TÌM ĐỘI TRANH HẠNG 3) ---
var isCreatingThirdPlace = false; // Biến cờ để nhớ lựa chọn của bạn

function prepareKnockoutRound() {
    const t = appData.tournaments.find(x => x.id === appData.currentTourId);
    if (!t.data.byes) t.data.byes = {};

    const matches = t.format === 'knockout' ? t.data.matches : (t.data.knockoutMatches || []);
    if (matches.length === 0) return showAppAlert('Thông báo', 'Chưa có dữ liệu vòng đấu loại trực tiếp.', 'info');

    let maxR = Math.max(...matches.map(m => m.round));
    let lastMs = matches.filter(m => m.round === maxR);

    // 1. Kiểm tra trận chưa đá
    const unfinished = lastMs.find(m => m.s1 === null || m.s2 === null);
    if (unfinished) {
        return showAppAlert('Chưa hoàn tất', `Vẫn còn trận chưa có kết quả thi đấu.\nVui lòng cập nhật tỷ số Full-time.`, 'error');
    }

    // 2. Kiểm tra trận hòa thiếu Penalty (FIX LỖI NHẬN DIỆN SỐ 0)
    // Lưu ý: Ta kiểm tra kỹ null và undefined, chấp nhận số 0
    const unresolvedDraw = lastMs.find(m => {
        if (m.s1 != m.s2) return false; // Có thắng thua chính thức -> OK
        // Nếu hòa, bắt buộc p1 và p2 phải là số (khác null/undefined)
        const p1Valid = (m.p1 !== null && m.p1 !== undefined && m.p1 !== '');
        const p2Valid = (m.p2 !== null && m.p2 !== undefined && m.p2 !== '');
        return (!p1Valid || !p2Valid);
    });

    if (unresolvedDraw) {
        const t1 = getTeam(unresolvedDraw.t1).shortName;
        const t2 = getTeam(unresolvedDraw.t2).shortName;
        return showAppAlert('Thiếu Luân Lưu', `Trận ${t1} vs ${t2} đang hòa (${unresolvedDraw.s1}-${unresolvedDraw.s2}).\nHãy cập nhật tỷ số Penalty (Luân lưu) để phân định thắng thua.`, 'error');
    }

    // 3. TÌM ĐỘI THẮNG VÀ ĐỘI THUA (Cho tranh hạng 3)
    let nextRoundCandidates = [];
    tempLosers = []; // Reset danh sách đội thua (biến toàn cục)

    lastMs.forEach(m => {
        let winnerId = null;
        let loserId = null;

        const s1 = parseInt(m.s1); 
        const s2 = parseInt(m.s2);
        
        if (s1 > s2) { winnerId = m.t1; loserId = m.t2; }
        else if (s2 > s1) { winnerId = m.t2; loserId = m.t1; }
        else {
            // Xử lý Penalty
            const p1 = parseInt(m.p1 || 0);
            const p2 = parseInt(m.p2 || 0);
            if (p1 > p2) { winnerId = m.t1; loserId = m.t2; }
            else { winnerId = m.t2; loserId = m.t1; }
        }

        if (winnerId) nextRoundCandidates.push(getTeam(winnerId));
        if (loserId) tempLosers.push(getTeam(loserId));
    });

    // 4. LẤY ĐỘI ĐƯỢC ĐẶC CÁCH (BYE) CỦA VÒNG TRƯỚC (NẾU CÓ)
    if (t.data.byes && t.data.byes[maxR]) {
        t.data.byes[maxR].forEach(tid => {
            const team = getTeam(tid);
            if (team) nextRoundCandidates.push(team);
        });
    }

    // 5. ĐIỀU KIỆN KẾT THÚC GIẢI
    if (nextRoundCandidates.length < 2) {
        shootFireworks(); 
        return showAppAlert('Vinh Danh', `🎉 CHÚC MỪNG NHÀ VÔ ĐỊCH 🎉\n\n🏆 ${nextRoundCandidates[0].name}`, 'success');
    }

    // 6. XỬ LÝ ĐẶC BIỆT: HỎI VỀ TRẬN TRANH HẠNG 3
    // Điều kiện: Vừa đá xong Bán kết (Có 2 đội vào Chung kết và có 2 đội thua)
    if (nextRoundCandidates.length === 2 && tempLosers.length === 2) {
        showAppConfirm(
            "Đã xác định 2 đội vào Chung Kết.\n\nBạn có muốn tạo thêm trận TRANH HẠNG BA cho 2 đội thua ở Bán kết không?", 
            "Có, tạo trận Hạng 3", 
            () => {
                // Người dùng chọn CÓ
                isCreatingThirdPlace = true;
                tempRoundTeams = nextRoundCandidates;
                proceedToGenerate();
            },
        );
        // Hack nhỏ: Sửa nút Hủy của confirm thành nút "Không"
        setTimeout(() => {
            const cancelBtn = document.getElementById('btn-confirm-cancel');
            if(cancelBtn) {
                cancelBtn.innerText = "Không, chỉ đá Chung kết";
                cancelBtn.onclick = () => {
                    closeAppAlert();
                    isCreatingThirdPlace = false;
                    tempRoundTeams = nextRoundCandidates;
                    proceedToGenerate();
                };
            }
        }, 50);
        return;
    }

    // Trường hợp bình thường (Tứ kết, Vòng 1/16...)
    isCreatingThirdPlace = false;
    tempRoundTeams = nextRoundCandidates;
    proceedToGenerate();
}

// Hàm phụ trợ để tiếp tục sau khi hỏi (hoặc không cần hỏi)
function proceedToGenerate() {
    openMobileModal('modal-prepare-round'); 
    renderSortList(); 
    
    // Cập nhật text hướng dẫn
    const msgDiv = document.getElementById('preview-knockout-msg');
    let msg = "";
    
    if (tempRoundTeams.length === 8) msg = "Vòng Tứ Kết: Sẽ có 4 cặp đấu (TK1 - TK4).";
    else if (tempRoundTeams.length === 4) msg = "Vòng Bán Kết: Sẽ có 2 cặp đấu (BK1 - BK2).";
    else if (tempRoundTeams.length === 2) msg = "Trận Chung Kết Tranh Cúp Vô Địch.";
    else if (tempRoundTeams.length % 2 !== 0) msg = "Lẻ đội: Đội cuối cùng sẽ được vào thẳng.";
    else msg = "Đủ cặp thi đấu.";

    if(isCreatingThirdPlace) msg += " (Kèm trận Tranh Hạng 3)";
    
    msgDiv.innerText = msg;
    msgDiv.className = "text-center font-bold text-blue-600 mb-2 text-xs";
}   
        // --- BƯỚC 1: GIAO DIỆN BỐC THĂM (HIỂN THỊ VỊ TRÍ ĐẶC CÁCH RÕ RÀNG) ---
function renderSortList() {
    const c = document.getElementById('sort-team-list'); 
    c.innerHTML = '';
    
    const total = tempRoundTeams.length;
    const isOdd = total % 2 !== 0;

    // Duyệt qua từng cặp (i và i+1)
    for(let i = 0; i < total; i += 2) {
        
        // TRƯỜNG HỢP 1: CÒN ĐỦ CẶP ĐẤU
        if(i + 1 < total) {
            c.innerHTML += `
            <div class="bg-white border border-slate-200 rounded-lg p-2 text-xs flex items-center justify-between mb-2 shadow-sm relative overflow-hidden">
                <div class="absolute left-0 top-0 bottom-0 w-1 bg-blue-500"></div>
                
                <div class="flex-1 flex items-center justify-between gap-2 px-2">
                    <span class="font-bold text-slate-700 w-[40%] truncate text-right">${tempRoundTeams[i].shortName}</span> 
                    <span class="text-red-500 font-black text-[10px] bg-red-50 px-1.5 py-0.5 rounded">VS</span> 
                    <span class="font-bold text-slate-700 w-[40%] truncate text-left">${tempRoundTeams[i+1].shortName}</span> 
                </div>

                <div class="flex flex-col gap-1 ml-1 pl-2 border-l border-slate-100">
                    <button onclick="moveTeam(${i},-1)" class="w-6 h-6 bg-slate-50 hover:bg-blue-100 text-slate-400 hover:text-blue-600 rounded flex items-center justify-center transition"><i class="fas fa-chevron-up"></i></button>
                    <button onclick="moveTeam(${i},1)" class="w-6 h-6 bg-slate-50 hover:bg-blue-100 text-slate-400 hover:text-blue-600 rounded flex items-center justify-center transition"><i class="fas fa-chevron-down"></i></button>
                </div>
            </div>`;
        } 
        
        // TRƯỜNG HỢP 2: ĐỘI LẺ CUỐI CÙNG (ĐƯỢC ĐẶC CÁCH)
        else if (isOdd) {
            c.innerHTML += `
            <div class="mt-4 relative">
                <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-yellow-400 text-yellow-900 text-[9px] font-black uppercase px-2 py-0.5 rounded shadow-sm z-10 tracking-wider">
                    <i class="fas fa-ticket-alt mr-1"></i> Vé Vào Thẳng (Bye)
                </div>
                <div class="bg-gradient-to-r from-yellow-50 to-white border-2 border-yellow-300 border-dashed p-3 rounded-xl flex items-center justify-between shadow-inner">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-yellow-200 text-yellow-700 flex items-center justify-center font-bold text-lg border border-yellow-300 shadow-sm">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div>
                            <div class="text-[10px] text-yellow-600 font-bold uppercase mb-0.5">Đội được chọn:</div>
                            <div class="font-black text-slate-800 text-sm uppercase">${tempRoundTeams[i].name}</div>
                        </div>
                    </div>
                    <div class="flex flex-col gap-1 ml-2 border-l border-yellow-200 pl-2">
                        <button onclick="moveTeam(${i},-1)" class="w-8 h-8 bg-white border border-yellow-200 text-yellow-600 rounded-full shadow-sm hover:scale-110 transition flex items-center justify-center"><i class="fas fa-arrow-up"></i></button>
                    </div>
                </div>
                <div class="text-[9px] text-center text-slate-400 italic mt-1">
                    * Bấm mũi tên lên để đổi đội khác vào vị trí này.
                </div>
            </div>`;
        }
    }
}
        function moveTeam(i,d) { 
             const ni = i+d; if(ni<0||ni>=tempRoundTeams.length) return;
             [tempRoundTeams[i], tempRoundTeams[ni]] = [tempRoundTeams[ni], tempRoundTeams[i]]; renderSortList();
        }
        // --- BƯỚC 2: TẠO LỊCH THI ĐẤU (TỰ ĐỘNG ĐẶT TÊN VÒNG & THÊM HẠNG 3) ---
// --- BƯỚC 2: LOGIC TẠO TRẬN ĐẤU (XỬ LÝ LẺ ĐỘI & ĐÍCH ĐẾN LÀ CHUNG KẾT) ---
function generateKnockoutMatches() {
    const t = appData.tournaments.find(x => x.id === appData.currentTourId);
    
    // 1. Xác định nơi lưu dữ liệu
    const targetMatches = t.format === 'knockout' ? t.data.matches : t.data.knockoutMatches;
    
    // 2. Xác định vòng đấu tiếp theo
    const currentMaxR = targetMatches.length > 0 ? Math.max(...targetMatches.map(m => m.round)) : 0;
    const nextR = currentMaxR + 1;

    if (!t.data.byes) t.data.byes = {};
    t.data.byes[nextR] = []; // Reset danh sách bye vòng này

    // 3. ĐẶT TÊN VÒNG ĐẤU THÔNG MINH
    const count = tempRoundTeams.length; // Tổng số đội tham gia vòng này
    let roundPrefix = "Trận";
    let roundLabel = `VÒNG ${nextR}`;

    if (count === 2) {
        roundPrefix = "";
        roundLabel = "CHUNG KẾT";
    } else if (count === 3 || count === 4) {
        roundPrefix = "Bán kết";
        roundLabel = "VÒNG BÁN KẾT";
    } else if (count >= 5 && count <= 8) {
        roundPrefix = "Tứ kết";
        roundLabel = "VÒNG TỨ KẾT";
    } else if (count > 8 && count <= 16) {
        roundPrefix = "Vòng 1/8";
        roundLabel = "VÒNG 1/8";
    }

    // 4. TẠO CẶP ĐẤU
    let matchCounter = 1;

    for (let i = 0; i < count; i += 2) {
        
        // NẾU CÒN ĐỦ CẶP (Đội i và Đội i+1)
        if (i + 1 < count) {
            let matchName = `${roundPrefix} ${matchCounter}`;
            
            // Xử lý tên đặc biệt cho Chung Kết
            if (count === 2) matchName = "TRANH CÚP VÔ ĐỊCH";

            targetMatches.push(createMatch(
                tempRoundTeams[i].id, 
                tempRoundTeams[i+1].id, 
                nextR, 
                matchName, 
                roundLabel
            ));
            matchCounter++;
        } 
        
        // NẾU LẺ ĐỘI (Đội cuối cùng i) -> VÀO THẲNG
        else {
            const byeTeamId = tempRoundTeams[i].id;
            t.data.byes[nextR].push(byeTeamId);
            
            // Hiển thị thông báo ngay lập tức
            const byeTeam = getTeam(byeTeamId);
            setTimeout(() => {
                showAppAlert("Vé Đặc Cách", `Đội <b>${byeTeam.name}</b> đã được vào thẳng vòng sau!`, "success");
            }, 500);
        }
    }

    // 5. XỬ LÝ TRẬN TRANH HẠNG 3 (Nếu được kích hoạt từ trước)
    // Lưu ý: Chỉ tạo trận hạng 3 khi không có đội lẻ (tức là tempLosers đủ 2 đội)
    if (typeof isCreatingThirdPlace !== 'undefined' && isCreatingThirdPlace && tempLosers.length === 2) {
        targetMatches.push(createMatch(
            tempLosers[0].id,
            tempLosers[1].id,
            nextR,
            "TRANH HẠNG BA",
            roundLabel === "CHUNG KẾT" ? "CHUNG KẾT & HẠNG 3" : roundLabel // Gom nhóm
        ));
    }

    saveToStorage(); 
    closeMobileModal('modal-prepare-round'); 
    loadTour(t.id);
    
    if(count !== 2) {
        showAppAlert("Thành công", `Đã tạo lịch thi đấu ${roundLabel}.`, "success");
    }
}

        // Init
        document.addEventListener('DOMContentLoaded', () => {
             // 1. MỚI: Kiểm tra Session (F5 Refresh) trước
             const sessionRole = sessionStorage.getItem('hvfc_session_role');
             
             if(sessionRole) {
                 // Nếu có session (vừa F5 xong), tự động đăng nhập lại ngay lập tức
                 // Khôi phục credentials từ local nếu là admin để đảm bảo tính nhất quán (tùy chọn)
                 if(sessionRole === 'admin') {
                     document.getElementById('login-user').value = localStorage.getItem('hvfc_u') || 'Lee Nai';
                 }
                 loginSuccess(sessionRole);
             } 
             else {
                 // 2. Nếu không có session (Mở mới tab), kiểm tra "Ghi nhớ đăng nhập"
                 if(localStorage.getItem('hvfc_r')==='true') {
                     document.getElementById('login-user').value = localStorage.getItem('hvfc_u');
                     document.getElementById('login-pass').value = localStorage.getItem('hvfc_p');
                     document.getElementById('remember-me').checked = true;
                 }
             }

             // Enter key login
             document.getElementById('login-pass').addEventListener('keypress', (e)=>{ if(e.key==='Enter') handleLogin('admin'); });
        });
            // --- HÀM PHỤ TRỢ: TẠO DANH SÁCH GIỜ (30 phút/lần) ---
        function getTimeOptionsHTML(selectedTime) {
            let html = '<option value="">--:--</option>';
            // Tạo khung giờ từ 05:00 đến 23:00
            for (let h = 5; h <= 23; h++) {
                for (let m = 0; m < 60; m += 30) {
                    // Định dạng giờ phút (VD: 05:30, 17:00)
                    const hour = h.toString().padStart(2, '0');
                    const min = m.toString().padStart(2, '0');
                    const timeStr = `${hour}:${min}`;
                    
                    // Kiểm tra nếu trùng với giờ đã lưu thì chọn sẵn
                    const isSelected = selectedTime === timeStr ? 'selected' : '';
                    html += `<option value="${timeStr}" ${isSelected}>${timeStr}</option>`;
                }
            }
            return html;
        }
        // --- XÓA THÀNH VIÊN TRONG ĐỘI BÓNG ---
        window.deleteMember = function(index) {
            const t = getTeam(selectedTeamId);
            if (!t || !t.members[index]) return;

            const memName = t.members[index].name;

            // Gọi hộp thoại xác nhận (dùng lại showAppConfirm có sẵn)
            showAppConfirm(
                `Bạn có chắc chắn muốn xóa thành viên: ${memName}?`, 
                "Xóa Ngay", 
                () => {
                    // Logic xóa
                    t.members.splice(index, 1); // Xóa 1 phần tử tại vị trí index
                    saveToStorage();            // Lưu dữ liệu
                    showTeamDetail(selectedTeamId); // Vẽ lại danh sách để cập nhật giao diện
                    
                    showAppAlert("Đã xóa", `Đã xóa ${memName} khỏi đội bóng.`, "success");
                }
            );
        }  
        // --- HIỆU ỨNG PHÁO HOA ---
function shootFireworks() {
    var duration = 3 * 1000; // Kéo dài 3 giây
    var animationEnd = Date.now() + duration;
    var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 9999 };

    var random = function(min, max) { return Math.random() * (max - min) + min; }

    var interval = setInterval(function() {
        var timeLeft = animationEnd - Date.now();

        if (timeLeft <= 0) { return clearInterval(interval); }

        var particleCount = 50 * (timeLeft / duration);
        
        // Bắn từ 2 bên góc màn hình
        confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.1, 0.3), y: Math.random() - 0.2 } }));
        confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.7, 0.9), y: Math.random() - 0.2 } }));
    }, 250);
}

function shootMiniFireworks() {
    confetti({
        particleCount: 100,
        spread: 70,
        origin: { y: 0.6 },
        zIndex: 9999
    });
}   
// --- BƯỚC 2: CẬP NHẬT HÀM CHỐT TRẬN ĐẤU (KIỂM TRA PENALTY) ---
// --- HÀM CHỐT TRẬN ĐẤU (AN TOÀN TUYỆT ĐỐI) ---
function toggleMatchStatus(id) {
    const m = findM(id);
    if (!m) return;
    
    const t = appData.tournaments.find(x => x.id === appData.currentTourId);

    if (!m.isFullTime) {
        // --- KIỂM TRA LOGIC TRẬN HÒA (GIỮ NGUYÊN) ---
        const s1 = m.s1 || 0;
        const s2 = m.s2 || 0;
        let isKnockoutMatch = (t.format === 'knockout');
        if (!isKnockoutMatch && t.data.knockoutMatches) {
            if (t.data.knockoutMatches.find(x => x.id === m.id)) isKnockoutMatch = true;
        }

        if (s1 === s2 && isKnockoutMatch) {
            const hasP1 = (m.p1 !== null && m.p1 !== undefined && m.p1 !== '');
            const hasP2 = (m.p2 !== null && m.p2 !== undefined && m.p2 !== '');

            if (!hasP1 || !hasP2) {
                return showAppAlert("Thiếu kết quả", "Trận đấu đang HÒA. Vui lòng nhập tỉ số Penalty trước khi bấm Hết Giờ.", "error");
            }
        }
        // ---------------------------------------------

        showAppConfirm(
            "Xác nhận trận đấu đã HẾT GIỜ (Full-time)?",
            "Xác Nhận",
            () => {
                // 1. Cập nhật dữ liệu
                if (m.s1 === null || m.s1 === undefined) m.s1 = 0;
                if (m.s2 === null || m.s2 === undefined) m.s2 = 0;
                m.isFullTime = true;
                m.isLive = false;
                if(t) autoUpdatePlaceholderMatches(t); 

                // 2. HIỆN MÀN HÌNH CHẶN (BLOCKING UI)
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'saving-blocker';
                loadingDiv.className = 'fixed inset-0 bg-black/60 z-[10000] flex flex-col items-center justify-center text-white backdrop-blur-sm';
                loadingDiv.innerHTML = '<i class="fas fa-circle-notch fa-spin text-4xl text-blue-500 mb-4"></i><div class="font-bold text-lg">Đang lưu trạng thái... Vui lòng đợi!</div>';
                document.body.appendChild(loadingDiv);

                // 3. GỌI HÀM LƯU VÀ CHỜ (AWAIT)
                saveToStorage()
                .then(() => {
                    // Lưu thành công -> Mới tắt màn hình chặn
                    if(document.getElementById('saving-blocker')) document.getElementById('saving-blocker').remove();
                    
                    renderResultsTable(true);
                    showAppAlert("Thành công", "Trận đấu đã kết thúc và được lưu an toàn.", "success");
                })
                .catch(() => {
                    // Lưu thất bại
                    if(document.getElementById('saving-blocker')) document.getElementById('saving-blocker').remove();
                    m.isFullTime = false; // Hoàn tác nếu lỗi
                    showAppAlert("Lỗi Mạng", "Không thể lưu dữ liệu! Vui lòng kiểm tra đường truyền.", "error");
                });
            }
        );
    } else {
        // MỞ KHÓA (Cũng cần lưu an toàn)
        showAppConfirm(
            "Mở khóa trận đấu để chỉnh sửa?",
            "Mở Khóa",
            () => {
                m.isFullTime = false;
                if(t) autoUpdatePlaceholderMatches(t);
                
                // HIỆN MÀN HÌNH CHẶN
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'fixed inset-0 bg-black/60 z-[10000] flex flex-col items-center justify-center text-white backdrop-blur-sm';
                loadingDiv.innerHTML = '<i class="fas fa-lock-open text-4xl text-yellow-500 mb-4 animate-bounce"></i><div class="font-bold">Đang mở khóa...</div>';
                document.body.appendChild(loadingDiv);

                saveToStorage()
                .then(() => {
                    loadingDiv.remove();
                    renderResultsTable(true);
                });
            }
        );
    }
}
// --- HÀM LOGIC: TÍNH TOÁN DANH SÁCH TREO GIÒ CHO TRẬN KẾ TIẾP ---
function getTeamSuspensions(teamId) {
    const t = appData.tournaments.find(x => x.id === appData.currentTourId);
    if (!t) return { suspended: [], nextMatch: null };

    // 1. Lấy tất cả trận đấu của đội này
    let allMatches = [];
    if (t.format === 'group') {
        allMatches = t.data.groups.flatMap(g => g.matches);
        if (t.data.knockoutMatches) allMatches = allMatches.concat(t.data.knockoutMatches);
    } else {
        allMatches = t.data.matches;
    }

    // Lọc các trận có sự tham gia của teamId
    const teamMatches = allMatches.filter(m => m.t1 === teamId || m.t2 === teamId);
    
    // Sắp xếp theo thời gian/vòng đấu
    teamMatches.sort((a, b) => (a.round || 0) - (b.round || 0) || (a.date || '').localeCompare(b.date || ''));

    // 2. Tìm trận ĐÃ ĐÁ (FullTime) và trận SẮP ĐÁ (Next)
    const playedMatches = teamMatches.filter(m => m.isFullTime);
    const nextMatch = teamMatches.find(m => !m.isFullTime); // Trận chưa đá đầu tiên

    if (!nextMatch) return { suspended: [], nextMatch: null }; // Hết giải hoặc không còn trận nào

    // 3. Tính toán thẻ phạt tích lũy
    const playerStats = {}; // { tenCauThu: { yellow: 0, red: 0, lastRedRound: 0, lastYellowRound: 0 } }

    playedMatches.forEach(m => {
        if (m.events) {
            m.events.forEach(e => {
                if (e.teamId === teamId) {
                    if (!playerStats[e.player]) playerStats[e.player] = { yellow: 0, red: 0, lastMatchId: null };
                    
                    if (e.type === 'yellow') {
                        playerStats[e.player].yellow++;
                        playerStats[e.player].lastMatchId = m.id;
                    }
                    if (e.type === 'red') {
                        playerStats[e.player].red++;
                        playerStats[e.player].lastMatchId = m.id;
                    }
                }
            });
        }
    });

    // 4. Xác định ai bị treo giò ở trận Next
    const suspendedPlayers = [];
    const lastPlayedMatch = playedMatches[playedMatches.length - 1]; // Trận gần nhất vừa đá

    if (lastPlayedMatch) {
        for (let name in playerStats) {
            const s = playerStats[name];
            let reason = null;

            // Điều kiện 1: Bị thẻ đỏ ngay trong trận gần nhất
            // (Giả sử thẻ đỏ nghỉ 1 trận kế tiếp)
            if (s.lastMatchId === lastPlayedMatch.id && 
                lastPlayedMatch.events.some(e => e.player === name && e.type === 'red')) {
                reason = "Thẻ đỏ trực tiếp";
            }
            
            // Điều kiện 2: Tích lũy đủ 2 thẻ vàng (bội số của 2: 2, 4, 6...)
            // Và thẻ vàng thứ 2 (hoặc 4,6) đó phải rơi vào trận gần nhất
            else if (s.yellow > 0 && s.yellow % 2 === 0 && s.lastMatchId === lastPlayedMatch.id) {
                reason = "2 Thẻ vàng tích lũy";
            }

            if (reason) {
                suspendedPlayers.push({ name: name, reason: reason });
            }
        }
    }

    return { suspended: suspendedPlayers, nextMatch: nextMatch };
}
// --- HÀM TÍNH TOÁN DANH SÁCH TREO GIÒ (DÙNG CHUNG) ---
// --- HÀM 1: TÍNH TOÁN DANH SÁCH TREO GIÒ (CORE LOGIC) ---
function getSuspendedPlayersForMatch(teamId, currentMatchId) {
    const t = appData.tournaments.find(x => x.id === appData.currentTourId);
    if (!t) return [];

    let allMatches = [];
    if (t.format === 'group') allMatches = t.data.groups.flatMap(g => g.matches);
    if (t.data.knockoutMatches) allMatches = allMatches.concat(t.data.knockoutMatches);
    if (t.format === 'knockout') allMatches = t.data.matches;

    // Sắp xếp theo thời gian để biết trận nào trước sau
    allMatches.sort((a, b) => (a.round || 0) - (b.round || 0) || (a.date || '').localeCompare(b.date || ''));

    // Tìm vị trí trận hiện tại (nếu đang kiểm tra cho 1 trận cụ thể)
    // Nếu currentMatchId = null (dùng cho trang thống kê), ta xét tất cả trận đã đấu
    const currentIndex = currentMatchId ? allMatches.findIndex(m => m.id === currentMatchId) : allMatches.length;

    const playerState = {}; 

    for (let i = 0; i < currentIndex; i++) {
        const m = allMatches[i];
        if (!m.isFullTime) continue; // Chỉ tính trận đã đá xong

        if (m.t1 === teamId || m.t2 === teamId) {
            // Reset án phạt nếu cầu thủ đã nghỉ trận này (giả lập)
            for (let pl in playerState) {
                if (playerState[pl].isSuspendedNext) {
                    playerState[pl].isSuspendedNext = false; 
                    playerState[pl].yellows = 0; 
                }
            }

            if (m.events) {
                m.events.forEach(e => {
                    if (e.teamId === teamId) {
                        if (!playerState[e.player]) playerState[e.player] = { yellows: 0, isSuspendedNext: false };
                        if (e.type === 'yellow') {
                            playerState[e.player].yellows++;
                            if (playerState[e.player].yellows >= 2) playerState[e.player].isSuspendedNext = true;
                        }
                        if (e.type === 'red') playerState[e.player].isSuspendedNext = true;
                    }
                });
            }
        }
    }

    const suspended = [];
    for (let pl in playerState) {
        if (playerState[pl].isSuspendedNext) suspended.push(pl);
    }
    return suspended;
}
// --- BƯỚC 2: CÁC WIDGET MỚI CHO DASHBOARD ---

// Widget 1: Tìm và hiển thị trận đấu sắp diễn ra nhất
// --- BƯỚC 2: WIDGET TRẬN KẾ TIẾP (CÓ SỐ THỨ TỰ TRẬN) ---
// --- CẬP NHẬT: WIDGET HIỂN THỊ TOÀN BỘ TRẬN ĐẤU CỦA VÒNG HIỆN TẠI ---
function renderNextMatchWidget(t, container) {
    // 1. Gom toàn bộ trận đấu (Vòng bảng + Knockout)
    let allMatches = [];
    if(t.format === 'group') {
        if(t.data.groups) allMatches = t.data.groups.flatMap(g => g.matches.map(m=>({...m, grp:g.name, sortG:g.name, sortR:m.round||0})));
        if(t.data.knockoutMatches) allMatches = allMatches.concat(t.data.knockoutMatches.map(m=>({...m, grp:'Knockout', sortG:'Z', sortR:m.round||999})));
    } else {
        allMatches = t.data.matches.map(m=>({...m, grp:'Knockout', sortG:'A', sortR:m.round}));
    }

    // 2. Tìm "Vòng đấu đang diễn ra" (Active Round)
    // Logic: Tìm số vòng nhỏ nhất mà ở đó vẫn còn trận chưa đá (isFullTime = false)
    
    // Lấy danh sách tất cả các số vòng (Round Numbers) có trong giải, sắp xếp tăng dần
    const distinctRounds = [...new Set(allMatches.map(m => m.round))].sort((a,b) => a - b);
    
    let activeRound = null;
    let roundLabelDisplay = "";

    for (let r of distinctRounds) {
        // Lấy tất cả trận của vòng r
        const matchesInRound = allMatches.filter(m => m.round === r);
        // Kiểm tra xem vòng này đá xong hết chưa
        const isFinished = matchesInRound.every(m => m.isFullTime);
        
        if (!isFinished) {
            activeRound = r;
            // Lấy tên vòng từ trận đầu tiên trong vòng để hiển thị (VD: Vòng 1, Tứ kết...)
            roundLabelDisplay = matchesInRound[0].name || matchesInRound[0].roundLabel || `Vòng ${r}`;
            break; 
        }
    }

    // Nếu không tìm thấy vòng nào (tức là giải đã đá xong hết), thoát
    if (activeRound === null) {
        // Có thể hiện thông báo giải kết thúc hoặc ẩn luôn
        return; 
    }

    // 3. Lọc ra các trận của Vòng đang kích hoạt
    const displayMatches = allMatches.filter(m => m.round === activeRound);

    // Sắp xếp các trận trong vòng này: Trận chưa đá lên đầu, sau đó theo giờ
    displayMatches.sort((a,b) => {
        if (a.isFullTime !== b.isFullTime) return a.isFullTime ? 1 : -1; // Chưa đá lên trước
        return (a.date||'').localeCompare(b.date||'') || (a.time||'').localeCompare(b.time||'');
    });

    // 4. Render giao diện danh sách
    let htmlContent = `
    <div class="mb-6 animate-fade-in">
        <h4 class="font-bold text-slate-500 text-xs uppercase mb-2 pl-1 flex items-center justify-between">
            <span><i class="fas fa-calendar-day mr-1 text-blue-500"></i> LỊCH THI ĐẤU SẮP TỚI</span>
            <span class="bg-blue-600 text-white px-2 py-0.5 rounded text-[10px] font-black shadow-sm">${roundLabelDisplay}</span>
        </h4>
        <div class="space-y-3">`;

    displayMatches.forEach(m => {
        const t1 = getTeam(m.t1);
        const t2 = getTeam(m.t2);
        
        // Bỏ qua nếu là trận chờ (chưa có tên đội)
        if (!t1 || !t2) return;

        // Trạng thái trận đấu
        const isDone = m.isFullTime;
        const statusClass = isDone 
            ? "bg-slate-50 border-slate-200 opacity-80 grayscale-[0.5]" 
            : "bg-white border-blue-200 shadow-md transform hover:scale-[1.01] transition-transform";
        
        const scoreDisplay = isDone 
            ? `<span class="text-lg font-black text-slate-800 bg-slate-200 px-2 rounded">${m.s1} - ${m.s2}</span>`
            : `<span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded border border-blue-100">${m.time || '--:--'}</span>`;

        const dateDisplay = m.date ? formatDate(m.date) : '';
        const venueDisplay = m.venue ? `<span class="text-[9px] bg-slate-100 text-slate-500 px-1 rounded ml-1"><i class="fas fa-map-marker-alt"></i> Sân ${m.venue}</span>` : '';

        htmlContent += `
        <div class="app-card p-3 border rounded-xl relative overflow-hidden ${statusClass}">
            ${isDone ? '<div class="absolute top-0 right-0 bg-slate-200 text-slate-500 text-[9px] font-bold px-1.5 py-0.5 rounded-bl-lg">Đã xong</div>' : ''}
            
            <div class="flex justify-between items-center mb-2">
                <div class="text-[10px] font-bold text-slate-400 uppercase flex items-center">
                    <i class="far fa-calendar mr-1"></i> ${dateDisplay} ${venueDisplay}
                </div>
                ${!isDone ? '<div class="text-[9px] font-bold text-red-500 animate-pulse">Sắp diễn ra</div>' : ''}
            </div>

            <div class="flex items-center justify-between">
                <div class="flex flex-col items-center w-[35%] gap-1">
                    <img src="${t1.logo||'hvfclogo.png'}" class="w-10 h-10 object-contain">
                    <span class="text-xs font-bold text-slate-800 truncate w-full text-center">${t1.shortName}</span>
                </div>

                <div class="flex flex-col items-center w-[30%]">
                    ${scoreDisplay}
                    ${(isDone && m.p1!==null) ? `<div class="text-[9px] text-purple-600 font-bold mt-1">Pen: ${m.p1}-${m.p2}</div>` : ''}
                </div>

                <div class="flex flex-col items-center w-[35%] gap-1">
                    <img src="${t2.logo||'hvfclogo.png'}" class="w-10 h-10 object-contain">
                    <span class="text-xs font-bold text-slate-800 truncate w-full text-center">${t2.shortName}</span>
                </div>
            </div>
            
            ${m.name ? `<div class="mt-2 text-center border-t border-dashed border-slate-100 pt-1 text-[9px] text-slate-400 font-medium uppercase tracking-wide">${m.name}</div>` : ''}
        </div>`;
    });

    htmlContent += `</div></div>`;

    container.innerHTML += htmlContent;
}

// 2. Widget Quét và Cảnh báo Treo giò (UPDATE V3: CÓ ẢNH CẦU THỦ)
    function renderDashboardSuspensions(t, container) {
        let suspensionHTML = '';
        const processedTeams = new Set(); 

        let allMatches = [];
        if(t.format === 'group') {
             if(t.data.groups) allMatches = t.data.groups.flatMap(g => g.matches);
             if(t.data.knockoutMatches) allMatches = allMatches.concat(t.data.knockoutMatches);
        } else {
             allMatches = t.data.matches;
        }
        
        const futureMatches = allMatches.filter(m => !m.isFullTime);

        futureMatches.forEach(m => {
            [m.t1, m.t2].forEach(tid => {
                if (tid && !processedTeams.has(tid)) {
                    try {
                        const suspendedNames = getSuspendedPlayersForMatch(tid, m.id);
                        
                        if (suspendedNames && suspendedNames.length > 0) {
                            const team = getTeam(tid);
                            
                            // Tạo HTML danh sách cầu thủ bị treo (có ảnh)
                            let playersHtml = '';
                            suspendedNames.forEach(pName => {
                                // Tìm thông tin cầu thủ trong team
                                const mem = team.members.find(x => x.name === pName);
                                const photo = (mem && mem.photo) ? mem.photo : 'https://via.placeholder.com/150?text=IMG';
                                
                                playersHtml += `
                                <div class="flex items-center gap-2 bg-white/60 p-1.5 rounded-lg border border-red-100">
                                    <img src="${photo}" class="w-8 h-8 rounded-full object-cover border border-red-200">
                                    <span class="text-[10px] font-bold text-red-700 truncate max-w-[100px]">${pName}</span>
                                </div>`;
                            });

                            suspensionHTML += `
                            <div class="flex flex-col gap-2 bg-red-50 border-l-4 border-red-500 p-3 rounded-r-lg mb-2 shadow-sm">
                                <div class="flex items-center gap-2 mb-1">
                                     <img src="${team.logo||'hvfclogo.png'}" class="w-5 h-5 object-contain">
                                     <div class="text-[11px] font-black text-red-800 uppercase">${team.name}</div>
                                     <div class="ml-auto text-[9px] bg-red-200 text-red-800 px-1.5 rounded font-bold">Vòng tới</div>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    ${playersHtml}
                                </div>
                            </div>`;
                        }
                    } catch(e) { console.log('Lỗi tính thẻ phạt', e); }
                    
                    processedTeams.add(tid);
                }
            });
        });

        if (suspensionHTML) {
            container.innerHTML += `
            <div class="mb-6 animate-pulse-slow">
                <h4 class="font-bold text-red-600 text-xs uppercase mb-2 pl-1 flex items-center">
                    <i class="fas fa-exclamation-triangle mr-1"></i> Án Phạt Treo Giò (Cập nhật)
                </h4>
                <div class="space-y-1">
                    ${suspensionHTML}
                </div>
            </div>`;
        }
    }
// --- LOGIC MỚI: TỰ ĐỘNG CẬP NHẬT TÊN ĐỘI THEO BXH TẠM THỜI ---
// --- LOGIC ROBOT: TỰ ĐỘNG CẬP NHẬT TÊN ĐỘI (PHIÊN BẢN AN TOÀN) ---
// --- LOGIC ROBOT: TỰ ĐỘNG CẬP NHẬT TÊN ĐỘI (ĐÃ FIX: DÙNG BXH ĐIỀU CHỈNH) ---
function autoUpdatePlaceholderMatches(t) {
    try {
        // 1. Kiểm tra điều kiện an toàn
        if (!t || t.format !== 'group' || !t.data.knockoutMatches || t.data.knockoutMatches.length === 0) return;

        // 2. Tính BXH hiện tại (QUAN TRỌNG: Dùng hàm getSortedGroupStats)
        // Hàm này sẽ tự động kiểm tra xem bạn có chỉnh tay (Manual Rank) hay không
        // Nếu có chỉnh tay, nó sẽ trả về danh sách theo thứ tự bạn đã xếp.
        const liveStandings = {};
        if(t.data.groups) {
            t.data.groups.forEach(g => {
                liveStandings[g.name] = getSortedGroupStats(g);
            });
        }

        // 3. Quét và cập nhật Lịch thi đấu knockout
        let hasChange = false;
        t.data.knockoutMatches.forEach(m => {
            // Chỉ cập nhật các trận chưa đá VÀ có liên kết động (placeholderInfo)
            if (!m.isFullTime && m.placeholderInfo) {
                
                // Cập nhật Đội 1 (Ví dụ: A_1 là Nhất bảng A)
                if (m.placeholderInfo.t1) {
                    const parts = m.placeholderInfo.t1.split('_'); 
                    if(parts.length === 2) {
                        const grp = parts[0]; 
                        const rank = parseInt(parts[1]);
                        
                        // Lấy đội bóng đang đứng ở thứ hạng đó (theo liveStandings)
                        if (liveStandings[grp] && liveStandings[grp][rank - 1]) {
                            const newTeamId = liveStandings[grp][rank - 1].id;
                            // Nếu khác đội hiện tại thì mới cập nhật
                            if (m.t1 !== newTeamId) {
                                m.t1 = newTeamId;
                                hasChange = true;
                            }
                        }
                    }
                }

                // Cập nhật Đội 2 (Tương tự)
                if (m.placeholderInfo.t2) {
                    const parts = m.placeholderInfo.t2.split('_');
                    if(parts.length === 2) {
                        const grp = parts[0]; 
                        const rank = parseInt(parts[1]);
                        
                        if (liveStandings[grp] && liveStandings[grp][rank - 1]) {
                            const newTeamId = liveStandings[grp][rank - 1].id;
                            if (m.t2 !== newTeamId) {
                                m.t2 = newTeamId;
                                hasChange = true;
                            }
                        }
                    }
                }
            }
        });

        // 4. Lưu lại nếu có thay đổi
        if (hasChange) {
            saveToStorage();
            console.log("System: Đã tự động cập nhật lịch thi đấu theo BXH mới.");
        }
    } catch (err) {
        // Nếu có lỗi, chỉ log ra console chứ không làm sập App (giữ trang Thống kê an toàn)
        console.error("Lỗi tự động cập nhật lịch:", err);
    }
}
// --- BƯỚC 2: HÀM LẤY BXH (ƯU TIÊN THỨ TỰ THỦ CÔNG NẾU CÓ) ---
// --- LOGIC XẾP HẠNG ĐỘNG (DỰA VÀO CẤU HÌNH NGƯỜI DÙNG) ---
function getSortedGroupStats(group) {
    // 1. Tính thống kê cơ bản (P, W, D, L, GF, GA, FPS...)
    let stats = calculateGroupStats(group);

    // 2. Lấy bộ luật xếp hạng của giải này
    const t = appData.tournaments.find(x => x.id === appData.currentTourId);
    
    // Nếu giải cũ chưa có config rankingRules, dùng mặc định
    const rules = (t && t.config && t.config.rankingRules) ? t.config.rankingRules : DEFAULT_RANKING_RULES;

    // 3. Kiểm tra Thứ tự tùy chỉnh (Manual Rank)
    if (group.customOrder && group.customOrder.length > 0) {
        return stats.sort((a, b) => {
            let idxA = group.customOrder.indexOf(a.id);
            let idxB = group.customOrder.indexOf(b.id);
            if (idxA === -1) idxA = 999;
            if (idxB === -1) idxB = 999;
            return idxA - idxB;
        });
    }

    // 4. Hàm so sánh đệ quy (Recursive Sort)
    const sortTeams = (teamList) => {
        // Chúng ta sẽ dùng hàm sort của JS, nhưng logic so sánh sẽ chạy vòng lặp qua rules
        teamList.sort((a, b) => {
            
            for (let i = 0; i < rules.length; i++) {
                const rule = rules[i];
                let diff = 0;

                switch (rule.id) {
                    case 'pts': // Điểm số
                        diff = b.PTS - a.PTS; // Cao xếp trên
                        break;
                    
                    case 'h2h': // Đối đầu
                        // Logic đối đầu phức tạp: Cần tìm nhóm bằng điểm hiện tại
                        // Tuy nhiên, để đơn giản hóa trong sort(a,b), ta so sánh trực tiếp cặp a-b
                        // Lưu ý: Đối đầu chuẩn cần xét ngữ cảnh nhóm (3-4 đội).
                        // Ở đây ta dùng hàm calculateH2HStats đã viết ở bài trước
                        // Ta cần biết "nhóm hiện tại" là ai. 
                        // *Mẹo*: Trong sort thông thường, rất khó lấy context nhóm. 
                        // Nhưng nếu ta so sánh 2 đội, ta có thể tính H2H của riêng 2 đội đó.
                        
                        // Ở phiên bản này, ta sẽ tính H2H trực tiếp 2 đội (Head-to-Head record)
                        const h2h = calculateH2HStats(a.id, b.id, group.matches, [a.id, b.id]);
                        if (h2h.ptsA !== h2h.ptsB) diff = h2h.ptsB - h2h.ptsA;
                        else if (h2h.gdA !== h2h.gdB) diff = h2h.gdB - h2h.gdA; // Hiệu số đối đầu
                        else if (h2h.gfA !== h2h.gfB) diff = h2h.gfB - h2h.gfA; // Bàn thắng đối đầu
                        break;

                    case 'gd': // Hiệu số toàn giải
                        diff = (b.GF - b.GA) - (a.GF - a.GA); // Cao xếp trên
                        break;

                    case 'gf': // Tổng bàn thắng
                        diff = b.GF - a.GF; // Cao xếp trên
                        break;

                    case 'fps': // Fair Play (Thẻ phạt)
                        // FPS càng thấp càng tốt (ít thẻ càng tốt)
                        // Nên logic ngược lại: a - b
                        diff = a.FPS - b.FPS; 
                        break;
                }

                // Nếu tìm thấy sự khác biệt ở tiêu chí này, trả về kết quả ngay
                if (diff !== 0) return diff;
                
                // Nếu diff == 0, vòng lặp tiếp tục sang tiêu chí tiếp theo (i+1)
            }

            // Nếu bằng nhau tất cả tiêu chí -> So tên (Alphabet)
            return a.name.localeCompare(b.name);
        });

        return teamList;
    };

    return sortTeams(stats);
}
// --- HÀM CÒN THIẾU: TÍNH CHỈ SỐ ĐỐI ĐẦU GIỮA CÁC ĐỘI ---
        function calculateH2HStats(teamAId, teamBId, allMatches, tiedTeamIds) {
            // Hàm này tính toán kết quả đối đầu trực tiếp giữa các đội trong nhóm bằng điểm
            let statsA = { pts: 0, gf: 0, ga: 0 };
            let statsB = { pts: 0, gf: 0, ga: 0 };

            // Nếu không truyền danh sách nhóm bằng điểm, mặc định là so sánh 2 đội A và B
            if (!tiedTeamIds) tiedTeamIds = [teamAId, teamBId];

            allMatches.forEach(m => {
                if (!m.isFullTime) return;

                // Chỉ xét trận đấu mà CẢ 2 ĐỘI đều nằm trong nhóm cần so sánh
                if (tiedTeamIds.includes(m.t1) && tiedTeamIds.includes(m.t2)) {
                    
                    const s1 = parseInt(m.s1);
                    const s2 = parseInt(m.s2);

                    // Tính cho Team A
                    if (m.t1 === teamAId) {
                        statsA.gf += s1; statsA.ga += s2;
                        if (s1 > s2) statsA.pts += 3; else if (s1 === s2) statsA.pts += 1;
                    } else if (m.t2 === teamAId) {
                        statsA.gf += s2; statsA.ga += s1;
                        if (s2 > s1) statsA.pts += 3; else if (s2 === s1) statsA.pts += 1;
                    }

                    // Tính cho Team B
                    if (m.t1 === teamBId) {
                        statsB.gf += s1; statsB.ga += s2;
                        if (s1 > s2) statsB.pts += 3; else if (s1 === s2) statsB.pts += 1;
                    } else if (m.t2 === teamBId) {
                        statsB.gf += s2; statsB.ga += s1;
                        if (s2 > s1) statsB.pts += 3; else if (s2 === s1) statsB.pts += 1;
                    }
                }
            });

            return {
                ptsA: statsA.pts, gdA: statsA.gf - statsA.ga, gfA: statsA.gf,
                ptsB: statsB.pts, gdB: statsB.gf - statsB.ga, gfB: statsB.gf
            };
        }
        // --- BƯỚC 4: LOGIC ĐIỀU CHỈNH THỨ HẠNG THỦ CÔNG ---
        var activeGroupIndex = -1;
        var tempRankList = []; // Lưu danh sách tạm thời

        function openManualRankModal(gIdx) {
            activeGroupIndex = gIdx;
            const t = appData.tournaments.find(x => x.id === appData.currentTourId);
            const g = t.data.groups[gIdx];

            document.getElementById('manual-rank-title').innerText = `Xếp hạng Bảng ${g.name}`;
            
            // Lấy thứ hạng hiện tại (đã sort hoặc chưa)
            tempRankList = getSortedGroupStats(g);
            
            renderManualRankList();
            openMobileModal('modal-manual-rank');
        }

        function renderManualRankList() {
            const c = document.getElementById('manual-rank-list');
            c.innerHTML = '';
            
            tempRankList.forEach((s, i) => {
                c.innerHTML += `
                <div class="flex items-center justify-between bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-800 font-black flex items-center justify-center border border-blue-200 shadow-sm">${i+1}</div>
                        <div>
                            <div class="font-bold text-sm text-slate-800">${s.name}</div>
                            <div class="text-[10px] text-slate-500 font-medium">
                                Điểm: ${s.PTS} | HS: ${s.GF-s.GA} | BT: ${s.GF}
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col gap-1">
                        <button onclick="moveRankItem(${i}, -1)" class="w-8 h-8 rounded-lg bg-slate-50 hover:bg-blue-100 text-slate-400 hover:text-blue-600 transition flex items-center justify-center"><i class="fas fa-chevron-up"></i></button>
                        <button onclick="moveRankItem(${i}, 1)" class="w-8 h-8 rounded-lg bg-slate-50 hover:bg-blue-100 text-slate-400 hover:text-blue-600 transition flex items-center justify-center"><i class="fas fa-chevron-down"></i></button>
                    </div>
                </div>`;
            });
        }

        function moveRankItem(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= tempRankList.length) return;
            
            // Hoán đổi vị trí trong mảng tạm
            [tempRankList[index], tempRankList[newIndex]] = [tempRankList[newIndex], tempRankList[index]];
            renderManualRankList();
        }

        function saveManualRank() {
            const t = appData.tournaments.find(x => x.id === appData.currentTourId);
            const g = t.data.groups[activeGroupIndex];
            
            // Lưu danh sách ID theo thứ tự mới vào customOrder
            g.customOrder = tempRankList.map(s => s.id);
            
            saveToStorage();
            renderStats(); // Vẽ lại bảng xếp hạng
            
            // Nếu có tính năng tự cập nhật vòng sau, gọi luôn
            if (typeof autoUpdatePlaceholderMatches === 'function') autoUpdatePlaceholderMatches(t);
            
            closeManualRankModal();
            showAppAlert("Thành công", "Đã cập nhật thứ tự xếp hạng mới.", "success");
        }

        function resetManualRank() {
            showAppConfirm("Bạn muốn quay về sắp xếp tự động (theo Điểm/Hệ số)?", "Reset", () => {
                const t = appData.tournaments.find(x => x.id === appData.currentTourId);
                const g = t.data.groups[activeGroupIndex];
                
                // Xóa customOrder
                delete g.customOrder;
                
                saveToStorage();
                renderStats();
                if (typeof autoUpdatePlaceholderMatches === 'function') autoUpdatePlaceholderMatches(t);
                closeManualRankModal();
            });
        }

        // --- HÀM UI: HIỂN THỊ CẤU HÌNH XẾP HẠNG ---
        function closeManualRankModal() {
            document.getElementById('modal-manual-rank').classList.remove('open');
        }

        function renderRankingConfig() {
            const c = document.getElementById('ranking-criteria-list');
            c.innerHTML = '';
            
            currentRankingRules.forEach((rule, index) => {
                const upBtn = (index === 0 || rule.locked) ? 
                    `<div class="w-8"></div>` : 
                    `<button onclick="moveRankRule(${index}, -1)" class="w-8 h-8 rounded bg-white border border-slate-200 text-slate-500 hover:text-blue-600"><i class="fas fa-chevron-up"></i></button>`;

                const downBtn = (index === currentRankingRules.length - 1 || rule.locked) ? 
                    `<div class="w-8"></div>` : 
                    `<button onclick="moveRankRule(${index}, 1)" class="w-8 h-8 rounded bg-white border border-slate-200 text-slate-500 hover:text-blue-600"><i class="fas fa-chevron-down"></i></button>`;

                const bgClass = rule.locked ? 'bg-slate-100 text-slate-500' : 'bg-white text-slate-800 border-slate-200 shadow-sm';
                const icon = getRuleIcon(rule.id);

                c.innerHTML += `
                <div class="flex items-center gap-2">
                    <div class="flex-1 flex items-center gap-3 p-2 rounded border ${bgClass}">
                        <div class="w-6 text-center">${index + 1}</div>
                        <div class="font-bold text-xs uppercase flex-1 flex items-center gap-2">
                            ${icon} ${rule.name}
                        </div>
                        ${rule.locked ? '<i class="fas fa-lock text-slate-300 text-xs"></i>' : ''}
                    </div>
                    ${upBtn}
                    ${downBtn}
                </div>`;
            });
        }

        // Các hàm hỗ trợ (Đảm bảo chúng nằm ở đây)
        function getRuleIcon(id) {
            if(id==='pts') return '<i class="fas fa-star text-yellow-500"></i>';
            if(id==='h2h') return '<i class="fas fa-handshake text-blue-500"></i>';
            if(id==='gd') return '<i class="fas fa-balance-scale text-green-500"></i>';
            if(id==='gf') return '<i class="fas fa-futbol text-slate-500"></i>';
            if(id==='fps') return '<i class="fas fa-flag text-red-500"></i>';
            return '';
        }

        function moveRankRule(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= currentRankingRules.length) return;
            if (currentRankingRules[newIndex].locked) return;
            [currentRankingRules[index], currentRankingRules[newIndex]] = [currentRankingRules[newIndex], currentRankingRules[index]];
            renderRankingConfig();
        }
        // --- TÍNH NĂNG MỚI: CHỈNH SỬA THÀNH VIÊN HÀNG LOẠT ---

    // 1. Mở Modal và nạp dữ liệu hiện tại
    function openBulkMemberEdit() {
        const t = getTeam(selectedTeamId);
        if (!t) return;

        const container = document.getElementById('bulk-members-list');
        container.innerHTML = '';

        // Nếu đội chưa có thành viên, tạo sẵn 5 dòng trống cho tiện
        if (!t.members || t.members.length === 0) {
            for (let i = 0; i < 5; i++) addBulkRow();
        } else {
            // Nạp thành viên hiện có
            t.members.forEach(m => addBulkRow(m));
            // Thêm 1 dòng trống ở cuối cho tiện nhập mới
            addBulkRow(); 
        }

        openMobileModal('modal-bulk-members');
    }

    // 2. Hàm tạo một dòng input (Row) - ĐÃ CÓ ẢNH ĐẠI DIỆN
    function addBulkRow(data = null) {
        const container = document.getElementById('bulk-members-list');
        const rowId = 'row-' + Date.now() + Math.random().toString(36).substr(2, 5);
        
        const name = data ? data.name : '';
        const number = data ? data.number : '';
        const role = data ? data.role : 'Cầu thủ';
        // Lấy ảnh cũ hoặc dùng ảnh mặc định
        const photo = (data && data.photo) ? data.photo : 'https://via.placeholder.com/150?text=IMG';

        // HTML của 1 dòng
        const div = document.createElement('div');
        div.className = "flex gap-2 items-center animate-fade-in bulk-row mb-2"; // Thêm mb-2 để thoáng hơn
        div.id = rowId;
        
        div.innerHTML = `
            <div class="w-10 h-10 shrink-0 relative group">
                <img src="${photo}" class="bulk-photo-preview w-10 h-10 rounded-full object-cover border border-slate-200 shadow-sm bg-slate-50" id="img-${rowId}">
                
                <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full z-10" onchange="handleBulkPhotoUpload(this, 'img-${rowId}')">
                
                <div class="absolute bottom-0 right-0 bg-blue-600 text-white text-[8px] w-4 h-4 rounded-full flex items-center justify-center pointer-events-none border border-white">
                    <i class="fas fa-camera"></i>
                </div>
            </div>

            <input type="number" class="bulk-number w-8 h-10 text-center font-bold text-sm bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-blue-500 focus:bg-white p-0" placeholder="#" value="${number}">
            
            <input type="text" class="bulk-name flex-1 h-10 px-2 font-bold text-sm text-slate-700 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-blue-500 focus:bg-white placeholder-slate-300" placeholder="Tên cầu thủ..." value="${name}">
            
            <select class="bulk-role w-20 h-10 px-0 text-[10px] font-bold bg-white border border-slate-200 rounded-lg outline-none focus:border-blue-500 text-center">
                <option value="Cầu thủ" ${role === 'Cầu thủ' ? 'selected' : ''}>Cầu thủ</option>
                <option value="Đội trưởng" ${role === 'Đội trưởng' ? 'selected' : ''}>Đ.Trưởng</option>
                <option value="Đội phó" ${role === 'Đội phó' ? 'selected' : ''}>Đ.Phó</option>
                <option value="Thủ môn 1" ${role === 'Thủ môn 1' ? 'selected' : ''}>TM 1</option>
                <option value="Thủ môn 2" ${role === 'Thủ môn 2' ? 'selected' : ''}>TM 2</option>
                <option value="Săn sóc viên" ${role === 'Săn sóc viên' ? 'selected' : ''}>SS Viên</option>
            </select>

            <button onclick="document.getElementById('${rowId}').remove()" class="w-6 h-10 text-slate-300 hover:text-red-500 transition flex items-center justify-center"><i class="fas fa-times"></i></button>
        `;
        container.appendChild(div);
    }

    // --- HÀM XỬ LÝ UPLOAD ẢNH NHANH CHO TABLE ---
    function handleBulkPhotoUpload(input, imgId) {
        if (input.files && input.files[0]) {
            compressImage(input.files[0], 60, 0.5, function(base64Img) {
                document.getElementById(imgId).src = base64Img;
            });
        }
    }

    // 3. Hàm Lưu toàn bộ danh sách (ĐÃ CÓ LOGIC LƯU ẢNH)
    function saveBulkMembers() {
        const t = getTeam(selectedTeamId);
        if (!t) return;

        const rows = document.querySelectorAll('.bulk-row');
        const newMembers = [];

        rows.forEach(row => {
            const num = row.querySelector('.bulk-number').value.trim();
            const name = row.querySelector('.bulk-name').value.trim();
            const role = row.querySelector('.bulk-role').value;
            
            // Lấy nguồn ảnh từ thẻ img
            const imgEl = row.querySelector('.bulk-photo-preview');
            const imgSrc = imgEl.src;
            
            // Kiểm tra: Nếu là ảnh placeholder mặc định thì không lưu (để null), còn nếu là ảnh thật (base64) thì lưu
            const isDefault = imgSrc.includes('via.placeholder.com') || imgSrc.includes('text=IMG');
            const photoData = isDefault ? null : imgSrc;

            // Chỉ lưu những dòng có Tên
            if (name) {
                newMembers.push({
                    name: name,
                    number: num || '0',
                    role: role,
                    photo: photoData // Lưu dữ liệu ảnh
                });
            }
        });

        // Cập nhật dữ liệu
        t.members = newMembers;
        saveToStorage();
        
        // Vẽ lại giao diện chi tiết đội
        showTeamDetail(selectedTeamId);
        
        // Đóng modal
        closeMobileModal('modal-bulk-members');
        showAppAlert("Thành công", `Đã cập nhật danh sách ${newMembers.length} thành viên.`, "success");
    }
    // --- TÍNH NĂNG: NHẬP EXCEL & TẢI MẪU ---

    // 1. Hàm xử lý đọc file Excel
    function importMembersFromExcel(input) {
        if (!input.files || !input.files[0]) return;

        const file = input.files[0];
        const reader = new FileReader();

        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                // Lấy sheet đầu tiên
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Chuyển đổi sang dạng JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                if (jsonData.length === 0) {
                    return showAppAlert("Lỗi", "File Excel không có dữ liệu!", "error");
                }

                // Xóa danh sách cũ đang hiện trong modal (để nạp mới hoàn toàn)
                // Hoặc bạn có thể bỏ dòng này nếu muốn nạp nối tiếp
                document.getElementById('bulk-members-list').innerHTML = '';

                let count = 0;
                jsonData.forEach(row => {
                    // Logic mapping tên cột linh hoạt (chấp nhận tiếng Việt hoặc tiếng Anh)
                    // Chuyển hết key về chữ thường để so sánh cho dễ
                    const keys = Object.keys(row);
                    const getKey = (kw) => keys.find(k => k.toLowerCase().includes(kw));

                    // Tìm dữ liệu trong dòng
                    const nameKey = getKey('tên') || getKey('name') || getKey('player');
                    const numKey = getKey('số') || getKey('number') || getKey('no');
                    const roleKey = getKey('vị trí') || getKey('role') || getKey('pos');

                    const name = row[nameKey];
                    
                    if (name) {
                        // Xử lý Vai trò (Mapping về chuẩn của App)
                        let roleRaw = row[roleKey] ? String(row[roleKey]).toLowerCase() : '';
                        let finalRole = 'Cầu thủ';
                        if(roleRaw.includes('trưởng') || roleRaw.includes('c')) finalRole = 'Đội trưởng';
                        else if(roleRaw.includes('phó') || roleRaw.includes('vc')) finalRole = 'Đội phó';
                        else if(roleRaw.includes('môn') || roleRaw.includes('gk')) finalRole = 'Thủ môn 1';
                        else if(roleRaw.includes('săn sóc')) finalRole = 'Săn sóc viên';

                        // Gọi hàm thêm dòng có sẵn của bạn
                        addBulkRow({
                            name: String(name),
                            number: row[numKey] || '',
                            role: finalRole,
                            photo: null // Excel không import được ảnh, để null
                        });
                        count++;
                    }
                });

                // Reset input file để chọn lại được file cũ nếu muốn
                input.value = '';
                showAppAlert("Thành công", `Đã nhập được ${count} cầu thủ từ Excel!`, "success");

            } catch (err) {
                console.error(err);
                showAppAlert("Lỗi File", "Không đọc được file Excel. Vui lòng kiểm tra lại định dạng.", "error");
            }
        };

        reader.readAsArrayBuffer(file);
    }

    // 2. Hàm tạo file mẫu cho người dùng tải về
    function downloadExcelTemplate() {
        // Dữ liệu mẫu
        const data = [
            { "Họ và tên": "Nguyễn Văn A", "Số áo": 10, "Vị trí": "Đội trưởng" },
            { "Họ và tên": "Trần Văn B", "Số áo": 7, "Vị trí": "Cầu thủ" },
            { "Họ và tên": "Lê Văn C", "Số áo": 1, "Vị trí": "Thủ môn" }
        ];

        // Tạo Worksheet
        const ws = XLSX.utils.json_to_sheet(data);
        
        // Chỉnh độ rộng cột cho đẹp
        const wscols = [
            {wch: 25}, // Cột Tên
            {wch: 10}, // Cột Số
            {wch: 15}  // Cột Vị trí
        ];
        ws['!cols'] = wscols;

        // Tạo Workbook
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "DanhSachCauThu");

        // Xuất file
        XLSX.writeFile(wb, "Mau_Nhap_Cau_Thu_HVFC.xlsx");
    }
    // --- TÍNH NĂNG MỚI: NHẬP DANH SÁCH ĐỘI BÓNG TỪ EXCEL ---

    // 1. Hàm tạo file mẫu cho Đội bóng
    // 1. Hàm tạo file mẫu Excel TỔNG HỢP (Đội + Cầu thủ)
    // 1. Hàm tạo file mẫu Excel TỔNG HỢP (1 File duy nhất)
    // 1. Hàm tạo file mẫu Excel: MỖI ĐỘI 1 SHEET
    function downloadTeamTemplate() {
        const wb = XLSX.utils.book_new();

        // --- HÀM TẠO DỮ LIỆU CHO 1 SHEET ---
        function createTeamSheetData(teamName, shortName, leader, coach, phone, players) {
            // Phần 1: Thông tin đội bóng (Header) - Dạng Key-Value
            const teamInfo = [
                ["THÔNG TIN ĐỘI BÓNG", ""],
                ["Tên Đội (*)", teamName],
                ["Tên Viết Tắt", shortName],
                ["Trưởng Đoàn", leader],
                ["HLV Trưởng", coach],
                ["SĐT Liên Hệ", phone],
                ["", ""], // Dòng trống ngăn cách
                ["DANH SÁCH CẦU THỦ", "", ""], // Tiêu đề danh sách
                ["STT", "Họ và Tên (*)", "Số Áo", "Vị Trí"] // Header cột cầu thủ
            ];

            // Phần 2: Danh sách cầu thủ
            const playerRows = players.map((p, i) => [i + 1, p.name, p.number, p.role]);

            // Gộp lại
            return teamInfo.concat(playerRows);
        }

        // --- SHEET 1: FC HÒA VANG ---
        const team1Data = createTeamSheetData(
            "FC HÒA VANG", "HVFC", "Nguyễn Văn A", "Trần Văn B", "0905123456",
            [
                {name: "Nguyễn Văn C", number: 10, role: "Đội trưởng"},
                {name: "Lê Văn D", number: 1, role: "Thủ môn 1"},
                {name: "Phạm Văn E", number: 7, role: "Cầu thủ"}
            ]
        );
        const ws1 = XLSX.utils.aoa_to_sheet(team1Data);
        // Chỉnh độ rộng cột cho đẹp
        ws1['!cols'] = [{wch: 20}, {wch: 25}, {wch: 10}, {wch: 15}];
        XLSX.utils.book_append_sheet(wb, ws1, "FC_HOA_VANG");

        // --- SHEET 2: FC SÔNG HÀN ---
        const team2Data = createTeamSheetData(
            "FC SÔNG HÀN", "SHFC", "Lê Văn X", "Phạm Văn Y", "0905999888",
            [
                {name: "Trần Văn Z", number: 9, role: "Cầu thủ"},
                {name: "Hoàng Văn K", number: 20, role: "Cầu thủ"}
            ]
        );
        const ws2 = XLSX.utils.aoa_to_sheet(team2Data);
        ws2['!cols'] = [{wch: 20}, {wch: 25}, {wch: 10}, {wch: 15}];
        XLSX.utils.book_append_sheet(wb, ws2, "FC_SONG_HAN");

        // Xuất file
        XLSX.writeFile(wb, "Mau_Nhap_Da_Sheet_Hieu_Qua.xlsx");
    }

    // 2. Hàm xử lý đọc file và tạo đội
    // 2. Hàm xử lý đọc file Excel TỔNG HỢP (Tạo đội & Add cầu thủ cùng lúc)
    // 2. Hàm xử lý Nhập liệu TỔNG HỢP (Tự động gom nhóm Cầu thủ vào Đội)
    // 2. Hàm xử lý Nhập liệu: MỖI SHEET LÀ 1 ĐỘI
    function importTeamsFromExcel(input) {
        if (!input.files || !input.files[0]) return;
        
        if(currentUser === 'guest') return showAppAlert("Lỗi", "Khách không có quyền nhập liệu!", "error");

        const file = input.files[0];
        const reader = new FileReader();

        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                let countTeams = 0;
                let countPlayers = 0;

                // --- DUYỆT QUA TỪNG SHEET TRONG FILE EXCEL ---
                workbook.SheetNames.forEach(sheetName => {
                    const worksheet = workbook.Sheets[sheetName];
                    // Chuyển Sheet thành mảng các dòng (Array of Arrays) để dễ xử lý vị trí
                    const rows = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                    if (rows.length < 2) return; // Bỏ qua sheet trống

                    // 1. TÌM THÔNG TIN ĐỘI BÓNG (Ở PHẦN TRÊN)
                    // Logic: Tìm các dòng có chứa từ khóa ở cột đầu tiên (Cột A - index 0)
                    let teamInfo = { name: '', short: '', leader: '', coach: '', phone: '' };
                    let playerHeaderRowIndex = -1;

                    for (let i = 0; i < rows.length; i++) {
                        const cellKey = rows[i][0] ? String(rows[i][0]).trim().toLowerCase() : '';
                        const cellVal = rows[i][1] ? String(rows[i][1]).trim() : '';

                        // Mapping thông tin
                        if (cellKey.includes('tên đội')) teamInfo.name = cellVal.toUpperCase();
                        else if (cellKey.includes('viết tắt')) teamInfo.short = cellVal.toUpperCase();
                        else if (cellKey.includes('trưởng đoàn')) teamInfo.leader = cellVal;
                        else if (cellKey.includes('hlv')) teamInfo.coach = cellVal;
                        else if (cellKey.includes('sđt') || cellKey.includes('liên hệ')) teamInfo.phone = cellVal;

                        // Tìm dòng tiêu đề danh sách cầu thủ (Để biết bắt đầu lấy cầu thủ từ đâu)
                        // Dấu hiệu: Cột B (index 1) chứa chữ "Họ và Tên" hoặc "Tên cầu thủ"
                        const cellB = rows[i][1] ? String(rows[i][1]).toLowerCase() : '';
                        if (cellB.includes('họ và tên') || cellB.includes('tên cầu thủ')) {
                            playerHeaderRowIndex = i;
                        }
                    }

                    // Nếu không tìm thấy tên đội, thử lấy tên Sheet làm tên đội
                    if (!teamInfo.name) teamInfo.name = sheetName.toUpperCase();

                    // Nếu vẫn không có tên đội (Sheet trắng), bỏ qua
                    if (!teamInfo.name) return;

                    // Tạo tên viết tắt tự động nếu thiếu
                    if (!teamInfo.short) {
                        teamInfo.short = teamInfo.name.split(' ').map(w => w[0]).join('').toUpperCase().substring(0, 4);
                    }

                    // 2. TẠO ĐỐI TƯỢNG ĐỘI BÓNG
                    const newTeam = {
                        id: generateId(),
                        name: teamInfo.name,
                        shortName: teamInfo.short,
                        leader: teamInfo.leader,
                        coach: teamInfo.coach,
                        phone: teamInfo.phone,
                        logo: 'hvfclogo.png',
                        members: []
                    };

                    // 3. TÌM DANH SÁCH CẦU THỦ (Từ dòng dưới Header trở đi)
                    if (playerHeaderRowIndex !== -1) {
                        for (let i = playerHeaderRowIndex + 1; i < rows.length; i++) {
                            const row = rows[i];
                            // Cấu trúc mong đợi: [0: STT, 1: Tên, 2: Số, 3: Vị trí]
                            // Nhưng ta cần linh hoạt chút, lấy Cột 1 làm Tên
                            
                            const pName = row[1] ? String(row[1]).trim() : '';
                            if (pName) {
                                const pNum = row[2] || '';
                                let pRoleRaw = row[3] ? String(row[3]).toLowerCase() : '';
                                
                                // Chuẩn hóa Vai trò
                                let finalRole = 'Cầu thủ';
                                if(pRoleRaw.includes('trưởng')) finalRole = 'Đội trưởng';
                                else if(pRoleRaw.includes('phó')) finalRole = 'Đội phó';
                                else if(pRoleRaw.includes('môn') || pRoleRaw.includes('gk')) finalRole = 'Thủ môn 1';
                                else if(pRoleRaw.includes('săn sóc')) finalRole = 'Săn sóc viên';

                                newTeam.members.push({
                                    name: pName,
                                    number: pNum,
                                    role: finalRole,
                                    photo: null
                                });
                                countPlayers++;
                            }
                        }
                    }

                    // 4. THÊM VÀO DỮ LIỆU CHUNG
                    appData.teams.push(newTeam);
                    countTeams++;
                });

                if (countTeams > 0) {
                    saveToStorage();
                    renderTeamList();
                    input.value = ''; // Reset input
                    showAppAlert("Thành công", `Đã nhập liệu thành công!\n- ${countTeams} Đội bóng (Từ ${countTeams} Sheets)\n- ${countPlayers} Cầu thủ`, "success");
                } else {
                    showAppAlert("Thông báo", "Không tìm thấy dữ liệu hợp lệ trong file.", "info");
                }

            } catch (err) {
                console.error(err);
                showAppAlert("Lỗi File", "Không đọc được file. Vui lòng tải file mẫu mới để kiểm tra cấu trúc.", "error");
            }
        };
        reader.readAsArrayBuffer(file);
    }
    // --- TÍNH NĂNG MỚI: WIDGET DASHBOARD (TRẬN KẾ TIẾP & TREO GIÒ) ---

    // 1. Widget hiển thị Trận đấu sắp diễn ra nhất
    // 1. Widget hiển thị Trận đấu sắp diễn ra nhất (ĐÃ SỬA: HIỆN TOÀN BỘ VÒNG ĐẤU)
    function renderNextMatchWidget(t, container) {
        // 1. Gom toàn bộ trận đấu (Vòng bảng + Knockout)
        let allMatches = [];
        if(t.format === 'group') {
            if(t.data.groups) allMatches = t.data.groups.flatMap(g => g.matches.map(m=>({...m, grp:g.name, sortG:g.name, sortR:m.round||0})));
            if(t.data.knockoutMatches) allMatches = allMatches.concat(t.data.knockoutMatches.map(m=>({...m, grp:'Knockout', sortG:'Z', sortR:m.round||999})));
        } else {
            allMatches = t.data.matches.map(m=>({...m, grp:'Knockout', sortG:'A', sortR:m.round}));
        }

        // 2. Tìm "Vòng đấu đang diễn ra" (Active Round)
        // Logic: Tìm số vòng nhỏ nhất mà ở đó vẫn còn trận chưa đá (isFullTime = false)
        const distinctRounds = [...new Set(allMatches.map(m => m.round))].sort((a,b) => a - b);
        
        let activeRound = null;
        let roundLabelDisplay = "";

        for (let r of distinctRounds) {
            const matchesInRound = allMatches.filter(m => m.round === r);
            const isFinished = matchesInRound.every(m => m.isFullTime);
            
            if (!isFinished) {
                activeRound = r;
                roundLabelDisplay = matchesInRound[0].name || matchesInRound[0].roundLabel || `Vòng ${r}`;
                break; 
            }
        }

        // Nếu tất cả các vòng đều đá xong (activeRound vẫn null), thì lấy vòng cuối cùng để hiển thị kết quả
        if (activeRound === null && distinctRounds.length > 0) {
             activeRound = distinctRounds[distinctRounds.length - 1];
             const lastMatches = allMatches.filter(m => m.round === activeRound);
             roundLabelDisplay = lastMatches[0].name || lastMatches[0].roundLabel || `Vòng ${activeRound} (Hoàn tất)`;
        }

        if (activeRound === null) return;

        // 3. Lọc ra các trận của Vòng đang kích hoạt
        const displayMatches = allMatches.filter(m => m.round === activeRound);

        // Sắp xếp: Trận chưa đá lên đầu, sau đó theo giờ
        displayMatches.sort((a,b) => {
            if (a.isFullTime !== b.isFullTime) return a.isFullTime ? 1 : -1; 
            return (a.date||'').localeCompare(b.date||'') || (a.time||'').localeCompare(b.time||'');
        });

        // 4. Render giao diện danh sách
        let htmlContent = `
        <div class="mb-6 animate-fade-in">
            <h4 class="font-bold text-slate-500 text-xs uppercase mb-2 pl-1 flex items-center justify-between">
                <span><i class="fas fa-calendar-day mr-1 text-blue-500"></i> LỊCH THI ĐẤU SẮP DIỄN RA</span>
                <span class="bg-blue-600 text-white px-2 py-0.5 rounded text-[10px] font-black shadow-sm">${roundLabelDisplay}</span>
            </h4>
            <div class="space-y-3">`;

        displayMatches.forEach(m => {
            const t1 = getTeam(m.t1);
            const t2 = getTeam(m.t2);
            if (!t1 || !t2) return;

            const isDone = m.isFullTime;
            // Style: Nếu xong rồi thì nền xám, chưa xong thì nền trắng nổi bật
            const statusClass = isDone 
                ? "bg-slate-50 border-slate-200 opacity-90" 
                : "bg-white border-blue-200 shadow-md transform hover:scale-[1.01] transition-transform";
            
            const scoreDisplay = isDone 
                ? `<span class="text-lg font-black text-slate-800 bg-slate-200 px-2 rounded min-w-[60px] text-center block">${m.s1} - ${m.s2}</span>`
                : `<span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded border border-blue-100">${m.time || '--:--'}</span>`;

            const dateDisplay = m.date ? formatDate(m.date) : '';
            const venueDisplay = m.venue ? `<span class="text-[9px] bg-slate-100 text-slate-500 px-1 rounded ml-1"><i class="fas fa-map-marker-alt"></i> Sân ${m.venue}</span>` : '';

            htmlContent += `
            <div class="app-card p-3 border rounded-xl relative overflow-hidden ${statusClass}">
                ${isDone ? '<div class="absolute top-0 right-0 bg-slate-200 text-slate-500 text-[9px] font-bold px-1.5 py-0.5 rounded-bl-lg">Đã xong</div>' : ''}
                
                <div class="flex justify-between items-center mb-2">
                    <div class="text-[10px] font-bold text-slate-400 uppercase flex items-center">
                        <i class="far fa-calendar mr-1"></i> ${dateDisplay} ${venueDisplay}
                    </div>
                    ${!isDone ? '<div class="text-[9px] font-bold text-red-500 animate-pulse">Sắp diễn ra</div>' : ''}
                </div>

                <div class="flex items-center justify-between">
                    <div class="flex flex-col items-center w-[35%] gap-1">
                        <img src="${t1.logo||'hvfclogo.png'}" class="w-10 h-10 object-contain">
                        <span class="text-xs font-bold text-slate-800 truncate w-full text-center">${t1.shortName}</span>
                    </div>

                    <div class="flex flex-col items-center w-[30%] relative z-10">
                        ${scoreDisplay}
                        ${(isDone && m.p1!==null) ? `<div class="text-[9px] text-purple-600 font-bold mt-1">Pen: ${m.p1}-${m.p2}</div>` : ''}
                    </div>

                    <div class="flex flex-col items-center w-[35%] gap-1">
                        <img src="${t2.logo||'hvfclogo.png'}" class="w-10 h-10 object-contain">
                        <span class="text-xs font-bold text-slate-800 truncate w-full text-center">${t2.shortName}</span>
                    </div>
                </div>
                
                ${m.name ? `<div class="mt-2 text-center border-t border-dashed border-slate-200 pt-1 text-[9px] text-slate-400 font-medium uppercase tracking-wide">${m.name}</div>` : ''}
            </div>`;
        });

        htmlContent += `</div></div>`;
        container.innerHTML += htmlContent;
    }

    // 2. Widget Quét và Cảnh báo Treo giò (Suspensions)
    function renderDashboardSuspensions(t, container) {
        let suspensionHTML = '';
        const processedTeams = new Set(); // Tránh lặp lại nếu 1 đội đá nhiều trận tương lai

        // Lấy danh sách trận chưa đá
        let allMatches = [];
        if(t.format === 'group') {
             if(t.data.groups) allMatches = t.data.groups.flatMap(g => g.matches);
             if(t.data.knockoutMatches) allMatches = allMatches.concat(t.data.knockoutMatches);
        } else {
             allMatches = t.data.matches;
        }
        
        const futureMatches = allMatches.filter(m => !m.isFullTime);

        // Duyệt qua các trận tương lai để tìm án phạt
        futureMatches.forEach(m => {
            [m.t1, m.t2].forEach(tid => {
                if (tid && !processedTeams.has(tid)) {
                    // Sử dụng hàm có sẵn getSuspendedPlayersForMatch (đã có trong code cũ)
                    // Lưu ý: Nếu code cũ chưa có hàm này, bạn cần báo để mình cung cấp thêm.
                    // Giả sử hàm getSuspendedPlayersForMatch(teamId, matchId) đã tồn tại:
                    try {
                        const suspendedList = getSuspendedPlayersForMatch(tid, m.id);
                        
                        if (suspendedList && suspendedList.length > 0) {
                            const team = getTeam(tid);
                            suspensionHTML += `
                            <div class="flex items-start gap-3 bg-red-50 border-l-4 border-red-500 p-3 rounded-r-lg mb-2 shadow-sm">
                                <div class="w-8 h-8 rounded-full bg-white border border-red-100 flex items-center justify-center shrink-0 shadow-sm mt-0.5">
                                     <img src="${team.logo||'hvfclogo.png'}" class="w-6 h-6 object-contain">
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-center mb-1">
                                        <div class="text-[11px] font-black text-red-800 uppercase">${team.name}</div>
                                        <div class="text-[9px] bg-red-200 text-red-800 px-1.5 rounded font-bold">Vòng tới</div>
                                    </div>
                                    <div class="text-[11px] text-slate-700 leading-tight">
                                        Cấm thi đấu: <span class="font-bold text-red-600">${suspendedList.join(', ')}</span>
                                    </div>
                                </div>
                            </div>`;
                        }
                    } catch(e) { console.log('Lỗi tính thẻ phạt', e); }
                    
                    processedTeams.add(tid);
                }
            });
        });

        if (suspensionHTML) {
            container.innerHTML += `
            <div class="mb-6 animate-pulse-slow">
                <h4 class="font-bold text-red-600 text-xs uppercase mb-2 pl-1 flex items-center">
                    <i class="fas fa-exclamation-triangle mr-1"></i> Án Phạt Treo Giò (Cập nhật)
                </h4>
                <div class="space-y-1">
                    ${suspensionHTML}
                </div>
            </div>`;
        }
    }
    // --- HÀM HỖ TRỢ: NÉN ẢNH (GIẢM DUNG LƯỢNG TRƯỚC KHI LƯU) ---
    function compressImage(file, maxWidth, quality, callback) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function(event) {
            const img = new Image();
            img.src = event.target.result;
            img.onload = function() {
                // Tạo canvas để vẽ lại ảnh với kích thước nhỏ hơn
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                // Tính toán tỉ lệ để resize
                if (width > maxWidth) {
                    height = Math.round(height * (maxWidth / width));
                    width = maxWidth;
                }

                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // Xuất ra dạng Base64 với chất lượng giảm (image/jpeg)
                // quality: 0.1 -> 1.0 (0.7 là đẹp và nhẹ)
                const dataUrl = canvas.toDataURL('image/jpeg', quality);
                callback(dataUrl);
            }
        }
    }
    </script>
</body>
</html>